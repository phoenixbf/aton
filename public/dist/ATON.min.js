/*! For license information please see ATON.min.js.LICENSE.txt */
(()=>{"use strict";class e extends THREE.Group{constructor(e,t){super(),this.type=t||ATON.NTYPES.SCENE,this.enablePicking(),this.type===ATON.NTYPES.SCENE&&(this._rootG=ATON._rootVisible,this._nodes=ATON.snodes),this.type===ATON.NTYPES.SEM&&(this._rootG=ATON._rootSem,this._nodes=ATON.semnodes),this.type===ATON.NTYPES.UI&&(this._rootG=ATON._rootUI,this._nodes=ATON.uinodes),this.as(e),this.kwords=void 0,this._reqURLs={},this._bCloneOnLoadHit=!0,this._tlist=void 0,this._aniMixers=void 0,this.castShadow=!1,this.receiveShadow=!1,this._bs=new THREE.Sphere,this.autocenter=!1,this.onHover=void 0,this.onLeave=void 0,this.onSelect=void 0}as(e){if(void 0!==e&&e!==ATON.ROOT_NID)return this._nodes[e]=this,this.nid=e,this.name=e,this}setAsRoot(){return this._nodes[ATON.ROOT_NID]=this,this.nid=ATON.ROOT_NID,this}setCloneOnLoadHit(e){return this._bCloneOnLoadHit=e,this}addKeywords(e){let t=e.split(",");void 0===this.kwords&&(this.kwords={});for(let e in t){let o=t[e].trim();o.length>0&&(this.kwords[o]=!0)}for(let t in this.children){let o=this.children[t];void 0!==o.type&&o.addKeywords(e)}return this}hasKeyword(e){if(void 0!==this.kwords)return void 0!==this.kwords[e]}setDescription(e){return this.userData.description=e,this}getDescription(){return this.userData.description}setAudio(e){return this.userData.audio=e,this}getAudio(){return this.userData.audio}hide(){let e=this.visible;return this.visible=!1,ATON.Utils.setPicking(this,this.type,!1),ATON._renderer.shadowMap.enabled&&(ATON._dMainL.shadow.needsUpdate=!0),e&&this.type===ATON.NTYPES.SCENE&&ATON.updateLightProbes(),this}show(){let e=this.visible;return this.visible=!0,ATON.Utils.setPicking(this,this.type,this.bPickable),ATON._renderer.shadowMap.enabled&&void 0!==ATON._dMainL&&void 0!==ATON._dMainL.shadow&&(ATON._dMainL.shadow.needsUpdate=!0),e||this.type!==ATON.NTYPES.SCENE||ATON.updateLightProbes(),this}toggle(e){return void 0===e?this.visible?this.hide():this.show():e?this.show():this.hide()}disablePicking(){return this.bPickable=!1,ATON.Utils.setPicking(this,this.type,this.bPickable),this}enablePicking(){return this.bPickable=!0,ATON.Utils.setPicking(this,this.type,this.bPickable),this}setPickable(e){return e?this.enablePicking():this.disablePicking(),this}setMaterial(e){this.userData.cMat=e,this.traverse(t=>{t.isMesh&&(t.material=e),t.type&&(this.userData.cMat=e)});for(let t in this.children){let o=this.children[t];o.setMaterial&&o.setMaterial(e)}return this}getMaterial(){return this.userData.cMat}setDefaultAndHighlightMaterials(e,t){return this.userData.matSTD=e,this.userData.matHL=t,this}highlight(){return this.userData.matHL&&this.setMaterial(this.userData.matHL),this}restoreDefaultMaterial(){return this.userData.matSTD&&this.setMaterial(this.userData.matSTD),this}setOpacity(e){return this.traverse(t=>{t.isMesh&&(t.material.opacity=e)}),this}setShadowCast(e){return this.castShadow=e,this.traverse(t=>{t.isMesh&&(t.castShadow=e)}),this}setShadowReceive(e){return this.receiveShadow=e,this.traverse(t=>{t.isMesh&&(t.receiveShadow=e)}),this}setEnvMap(e){return this.traverse(t=>{t.isMesh&&(t.material.envMap=e)}),this}assignLightProbe(e){return this.traverse(t=>{t.isMesh&&t.geometry&&ATON.Utils.assignLightProbeToMesh(e,t)}),this}assignLightProbesByProximity(){return 0===ATON._lps.length||this.traverse(e=>{if(e.isMesh&&e.geometry){let t,o,i=new THREE.Vector3;(new THREE.Box3).setFromObject(e).getCenter(i);for(let e in ATON._lps){let r=ATON._lps[e],a=i.distanceToSquared(r.pos);(void 0===t||a<o)&&(o=a,t=r)}t&&ATON.Utils.assignLightProbeToMesh(t,e)}}),this}clearLightProbing(){return this.traverse(e=>{e.isMesh&&e.geometry&&(ATON.Utils.clearLightProbeFromMesh(e),e.material&&(e.material.envMap.dispose(),e.material.needsUpdate=!0))}),this}updateLightProbes=()=>(this.traverse(e=>{if(e.isMesh&&e.geometry){let t=e.userData.LP;void 0!==t&&(t.update(),e.material.envMap=t.getEnvTex(),e.material.needsUpdate=!0)}}),this);duplicate(){let e=this.clone();return e.traverse(e=>{e.isMesh&&(e.material=e.material.clone())}),e}delete(){let e=this.parent;void 0!==e&&void 0!==e.nid&&e.removeChild(this)}removeChild(e){if(void 0!==e)return e.nid,void 0!==e.nid&&(this._nodes[e.nid]=void 0),e.parent=void 0,e.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}),this.remove(e),this}removeChildren(){for(let e=this.children.length-1;e>=0;e--)this.removeChild(this.children[e]);return this}attachTo(e){let t="string"==typeof e?this._nodes[e]:e;return t&&(t.add(this),void 0!==t.userData.cMat&&(this.userData.cMat=t.userData.cMat),void 0!==t.bPickable&&(this.bPickable=t.bPickable)),t}attachToRoot(){return this._rootG.add(this),void 0!==this._rootG.userData.cMat&&(this.userData.cMat=this._rootG.userData.cMat),void 0!==this._rootG.bPickable&&(this.bPickable=this._rootG.bPickable),this._rootG}getBound(){return this.dirtyBound(),this._bs}dirtyBound(){return(new THREE.Box3).setFromObject(this).getBoundingSphere(this._bs),this}autoFit(e,t){if(this.dirtyBound(),e&&(this.position.copy(this._bs.center),this.position.multiplyScalar(-1)),t&&t>0&&this._bs.radius>0){let e=t/this._bs.radius;this.scale.set(e,e,e)}return this}setPosition(e,t,o){return e instanceof THREE.Vector3?this.position.copy(e):this.position.set(e,t,o),this}setScale(e,t,o){return e instanceof THREE.Vector3?this.scale.copy(e):(void 0===t&&(t=e,o=e),this.scale.set(e,t,o)),this}setRotation(e,t,o){return e instanceof THREE.Vector3?this.rotation.copy(e):this.rotation.set(e,t,o),this}orientToCamera(){return this.quaternion.copy(ATON.Nav._qOri),this}orientToLocation(e,t,o){return e instanceof THREE.Vector3?this.lookAt(e):this.lookAt(e,t,o),this}orientToNode(e){return e?(this.orientToLocation(e.position),this):this}setYup(){return this.rotation.set(-1.57079632679,0,0),this}addTransform(e){let t;return"string"==typeof e&&(t=ATON.Utils.parseTransformString(e)),void 0===t||(void 0===this._tlist&&(this._tlist=[]),this._tlist.push(t)),this}load(e,t){if(void 0===e)return this;let o=this;if(o._reqURLs[e]=!0,e=ATON.Utils.resolveCollectionURL(e),ATON.Utils.tryLoadFromService(e,o))return t&&t(),o;let i=ATON.Utils.getFileExtension(e);if("spz"===i||"splat"===i||"ksplat"===i||"sog"===i||e.endsWith("meta.json"))return ATON.GS.realize(),ATON._assetReqNew(e),new SPARK.SplatMesh({url:e,editable:!1,onLoad:i=>{i.quaternion.set(1,0,0,0),o.add(i),ATON._assetReqComplete(e),ATON.GS.visitor(o),t&&t()}}),o;if("json"===i||"dzi"===i)return ATON.MRes.loadTileSetFromURL(e,o),t&&t(),o;if(ATON._resHandler)for(let t in ATON._resHandler)if(ATON._resHandler[t](e,o))return o;if(o._bCloneOnLoadHit&&void 0!==ATON._assetsManager[e])return ATON._assetsManager[e].then(e=>{let i=e.clone();if(ATON.Utils.modelVisitor(o,i),void 0!==o._tlist)for(let e in o._tlist)o._tlist[e].add(i.clone()),o.add(o._tlist[e]);else o.add(i);t&&t()}),o;ATON._assetReqNew(e);let r=new Promise((i,r)=>{ATON._aLoader.load(e,r=>{let a=r.scene||r.scene[0];if(ATON.Utils.modelVisitor(o,a),void 0!==o._tlist)for(let e in o._tlist)o._tlist[e].add(a.clone()),o.add(o._tlist[e]);else o.add(a);ATON.Utils.registerAniMixers(o,r),ATON.CC.extract(r),i(a),console.log("%cModel loaded","color:green"),ATON._assetReqComplete(e),o.type===ATON.NTYPES.SCENE&&(ATON._bqScene=!0),o.type===ATON.NTYPES.SEM&&(ATON._bqSem=!0),o.bPickable&&o.enablePicking(),o.dirtyBound(),t&&t()},void 0,o=>{console.log("%cError loading model "+e+" ("+o+")","color:red"),ATON._assetReqComplete(e),t&&t()})});return o._bCloneOnLoadHit&&(ATON._assetsManager[e]=r),this}exportAs(e){return ATON.Utils.exportNode(this,e),this}setOnHover(e){return this.onHover=e,this}setOnLeave(e){return this.onLeave=e,this}setOnSelect(e){return this.onSelect=e,this}loadCesiumIONAsset(e){return ATON.MRes.loadCesiumIONAsset(e,this),this}loadSketchfabAsset(e){let t=ATON.getAPIToken("sketchfab"),o=this;return null==t&&(console.log("A valid Sketchfab token is required"),t=prompt("Please enter a valid Sketchfab token:"),null==t||""==t)||fetch("https://api.sketchfab.com/v3/models/"+e+"/download",{method:"GET",headers:{Authorization:"Token "+t},mode:"cors"}).then(function(e){return e.json()}).then(function(e){if(ATON.setAPIToken("sketchfab",t),e.glb){let t=e.glb.url;return o.load(t),o}}),this}}const t=e;let o={init:()=>{o.evLocal={},o.evNetwork={},ATON.on=o.on,ATON.fire=o.fire,ATON.fireEvent=o.fire,ATON.clearEventHandlers=o.clearEventHandlers},clearEventHandlers:e=>{o.evLocal[e]=[],o.evNetwork[e]=[]},executeHandlers:(e,t)=>{if(e)for(let o=0;o<e.length;o++){const i=e[o];i&&i(t)}},on:(e,t,i)=>{if(void 0!==t){const i=o.evLocal;void 0===i[e]&&(i[e]=[]),i[e].push(t)}void 0!==i&&ATON.Photon.on(e,i)},fire:(e,t,i)=>{const r=o.evLocal[e];o.executeHandlers(r,t),i&&ATON.Photon.fire(e,t)}};const i=o;let r={init:()=>{r.materials={},r.colors={},r._loader=new THREE.MaterialLoader,r._uSem={time:{type:"float",value:0},tint:{type:"vec4",value:new THREE.Vector4(.2,.2,1,.2)},sel:{type:"vec4",value:new THREE.Vector4(0,0,0,.1)}},r.addDefaults()},getDefVertexShader:()=>"\n        varying vec3 vPositionW;\n        varying vec3 vNormalW;\n        varying vec3 vNormalV;\n        varying vec2 vUv;\n\n        void main(){\n            vUv = uv;\n\n            vPositionW = ( modelMatrix * vec4( position, 1.0 )).xyz;\n            vNormalV   = normalize( vec3( normalMatrix * normal ));\n            vNormalW   = ( modelMatrix * vec4(normal, 0.0 )).xyz;\n\n            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }\n    ",addDefaults:()=>{r.colors.white=new THREE.Color(1,1,1),r.colors.black=new THREE.Color(0,0,0),r.colors.green=new THREE.Color(0,1,0),r.colors.yellow=new THREE.Color(1,1,0),r.colors.red=new THREE.Color(1,0,0),r.colors.blue=new THREE.Color(0,0,1),r.colors.orange=new THREE.Color(1,.5,0),r.colors.defUI=new THREE.Color(.85,1,.95),r.colors.sem=new THREE.Color(0,1,.5),r.colors.darksem=new THREE.Color(0,0,.1),r.materials.fullyTransparent=new THREE.MeshBasicMaterial({transparent:!0,depthWrite:!1,opacity:0}),r.materials.invisible=new THREE.ShaderMaterial({vertexShader:r.getDefVertexShader(),fragmentShader:"\n            varying vec3 vPositionW;\n\t\t    varying vec3 vNormalW;\n            varying vec3 vNormalV;\n\n\t\t    void main(){\n                gl_FragColor = vec4(0,0,0,0);\n                discard;\n            }\n        "}),r.materials.defUI=new THREE.ShaderMaterial({uniforms:{tint:{type:"vec3",value:r.colors.defUI},opacity:{type:"float",value:0}},vertexShader:r.getDefVertexShader(),fragmentShader:"\n            varying vec3 vPositionW;\n\t\t    varying vec3 vNormalW;\n            varying vec3 vNormalV;\n            uniform vec3 tint;\n            //uniform vec3 base;\n            uniform float opacity;\n\n\t\t    void main(){\n\t\t        //vec3 viewDirectionW = normalize(cameraPosition - vPositionW);\n\n                float f;\n\t\t        //f = dot(vNormalV, viewDirectionW);\n                f = dot(vNormalV, vec3(0,0,1));\n\t\t        f = clamp(1.0-f, 0.0, 1.0);\n                f *= f;\n\n                f = mix(opacity, 1.0 + opacity, f);\n                f = clamp(f, 0.0,1.0);\n\n                //vec3 col = mix(base,tint, f);\n\t\t        //gl_FragColor = vec4(col, f * opacity);\n\n                gl_FragColor = vec4(tint, f);\n\t\t    }\n        ",transparent:!0,depthWrite:!1}),r.materials.selector=r.materials.defUI.clone(),r.materials.outline=new THREE.MeshBasicMaterial({color:r.colors.black,side:THREE.BackSide,transparent:!0,depthWrite:!1,opacity:.2}),r.materials.controllerRay=r.materials.defUI.clone(),r.materials.controllerRay.uniforms.tint.value=r.colors.white,r.materials.xray=r.materials.defUI.clone(),r.materials.xray.uniforms.tint.value=r.colors.white,r.materials.xray.uniforms.opacity.value=.5,r.materials.teleportLoc=new THREE.MeshBasicMaterial({transparent:!0,opacity:1,depthWrite:!1,side:THREE.DoubleSide}),ATON.Utils.textureLoader.load(ATON.PATH_RES+"grad.png",e=>{r.materials.teleportLoc.map=e}),r.materials.measurement=new THREE.MeshBasicMaterial({color:r.colors.white,transparent:!0,depthWrite:!1,opacity:.5,depthTest:!1}),r.materials.semanticShape=new THREE.ShaderMaterial({uniforms:r._uSem,vertexShader:r.getDefVertexShader(),fragmentShader:"\n            varying vec3 vPositionW;\n\t\t    varying vec3 vNormalW;\n            varying vec3 vNormalV;\n\n            uniform float time;\n            uniform vec4 tint;\n\n\t\t    void main(){\n\t\t        //vec3 viewDirectionW = normalize(cameraPosition - vPositionW);\n\n                //float ff = dot(vNormalV, vec3(0,0,1));\n\t\t        //ff = clamp(1.0-ff, 0.0, 1.0);\n\n                float f = (1.0 * cos(time*2.0)); // - 0.5;\n                //f = cos(time + (vPositionW.y*10.0));\n                f = clamp(f, 0.0,1.0);\n\n\t\t        gl_FragColor = vec4(tint.rgb, tint.a * f);\n                //gl_FragColor = vec4(tint.rgb, ff);\n\t\t    }\n        ",transparent:!0,depthWrite:!1}),r.materials.semanticShapeHL=new THREE.MeshBasicMaterial({color:r.colors.sem,transparent:!0,depthWrite:!1,opacity:.2}),r.materials.semanticShapeEdit=new THREE.MeshBasicMaterial({color:r.colors.orange,transparent:!0,depthWrite:!1,opacity:.5}),r.materials.transWhite=new THREE.MeshBasicMaterial({color:r.colors.white,transparent:!0,depthWrite:!1,side:THREE.DoubleSide,opacity:.2}),r.materials.transBlack=new THREE.MeshBasicMaterial({color:r.colors.black,transparent:!0,depthWrite:!1,side:THREE.DoubleSide,opacity:.2}),r.materials.wireframe=new THREE.MeshBasicMaterial({color:r.colors.black,transparent:!0,depthWrite:!1,opacity:.1,wireframe:!0}),r.materials.normSlope=new THREE.ShaderMaterial({vertexShader:r.getDefVertexShader(),fragmentShader:"\n            varying vec3 vPositionW;\n\t\t    varying vec3 vNormalW;\n\n\t\t    void main(){\n                vec4 A = vec4(0,1,0, 1.0);\n                vec4 B = vec4(1,0,0, 1.0);\n\n                float f;\n                f = dot(vNormalW, vec3(0,1,0));\n\n\t\t        gl_FragColor = mix(B,A, f);\n\t\t    }\n        "}),r.materials.gradient=new THREE.ShaderMaterial({uniforms:{range:{type:"vec2",value:new THREE.Vector2(-4,5)}},vertexShader:r.getDefVertexShader(),fragmentShader:"\n            varying vec3 vPositionW;\n\n            uniform vec2 range;\n\n\t\t    void main(){\n                vec4 A = vec4(0,0,0, 1.0);\n                vec4 B = vec4(0,0.5,1, 1.0);\n\n                float t = (vPositionW.y - range.x)/(range.y - range.x);\n                t = clamp(t, 0.0,1.0);\n\n\t\t        gl_FragColor = mix(A,B, t);\n\t\t    }\n        "}),r.materials.lp=new THREE.ShaderMaterial({vertexShader:r.getDefVertexShader(),fragmentShader:"\n            varying vec3 vPositionW;\n\t\t    varying vec3 vNormalW;\n            varying vec3 vNormalV;\n\n\t\t    void main(){\n\t\t        vec3 viewDirectionW = normalize(cameraPosition - vPositionW);\n\n                float f;\n\t\t        //f = dot(viewDirectionW, vNormalW);\n                f = dot(vNormalV, vec3(0,0,1));\n\t\t        f = clamp(1.0 - f, 0.0, 1.0);\n\n\t\t        gl_FragColor = vec4(1.0,1.0,1.0, f);\n\t\t    }\n        ",transparent:!0,depthWrite:!1});let e=(new THREE.TextureLoader).load(ATON.PATH_RES+"point-mask.png");e.generateMipmaps=!1,r.materials.point=new THREE.PointsMaterial({vertexColors:!0,alphaMap:e,alphaTest:.5,depthTest:!0,transparent:!1,size:4,sizeAttenuation:!1}),r.materials.chromakey=new THREE.ShaderMaterial({uniforms:{tBase:{type:"t"},keycolor:{type:"vec4",value:new THREE.Vector4(0,1,0,0)},similarity:{type:"float",value:.4},smoothness:{type:"float",value:.08},spill:{type:"float",value:.1}},vertexShader:r.getDefVertexShader(),fragmentShader:"\n            uniform sampler2D tBase;\n            uniform vec4 keycolor;\n\n            uniform float similarity;\n            uniform float smoothness;\n            uniform float spill;\n\n            varying vec2 vUv;\n\n            // From https://github.com/libretro/glsl-shaders/blob/master/nnedi3/shaders/rgb-to-yuv.glsl\n            vec2 RGBtoUV(vec3 rgb){\n                return vec2(\n                    rgb.r * -0.169 + rgb.g * -0.331 + rgb.b *  0.5    + 0.5,\n                    rgb.r *  0.5   + rgb.g * -0.419 + rgb.b * -0.081  + 0.5\n                );\n            }\n\n            // From https://godotshaders.com/shader/green-screen-chromakey/\n\t\t    void main(){\n\t\t        vec4 frag = texture2D(tBase, vUv);\n                vec4 orig = frag;\n\n                float chromaDist = distance(RGBtoUV(frag.rgb), RGBtoUV(keycolor.rgb));\n\n                float baseMask = chromaDist - similarity;\n                float fullMask = pow(clamp(baseMask / smoothness, 0.0,1.0), 1.5);\n                frag.a         = fullMask;\n              \n                float spillVal = pow(clamp(baseMask / spill, 0.0,1.0), 1.5);\n                float desat    = clamp(frag.r * 0.2126 + frag.g * 0.7152 + frag.b * 0.0722, 0.0,1.0);\n                frag.rgb       = mix(vec3(desat, desat, desat), frag.rgb, spillVal);\n\n                frag = mix(orig,frag, keycolor.w);\n\n\t\t        gl_FragColor = frag;\n\t\t    }\n        ",transparent:!0,side:THREE.DoubleSide})},addMaterial:(e,t)=>{r.materials[e]?console.log("MatHub: material "+e+" already registered"):r.materials[e]=t},loadMaterial:(e,t)=>{r._loader.load(t,t=>{r.addMaterial(e,t)},void 0,e=>{console.log(e)})},getMaterial:e=>r.materials[e],update:()=>{r._uSem.time.value+=ATON._dt,r._uSem.sel.value.x=ATON.SUI.mainSelector.position.x,r._uSem.sel.value.y=ATON.SUI.mainSelector.position.y,r._uSem.sel.value.z=ATON.SUI.mainSelector.position.z,r._uSem.sel.value.w=ATON.SUI._selectorRad}};const a=r;let n={TSTRING_SEPARATOR:" ",VOID_CAST:(e,t)=>{},init:()=>{ATON.device={},n.geomUnitSphere=new THREE.SphereGeometry(1,32,32),n.geomUnitCube=new THREE.BoxGeometry,n.exporterGLTF=void 0,n.exporterOBJ=void 0,n.exporterUSDZ=void 0,n._dlink=document.createElement("a"),n._dlink.style.display="none",document.body.appendChild(n._dlink),n.textureLoader=new THREE.TextureLoader,n._bvhBounds=0,n.stats={},n.stats.numVertices=0,n.stats.numTris=0},generateID:e=>(void 0===e&&(e="id"),e+"-"+Math.random().toString(36).substr(2,9)),goToURL:e=>{window.location.href=e},goToScene:(e,t)=>{if(void 0===e)return;if(e.length<2)return;let o=ATON.PATH_FE+e;void 0!==t&&(o+="&vrc="+t),window.location.href=o},isConnectionSecure:()=>window.isSecureContext,isLocalhost:()=>!!window.location.origin.includes("localhost")||!!window.location.origin.includes("127.0.0.1"),showBVHbounds:e=>{e>0&&(n._bvhBounds=e)},_addBVHbounds:(e,t)=>{if(void 0===e)return;let o=new ThreeMeshBVH.MeshBVHHelper(e,t);o.displayParents=!0,o.update(),e.parent.add(o)},profileDevice:()=>{ATON.device.isMobile=!1,ATON.device.isMobile=!(!/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)&&!/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4))),ATON.device.xrSupported={},ATON.device.xrSupported["immersive-vr"]=!1,ATON.device.xrSupported["immersive-ar"]=!1,"xr"in navigator&&(navigator.xr.isSessionSupported("immersive-vr").then(e=>{ATON.device.xrSupported["immersive-vr"]=!!e,console.log("WebXR VR session support: "+ATON.device.xrSupported["immersive-vr"]),ATON.fire("XR_support",{type:"immersive-vr",v:ATON.device.xrSupported["immersive-vr"]})}),navigator.xr.isSessionSupported("immersive-ar").then(e=>{ATON.device.xrSupported["immersive-ar"]=!!e,console.log("WebXR AR session support: "+ATON.device.xrSupported["immersive-ar"]),ATON.fire("XR_support",{type:"immersive-ar",v:ATON.device.xrSupported["immersive-ar"]})}))},profileRenderingCapabilities:()=>{if(void 0===ATON._renderer)return;let e=ATON._renderer.capabilities;void 0!==e&&(ATON.device.lowGPU=!1,e.isWebGL2||(ATON.device.lowGPU=!0),e.maxTextureSize<8192&&(ATON.device.lowGPU=!0),e.maxCubemapSize<4096&&(ATON.device.lowGPU=!0),console.log(e))},isMobile:()=>ATON.device.isMobile,isVRsupported:()=>ATON.device.xrSupported["immersive-vr"],isARsupported:()=>ATON.device.xrSupported["immersive-ar"],getFileExtension:e=>e.substr(e.lastIndexOf(".")+1).toLowerCase(),removeFileExtension:e=>e.replace(/\.[^/.]+$/,""),isVideo:e=>{let t=n.getFileExtension(e);return"mp4"===t||"webm"===t||"m3u8"===t},isImage:e=>{let t=n.getFileExtension(e);return"jpg"===t||"png"===t||"ktx"===t||"ktx2"===t},getBaseFolder:e=>{var t=e.lastIndexOf("/");return-1!==t?e.substring(0,t+1):""},getFilename:e=>e.split(/(\\|\/)/g).pop(),isResourceURL:e=>!!e.startsWith("http://")||!!e.startsWith("https://"),URLify:e=>{if("string"!=typeof e)return e;const t=e.match(/(((ftp|https?):\/\/)[\-\w@:%_\+.~#?,&\/\/=]+)/g);return t&&t.forEach(function(t){e=e.replace(t,"<a target='_blank' href='"+t+"'><img class='atonSmallIcon' src='"+ATON.PATH_RES+"icons/link.png'></a>")}),e},resolveCollectionURL:e=>e?(ATON._collMod&&(e=ATON._collMod(e)),e.startsWith("http")?e:ATON.PATH_COLLECTION+e):"",tryLoadFromService:(e,t)=>{if(!t)return!1;if(e.startsWith("https://cesium.com/ion/assets/")||e.startsWith("https://ion.cesium.com/assets/")){let o=e.split("/"),i=o[o.length-1];return t.loadCesiumIONAsset(i),!0}if(e.startsWith("https://assets.cesium.com/")){let o=e.split("/"),i=o[o.length-2];return t.loadCesiumIONAsset(i),!0}if(e.startsWith("https://sketchfab.com/3d-models/")){let o=e.split("-"),i=o[o.length-1];return t.loadSketchfabAsset(i),!0}for(let o in ATON._resMappers){let i=ATON._resMappers[o](e);if(void 0!==i)return t.load(i),!0}return!1},postJSON:(e,t,o,i)=>{$.ajax({url:e,type:"POST",xhrFields:{withCredentials:!0},data:JSON.stringify(t),contentType:"application/json; charset=utf-8",dataType:"json",success:e=>{o&&o(e)}}).fail(e=>{console.log(e),i&&i()})},getJSON:(e,t)=>{fetch(e,{method:"GET",headers:{Accept:"application/json"}}).then(e=>e.json()).then(e=>{console.log(e),t&&t(e)})},runAsync:e=>{const t=new Worker(URL.createObjectURL(new Blob([`postMessage((${e})());`]),{type:"application/javascript; charset=utf-8"}));return new Promise((e,o)=>{t.onmessage=({data:o})=>{e(o),t.terminate()},t.onerror=e=>{o(e),t.terminate()}})},mergeObject:e=>{e.updateMatrixWorld(!0);const t=[];e.traverse(e=>{if(e.isMesh){const o=e.geometry;o.applyMatrix4(e.matrixWorld),t.push(o.toNonIndexed())}});const o=THREE.BufferGeometryUtils.mergeGeometries(t,!1),i=THREE.BufferGeometryUtils.mergeVertices(o).center(),r=new THREE.Group,a=new THREE.Mesh(i);return r.add(a),r},setPicking:(e,t,o)=>{void 0===o&&(o=!0),e.traverse(e=>{o?e.layers.enable(t):e.layers.disable(t)})},graphPostVisitor:e=>{e.visible?console.log(e):n.setPicking(e,e.type,!1)},rotationBetweenDirections:(e,t)=>{const o=new THREE.Quaternion,i=(new THREE.Vector3).crossVectors(e,t);return o.x=i.x,o.y=i.y,o.z=i.z,o.w=1+e.clone().dot(t),o.normalize(),o},clampValue:(e,t,o)=>Math.min(Math.max(e,t),o),loadTexture:(e,t)=>e.endsWith(".ktx2")?ATON._ktx2Loader.load(e,t):n.textureLoader.load(e,t),modelVisitor:(e,t)=>{if(void 0===t)return;if(void 0===e)return;let o=e.type;t.traverse(t=>{t.isMesh&&(o===ATON.NTYPES.SCENE&&(t.castShadow=!0,t.receiveShadow=!0,t.geometry&&(t.geometry.computeBoundsTree(),console.log("Computed visible BVH"),n._bvhBounds>0&&n._addBVHbounds(t,n._bvhBounds)),n.processMaterial(t.material)),o===ATON.NTYPES.SEM&&(t.material=ATON.MatHub.materials.semanticShape,t.geometry&&(t.geometry.computeBoundsTree(),console.log("Computed semantic BVH"))),e.userData.cMat&&(t.material=e.userData.cMat))})},processMaterial:e=>{void 0!==e&&null!==e.map&&void 0!==e.map&&(e.map.generateMipmaps=!0,e.map.anisotropy=ATON.device.isMobile?0:ATON._maxAnisotropy,e.map.minFilter=THREE.LinearMipmapLinearFilter,e.map.magFilter=THREE.LinearFilter,e.map.colorSpace=ATON._stdEncoding)},_visitorCP:e=>{ATON._renderer.localClippingEnabled&&(e||(e=ATON._rootVisible),e.traverse(e=>{e.material&&(e.material.clippingPlanes=ATON._clipPlanes,e.material.clipIntersection=!1,e.material.clipShadows=!0)}))},cleanupVisitor:e=>{e.traverse(e=>{if(e.material)if(e.material.length)for(let t=0;t<e.material.length;++t)e.material[t].map&&e.material[t].map.dispose(),e.material[t].envMap&&e.material[t].envMap.dispose(),e.material[t].alphaMap&&e.material[t].alphaMap.dispose(),e.material[t].emissiveMap&&e.material[t].emissiveMap.dispose(),e.material[t].lightMap&&e.material[t].lightMap.dispose(),e.material[t].dispose();else e.material.map&&e.material.map.dispose(),e.material.envMap&&e.material.envMap.dispose(),e.material.alphaMap&&e.material.alphaMap.dispose(),e.material.emissiveMap&&e.material.emissiveMap.dispose(),e.material.lightMap&&e.material.lightMap.dispose(),e.material.dispose();e.userData&&e.userData.cMat&&e.userData.cMat.dispose(),e.geometry&&(e.geometry.disposeBoundsTree(),e.geometry.dispose())}),e=null},registerAniMixers:(e,t)=>{let o=t.scene||t.scene[0],i=!1;if(void 0===t.animations)return;let r=new THREE.AnimationMixer(o);t.animations.forEach(e=>{r.clipAction(e).play(),i=!0}),i&&(ATON._aniMixers.push(r),void 0===e._aniMixers&&(e._aniMixers=[]),e._aniMixers.push(r))},parseTransformString:e=>{let t=new THREE.Group,o=e.split(n.TSTRING_SEPARATOR),i=o.length;return i<3||(t.position.set(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2])),i<6||(t.rotation.set(parseFloat(o[3]),parseFloat(o[4]),parseFloat(o[5])),i<9||t.scale.set(parseFloat(o[6]),parseFloat(o[7]),parseFloat(o[8])))),t},setVectorPrecision:(e,t)=>(e.x=parseFloat(e.x.toPrecision(t)),e.y=parseFloat(e.y.toPrecision(t)),e.z=parseFloat(e.z.toPrecision(t)),e),parseMD:e=>(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/^\s*\n\*/gm,"<ul>\n*")).replace(/^(\*.+)\s*\n([^\*])/gm,"$1\n</ul>\n\n$2")).replace(/^\*(.+)/gm,"<li>$1</li>")).replace(/^\s*\n\d\./gm,"<ol>\n1.")).replace(/^(\d\..+)\s*\n([^\d\.])/gm,"$1\n</ol>\n\n$2")).replace(/^\d\.(.+)/gm,"<li>$1</li>")).replace(/^\>(.+)/gm,"<blockquote>$1</blockquote>")).replace(/[\#]{6}(.+)/g,"<h6>$1</h6>")).replace(/[\#]{5}(.+)/g,"<h5>$1</h5>")).replace(/[\#]{4}(.+)/g,"<h4>$1</h4>")).replace(/[\#]{3}(.+)/g,"<h3>$1</h3>")).replace(/[\#]{2}(.+)/g,"<h2>$1</h2>")).replace(/[\#]{1}(.+)/g,"<h1>$1</h1>")).replace(/^(.+)\n\=+/gm,"<h1>$1</h1>")).replace(/^(.+)\n\-+/gm,"<h2>$1</h2>")).replace(/\!\[([^\]]+)\]\(([^\)]+)\)/g,'<img src="$2" alt="$1" />')).replace(/[\[]{1}([^\]]+)[\]]{1}[\(]{1}([^\)\"]+)(\"(.+)\")?[\)]{1}/g,'<a href="$2" title="$4">$1</a>')).replace(/[\*\_]{2}([^\*\_]+)[\*\_]{2}/g,"<b>$1</b>")).replace(/[\*\_]{1}([^\*\_]+)[\*\_]{1}/g,"<i>$1</i>")).replace(/[\~]{2}([^\~]+)[\~]{2}/g,"<del>$1</del>")).replace(/^\s*\n\`\`\`(([^\s]+))?/gm,'<pre class="$2">')).replace(/^\`\`\`\s*\n/gm,"</pre>\n\n")).replace(/[\`]{1}([^\`]+)[\`]{1}/g,"<code>$1</code>")).replace(/^\s*(\n)?(.+)/gm,function(e){return/\<(\/)?(h\d|ul|ol|li|blockquote|pre|img)/.test(e)?e:"<p>"+e+"</p>"})).replace(/(\<pre.+\>)\s*\n\<p\>(.+)\<\/p\>/gm,"$1$2"),checkAuth:e=>{$.ajax({type:"GET",url:ATON.PATH_RESTAPI+"user",xhrFields:{withCredentials:!0},dataType:"json",success:t=>{e(t)}})},getHumanReadableDistance:e=>{let t=" m";return e<.01?(t=" mm",t=(e*=1e3).toPrecision(3)+t,t):e<1?(t=" cm",t=(e*=100).toPrecision(3)+t,t):e>1e3?(t=" km",t=e.toPrecision(3)+t,t):(t=e.toPrecision(3)+t,t)},stripHTMLtagsFromString:e=>e.replace(/(<([^>]+)>)/gi,""),requestFullscreen:()=>{let e=document.documentElement;return e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen(),!0},downloadBlob:(e,t)=>{void 0!==t&&(n._dlink.href=URL.createObjectURL(e),n._dlink.download=t,n._dlink.click())},downloadText:(e,t)=>{n.downloadBlob(new Blob([e],{type:"text/plain"}),t)},downloadJSONobj:(e,t)=>{n.downloadText(JSON.stringify(e),t)},downloadArrayBuffer:(e,t)=>{n.downloadBlob(new Blob([e],{type:"application/octet-stream"}),t)},downloadImageFromCanvas:(e,t)=>{if(!e)return;let o=e.toDataURL();ATON.Utils._dlink.href=o,ATON.Utils._dlink.download=t,ATON.Utils._dlink.click()},exportNode:(e,t)=>{let o=n.getFileExtension(t);if(!(o.length<1)){if("glb"===o||"gltf"===o){let i={binary:"glb"===o};void 0===n.exporterGLTF&&(n.exporterGLTF=new THREE.GLTFExporter),n.exporterGLTF.parse(e,e=>{e instanceof ArrayBuffer?n.downloadArrayBuffer(e,t):(console.log(e),n.downloadJSONobj(e,t))},i)}if("obj"===o){void 0===n.exporterOBJ&&(n.exporterOBJ=new THREE.OBJExporter);let o=n.exporterOBJ.parse(e);n.downloadText(o,t)}"usdz"===o&&(void 0===n.exporterUSDZ&&(n.exporterUSDZ=new THREE.USDZExporter),$("#idLoader").show(),n.exporterUSDZ.parse(e).then(e=>{n.downloadArrayBuffer(e,t),$("#idLoader").hide()}))}},takeScreenshot:(e,t,o)=>{console.log("Screenshot with size:"+e),ATON.Nav._camera.aspect=1,ATON.Nav._camera.updateProjectionMatrix(),ATON._renderer.setSize(e,e),ATON._renderer.render(ATON._mainRoot,ATON.Nav._camera);let i=ATON._renderer.domElement;if(ATON.FX.composer){if(ATON.FX.composer.setSize(e,e),ATON.FX.passes[ATON.FX.PASS_AA]){let t=ATON.FX.passes[ATON.FX.PASS_AA].material.uniforms;t&&t.resolution.value.set(1/e,1/e)}ATON.FX.composer.render(),i=ATON.FX.composer.renderer.domElement}let r=ATON._renderer.domElement.toDataURL();if(t&&(n._dlink.href=r.replace("image/png","image/octet-stream"),n._dlink.download=t,n._dlink.click()),ATON._onResize(),o)return r;let a=new Image;return a.src=r,a},takeScreenshotFromPOV:(e,t,o,i)=>{if(!e)return;ATON.Nav._camera.position.copy(e.pos),ATON.Nav._controls.target.copy(e.target),ATON.Nav._controls.update(),ATON.Nav._camera.updateProjectionMatrix(),ATON.getRootUI().hide();let r=n.takeScreenshot(t,o,i);return ATON.getRootUI().show(),r},assignLightProbeToMesh:(e,t)=>{void 0!==e&&void 0!==t&&(t.noLP||(t.userData.LP=e))},clearLightProbeFromMesh:e=>{void 0!==e&&(e.noLP||(e.userData.LP=null))},vibrate:e=>{void 0===e&&(e=100),window.navigator.vibrate(e)},createATONCube:e=>{let t=new THREE.BoxGeometry(1,1,1),o=new THREE.MeshStandardMaterial;n.textureLoader.load(ATON.PATH_RES+"models/aton-cube.jpg",e=>{e.colorSpace=ATON._stdEncoding,o.map=e});let i=ATON.createSceneNode(e);return i.add(new THREE.Mesh(t)),i.setMaterial(o),i.enablePicking(),i},createATONCubePBR:e=>{let t=new THREE.BoxGeometry(1,1,1),o=new THREE.MeshStandardMaterial;o.metalness=1,n.textureLoader.load(ATON.PATH_RES+"models/aton-cube.jpg",e=>{e.colorSpace=ATON._stdEncoding,o.map=e}),n.textureLoader.load(ATON.PATH_RES+"models/aton-cube-pbr.jpg",e=>{e.colorSpace=ATON._stdEncoding,o.metalnessMap=e,o.roughnessMap=e}),n.textureLoader.load(ATON.PATH_RES+"models/aton-cube-nrm.png",e=>{e.colorSpace=ATON._stdEncoding,o.normalMap=e});let i=ATON.createSceneNode(e);return i.add(new THREE.Mesh(t)),i.setMaterial(o),i.enablePicking(),i},createGround:(e,t,o)=>{void 0===t&&(t=1),void 0===o&&(o=1);let i=new THREE.PlaneGeometry(t,o),r=new THREE.MeshStandardMaterial;void 0!==e&&n.textureLoader.load(e,e=>{e.colorSpace=ATON._stdEncoding,r.map=e});let a=ATON.createSceneNode().rotateX(.5*-Math.PI);return a.add(new THREE.Mesh(i,r)),a.enablePicking(),a},convertByteArrayToHexString:e=>e.reduce((e,t)=>e+t.toString(16).padStart(2,"0"),""),convertHexStringToByteArray:e=>Uint8Array.from(e.match(/.{1,2}/g).map(e=>parseInt(e,16)))};const s=n;let l={MODE_ADD:0,MODE_DEL:1,FLOAT_PREC:5,init:()=>{l.currID=void 0,l.currData=void 0,l._bEdit=!1,l._bLoading=!1,l._title=void 0,l._descr=void 0,l.initBaseParsers()},setEditMode:e=>{l._bEdit=e,console.log("Edit mode:"+e)},load:(e,t,o)=>(l._bLoading=!0,console.log("Loading Scene: "+t),$.getJSON(e,e=>{l.currData=e,l.currID=t,l._bLoading=!1,l.parseScene(e),o&&o(),ATON.fire("SceneJSONLoaded",t)})),clearScene:()=>{if(!(ATON._rootVisible.children.length<=0)){ATON._rootVisible.removeChildren();for(let e in ATON.snodes)e!==ATON.ROOT_NID&&ATON.snodes[e]&&(ATON.snodes[e].removeChildren(),delete ATON.snodes[e]);ATON.MRes.clear(),ATON.XPFNetwork.clear()}},clearSemantics:()=>{if(!(ATON._rootSem.children.length<=0)){ATON._rootSem.removeChildren();for(let e in ATON.semnodes)e!==ATON.ROOT_NID&&ATON.semnodes[e]&&(ATON.semnodes[e].removeChildren(),delete ATON.semnodes[e]);ATON.SUI.gSemIcons&&ATON.SUI.gSemIcons.removeChildren(),ATON.SemFactory.stopCurrentConvex(),ATON.SemFactory.init()}},clear:()=>{l.clearScene(),l.clearSemantics(),ATON.clearLightProbes(),ATON.Nav.clear(),ATON.FX.reset()},parseScene:e=>{if(void 0!==(e=void 0===e?l.currData:e))for(let t in e)l._jsonParsers[t]&&l._jsonParsers[t](e[t])},getJSONchildren:(e,t)=>{let o;void 0===t&&(t=ATON.NTYPES.SCENE);let i=[];if(t===ATON.NTYPES.SEM&&(o=ATON.getSemanticNode(e)),t===ATON.NTYPES.SCENE&&(o=ATON.getSceneNode(e)),void 0!==o){for(let e in o.children){let t=o.children[e];void 0!==t.nid&&i.push(t.nid)}return i}},getJSONgraphEdges:e=>{void 0===e&&(e=ATON.NTYPES.SCENE);let t=ATON.snodes;e===ATON.NTYPES.SEM&&(t=ATON.semnodes),e===ATON.NTYPES.UI&&(t=ATON.uinodes);let o={};for(let e in t){let i=t[e];i&&i.parent&&i.parent.nid&&(void 0===o[i.parent.nid]&&(o[i.parent.nid]=[]),o[i.parent.nid].push(i.nid))}return o},getJSONsemanticSpheresList:e=>{let t=ATON.getSemanticNode(e);if(void 0===t)return;let o=[];for(let e in t.children){let i=t.children[e];i.type&&o.push([parseFloat(i.position.x.toPrecision(l.FLOAT_PREC)),parseFloat(i.position.y.toPrecision(l.FLOAT_PREC)),parseFloat(i.position.z.toPrecision(l.FLOAT_PREC)),parseFloat(i.scale.x.toPrecision(l.FLOAT_PREC))])}return o},getJSONsemanticConvexShapes:e=>{let t=ATON.getSemanticNode(e);if(void 0===t)return;let o=[];for(let e in t.children){let i=t.children[e];i.userData._convexPoints&&o.push(i.userData._convexPoints)}return o},_applyJSONTransformToNode:(e,t)=>{if(void 0!==e&&void 0!==t){if(e.bUseGeoCoords)return t.bUseGeoCoords=!0,void(e.scale&&t.setScale(e.scale[0],e.scale[1],e.scale[2]));e.autocenter?t.autocenter=!0:e.position&&t.setPosition(e.position[0],e.position[1],e.position[2]),e.rotation&&t.setRotation(e.rotation[0],e.rotation[1],e.rotation[2]),e.scale&&t.setScale(e.scale[0],e.scale[1],e.scale[2]),e.list&&Array.isArray(e.list)}},initBaseParsers:()=>{l._jsonParsers={},l._jsonParsers.title=e=>{void 0!==e&&l.setTitle(e)},l._jsonParsers.description=e=>{void 0!==e&&l.setDescription(e)},l._jsonParsers.fx=e=>{e.ao&&(ATON.FX.togglePass(ATON.FX.PASS_AO,!0),e.ao.i&&ATON.FX.setAOintensity(parseFloat(e.ao.i))),e.bloom&&(ATON.FX.togglePass(ATON.FX.PASS_BLOOM,!0),e.bloom.i&&ATON.FX.setBloomStrength(parseFloat(e.bloom.i)),e.bloom.t&&ATON.FX.setBloomThreshold(parseFloat(e.bloom.t))),e.dof&&(ATON.FX.togglePass(ATON.FX.PASS_DOF,!0),e.dof.f&&ATON.FX.setDOFfocus(parseFloat(e.dof.f)))},l._jsonParsers.environment=e=>{let t=e.mainpano;if(e.mainpano&&(t.url&&ATON.setMainPanorama(t.url),t.rotation&&ATON.setMainPanoramaRotation(t.rotation)),e.bgcolor){let t=new THREE.Color(e.bgcolor[0],e.bgcolor[1],e.bgcolor[2]);ATON.setBackgroundColor(t)}let o=e.mainlight;o?(o.direction&&ATON.setMainLightDirection(new THREE.Vector3(o.direction[0],o.direction[1],o.direction[2])),ATON._dMainL?(o.color&&(ATON._dMainL.color=new THREE.Color(o.color[0],o.color[1],o.color[2])),o.intensity&&(ATON._dMainL.intensity=o.intensity),void 0!==o.shadows?ATON.toggleShadows(o.shadows):ATON.toggleShadows(!1)):ATON.toggleMainLight(!1)):ATON.toggleMainLight(!1);let i=e.lightprobes;if(i&&(void 0!==i.auto&&ATON.setAutoLP(i.auto),i.list))for(let e in i.list){let t=i.list[e],o=new ATON.LightProbe(t.res);t.pos&&o.setPosition(parseFloat(t.pos[0]),parseFloat(t.pos[1]),parseFloat(t.pos[2])),t.near&&o.setNear(parseFloat(t.near)),t.far&&o.setFar(parseFloat(t.far)),ATON.addLightProbe(o),console.log(o)}e.exposure&&ATON.setExposure(e.exposure)},l._jsonParsers.soundscape=e=>{void 0!==e&&e.global&&ATON.setGlobalAudio(e.global.url,e.global.loop)},l._jsonParsers.navmode=e=>{void 0!==e&&ATON.Nav.setNavMode(e)},l._jsonParsers.locomotionGraph=e=>{if(void 0!==e){for(let t in e){let o=e[t];o.pos&&ATON.Nav.addLocomotionNode(parseFloat(o.pos[0]),parseFloat(o.pos[1]),parseFloat(o.pos[2]),!0)}ATON.Nav.setFirstPersonControl(),ATON.Nav.toggleLocomotionValidator(!1)}},l._jsonParsers.measurements=e=>{if(void 0!==e)for(let t in e){let o=e[t];if(o.points&&6===o.points.length){let e=new THREE.Vector3(parseFloat(o.points[0]),parseFloat(o.points[1]),parseFloat(o.points[2])),t=new THREE.Vector3(parseFloat(o.points[3]),parseFloat(o.points[4]),parseFloat(o.points[5]));ATON.SUI.addMeasurementPoint(e),ATON.SUI.addMeasurementPoint(t)}}},l._jsonParsers.viewpoints=e=>{if(void 0!==e)for(let t in e){let o=e[t];"home"===t?ATON.Nav.setHomePOV((new ATON.POV).setPosition(o.position[0],o.position[1],o.position[2]).setTarget(o.target[0],o.target[1],o.target[2]).setFOV(o.fov)):new ATON.POV(t).setPosition(o.position[0],o.position[1],o.position[2]).setTarget(o.target[0],o.target[1],o.target[2]).setFOV(o.fov)}},l._jsonParsers.scenegraph=e=>{if(void 0===e)return;let t=e.nodes,o=e.edges;for(let e in t){let o=t[e],i=ATON.getOrCreateSceneNode(e).removeChildren();l._applyJSONTransformToNode(o.transform,i);let r=o.urls;if(r&&(Array.isArray(r)?r.forEach(e=>{i.load(e)}):i.load(r)),o["cesium.ion"]){let e=o["cesium.ion"];ATON.MRes.loadCesiumIONAsset(e,i)}if(o.stream){let t,r=o.stream;if(r.src.startsWith("#")){let e=parseInt(r.src.substring(1));t=ATON.MediaFlow.getOrCreateVideoStream(e,void 0,!0)}else{let o=ATON.Utils.resolveCollectionURL(r.src);t=ATON.MediaFlow.getOrCreateVideoStream(e,o)}if(r.chromakey){let e=r.chromakey.color;e&&t.matStream.uniforms.keycolor.value.set(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])),r.chromakey.smoothness&&(t.matStream.uniforms.smoothness.value=parseFloat(r.chromakey.smoothness)),r.chromakey.spill&&(t.matStream.uniforms.spill.value=parseFloat(r.chromakey.spill)),r.chromakey.similarity&&(t.matStream.uniforms.similarity.value=parseFloat(r.chromakey.similarity))}if(!o.urls){let e=new THREE.PlaneGeometry(1,1),o=new THREE.Mesh(e);o.scale.x=1,o.scale.y=-1,t.el.addEventListener("loadedmetadata",e=>{let i=t.el.videoWidth/t.el.videoHeight;o.scale.x=i,o.scale.y=-1}),ATON.Utils.modelVisitor(i,o),i.add(o),ATON._bqScene=!0,i.setPickable(!0),i.dirtyBound()}i.setMaterial(t.matStream)}o.shadowcast&&i.setShadowCast(o.shadowcast),o.shadowreceive&&i.setShadowCast(o.shadowreceive),o.toYup&&i.setYup(),o.keywords&&(i.kwords=o.keywords)}for(let e in o){let t=o[e],i=ATON.getSceneNode(e);if(void 0!==i)for(let e in t){let o=t[e],r=ATON.getSceneNode(o);void 0!==r&&r.attachTo(i)}}for(let e in t){let o=t[e],i=ATON.getSceneNode(e);if(void 0!==i&&(void 0!==o.show&&(o.show?(i.show(),console.log("show "+e)):(i.hide(),console.log("hide "+e))),o.material)){let e;"string"==typeof o.material?e=ATON.MatHub.materials[o.material]:o.material.fragmentShader||o.material.vertexShader?(o.material.vertexShader||(o.material.vertexShader=ATON.MatHub.getDefVertexShader()),e=new THREE.ShaderMaterial(o.material)):e=new THREE.MeshStandardMaterial(o.material),e&&i.setMaterial(e)}}},l._jsonParsers.semanticgraph=e=>{if(void 0===e)return;let t=e.nodes,o=e.edges;for(let e in t){let o=t[e],i=ATON.getOrCreateSemanticNode(e).removeChildren(),r=o.urls;r&&(Array.isArray(r)?r.forEach(e=>{i.load(e)}):i.load(r)),o.toYup&&i.setYup(),o.description&&i.setDescription(o.description),o.audio&&i.setAudio(o.audio),o.keywords&&(i.kwords=o.keywords);let a=o.spheres;if(Array.isArray(a))for(let t in a){let o=a[t],i=new THREE.Vector3(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2]));ATON.SemFactory.createSphere(e,i,parseFloat(o[3]))}let n=o.convexshapes;if(Array.isArray(n))for(let t in n){let o=n[t],i=[];for(let e=0;e<o.length;e+=3){let t=new THREE.Vector3(o[e],o[e+1],o[e+2]);i.push(t)}ATON.SemFactory.createConvexShape(e,i)}}for(let e in o){let t=o[e],i=ATON.getSemanticNode(e);if(void 0!==i)for(let e in t){let o=t[e],r=ATON.getSemanticNode(o);void 0!==r&&r.attachTo(i)}}for(let e in t){let o=t[e],i=ATON.getSemanticNode(e);if(void 0!==i&&(void 0!==o.show&&(o.show?(i.show(),console.log("show "+e)):(i.hide(),console.log("hide "+e))),o.nopicking&&i.disablePicking(),o.material)){let e=new THREE.MeshStandardMaterial(o.material);i.setMaterial(e)}}},l._jsonParsers.xpfnet=e=>{if(ATON.Nav.setFirstPersonControl(),e.list){let t=e.list,o=t.length;for(let e=0;e<o;e++){let o=t[e],i=new ATON.XPF;i.realizeSUI(),o.location&&i.setLocation(o.location[0],o.location[1],o.location[2]),o.rotation&&i.setRotation(o.rotation[0],o.rotation[1],o.rotation[2]),o.baselayer&&i.setBaseLayer(o.baselayer),ATON.XPFNetwork.add(i)}}e.photoscanOPKfile&&XPFNetwork.loadFromPhotoscanFile(e.photoscanOPKfile,()=>{ATON.XPFNetwork.setHomeXPF(0),ATON.XPFNetwork.requestTransitionByIndex(0,0)})}},addSceneParser:(e,t)=>{l._jsonParsers[e]=t},patch:(e,t,o)=>{if(l._bLoading||!l._bEdit)return;if(void 0===e)return;void 0===t&&(t=l.MODE_ADD);let i=l.currID,r={};r.data=e,r.mode=t===l.MODE_DEL?"DEL":"ADD";let a=JSON.stringify(r);e=null,r=null,$.ajax({url:ATON.PATH_RESTAPI2+"scenes/"+i,type:"PATCH",data:a,contentType:"application/json; charset=utf-8",dataType:"json",success:e=>{e&&(l.currData=e),o&&o()}})}};l.sendEdit=l.patch,l.setVisibility=(e,t)=>{l.currData.visibility=e,l.sendEdit({visibility:e},ATON.SceneHub.MODE_ADD,t)},l.currSceneHasHomeConfig=()=>void 0!==l.currData&&void 0!==l.currData.viewpoints&&void 0!==l.currData.viewpoints.home,l.setTitle=e=>{l._title=e},l.getTitle=()=>l._title,l.setDescription=e=>{l._descr=e},l.getDescription=()=>l._descr;const d=l;let c={init:()=>{c._listener=new THREE.AudioListener,c._loader=new THREE.AudioLoader,c._bGenAuPlaying=!1},playOnceGlobally:(e,t)=>{if(t&&c._bGenAuPlaying)return;e=ATON.Utils.resolveCollectionURL(e);let o=new THREE.Audio(ATON.AudioHub._listener);return c._loader.load(e,e=>{o.setBuffer(e),o.play(),t&&(c._bGenAuPlaying=!0)}),t&&(o.onEnded=()=>{c._bGenAuPlaying=!1}),o}};const u=c;class p extends THREE.EventDispatcher{constructor(e){super(),!1===window.isSecureContext&&console.error("DeviceOrientationEvent is only available in secure contexts (https)"),this._zee=new THREE.Vector3(0,0,1),this._euler=new THREE.Euler,this._q0=new THREE.Quaternion,this._q1=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._changeEvent={type:"change"};const t=this,o=new THREE.Quaternion;this.object=e,this.object.rotation.reorder("YXZ"),this.enabled=!0,this.deviceOrientation={},this.screenOrientation=0,this.alphaOffset=0;const i=function(e){t.deviceOrientation=e},r=function(){t.screenOrientation=window.orientation||0};this.connect=function(){r(),void 0!==window.DeviceOrientationEvent&&"function"==typeof window.DeviceOrientationEvent.requestPermission?window.DeviceOrientationEvent.requestPermission().then(function(e){"granted"==e&&(window.addEventListener("orientationchange",r),window.addEventListener("deviceorientation",i))}).catch(function(e){console.error("Unable to use DeviceOrientation API:",e)}):(window.addEventListener("orientationchange",r),window.addEventListener("deviceorientation",i)),t.enabled=!0},this.disconnect=function(){window.removeEventListener("orientationchange",r),window.removeEventListener("deviceorientation",i),t.enabled=!1},this.update=function(){if(!1===t.enabled)return;const e=t.deviceOrientation;if(e){const i=e.alpha?THREE.MathUtils.degToRad(e.alpha)+t.alphaOffset:0,r=e.beta?THREE.MathUtils.degToRad(e.beta):0,a=e.gamma?THREE.MathUtils.degToRad(e.gamma):0,n=t.screenOrientation?THREE.MathUtils.degToRad(t.screenOrientation):0;!function(e,o,i,r,a){t._euler.set(i,o,-r,"YXZ"),e.setFromEuler(t._euler),e.multiply(t._q1),e.multiply(t._q0.setFromAxisAngle(t._zee,-a))}(t.object.quaternion,i,r,a,n),8*(1-o.dot(t.object.quaternion))>1e-6&&(o.copy(t.object.quaternion),t.dispatchEvent(t._changeEvent))}},this.dispose=function(){t.disconnect()},this.connect()}}const _=p;let m={STD_FOV:50,STD_NEAR:.01,STD_FAR:1e3,FP_EPS:.01,STD_POV_TRANS_DURATION:2,STD_LOCNODE_SIZE:.5,MIN_LOC_VALID_DIST:1.5,MODE_ORBIT:0,MODE_FP:1,MODE_DEVORI:2,LocomotionNode:class{constructor(e){this.pos=new THREE.Vector3(0,0,0),this.id=e,this._iXPF=void 0,this._sui=void 0}setLocation(e,t,o){return e instanceof THREE.Vector3?this.pos.copy(e):this.pos.set(e,t,o),this._sui&&this._sui.position.copy(this.pos),this}getLocation(){return this.pos}realizeSUI(e){return void 0===ATON.SUI.gLocNodes||(this._sui=new THREE.Sprite(ATON.SUI.getOrCreateSpriteWalk()),this._sui.position.copy(this.pos),this._sui.scale.set(ATON.Nav.STD_LOCNODE_SIZE,ATON.Nav.STD_LOCNODE_SIZE,ATON.Nav.STD_LOCNODE_SIZE),ATON.SUI.gLocNodes.add(this._sui)),this}toggleSUI(e){return void 0===this._sui||(this._sui.visible=e),this}},STD_LOC_VALIDATOR:()=>{if(void 0===ATON._queryDataScene)return void(m._bValidLocomotion=!1);let e=ATON._queryDataScene,t=(e.p,e.n);e.d<=m.MIN_LOC_VALID_DIST?m._bValidLocomotion=!1:t?t.y<=.7?m._bValidLocomotion=!1:m._bValidLocomotion=!0:m._bValidLocomotion=!1},init:()=>{m._mode=void 0,m.POVtransitionDuration=m.STD_POV_TRANS_DURATION,m._rotSpeedOrbit=.4,m._rotSpeedFP=-.2,m._inertia=.08,m._bControl=!0,m._bLocValidator=!0,m._bInteracting=!1,m._prevMode=void 0,m.setOrbitControl(),m._currPOV=(new ATON.POV).setPosition(0,0,0).setTarget(1,0,0).setFOV(ATON.Nav.STD_FOV),m._fromPOV=new ATON.POV,m._reqPOV=new ATON.POV,m.homePOV=void 0,m._tPOVcall=-1,m._tPOVprogress=0,m.povlist={},m._vDir=new THREE.Vector3(1,0,0),m._qOri=new THREE.Quaternion,m._lastPos=new THREE.Vector3(0,0,0),m._lastOri=new THREE.Quaternion,m._dOri=0,m._dPos=0,m._motionAmt=0,m._motionDir=new THREE.Vector3(0,1,0),m._bValidLocomotion=!1,m._locNodes=[],m._prevLN=void 0},getCurrentEyeLocation:()=>m._currPOV.pos,getCurrentDirection:()=>m._vDir,copyCurrentPOV:()=>{let e=new ATON.POV;return e.pos.copy(m._currPOV.pos),e.target.copy(m._currPOV.target),e.fov=m._currPOV.fov,e},addPOV:(e,t)=>{if(void 0!==e)return e.as(t),e},clearPOVs:()=>{for(let e in ATON.Nav.povlist)delete m.povlist[e]},isTransitioning:()=>m._tPOVcall>=0,currentQueryValidForLocomotion:()=>m._bValidLocomotion};m.locomotionValidator=m.STD_LOC_VALIDATOR,m.toggleLocomotionValidator=e=>{e?m._bLocValidator=!0:(m._bLocValidator=!1,m._bValidLocomotion=!1)},m.addLocomotionNode=(e,t,o,i)=>{let r=(new m.LocomotionNode).setLocation(e,t,o);return i&&r.realizeSUI(),m._locNodes.push(r),ATON.fire("LocomotionNodeAdded",r),r},m.getLocomotionNodeByIndex=e=>m._locNodes[e],m.clearLocomotionNodes=()=>{m._locNodes=[],m._prevLN=void 0,ATON.SUI.gLocNodes&&ATON.SUI.gLocNodes.removeChildren()},m.getLocomotionNodeInSight=()=>{let e=m._locNodes.length;if(e<=0)return;if(m.isTransitioning())return;let t,o,i=m._currPOV.pos,r=m._vDir;void 0===m._dirLNode&&(m._dirLNode=new THREE.Vector3);for(let a=0;a<e;a++)if(m._posLNode=m._locNodes[a].pos,m._dirLNode.x=m._posLNode.x-i.x,m._dirLNode.y=m._posLNode.y-i.y,m._dirLNode.z=m._posLNode.z-i.z,m._dirLNode=m._dirLNode.normalize(),m._dirLNode.dot(r)>.8){let e=i.distanceToSquared(m._posLNode);e>.3&&(void 0===o||e<o)&&(o=e,t=a)}return t},m.requestTransitionToLocomotionNode=(e,t)=>{if(void 0===e)return;if(m._mode===m.MODE_ORBIT)return;let o=ATON.Nav._vDir,i=(new ATON.POV).setPosition(e.pos).setTarget(e.pos.x+o.x,e.pos.y+o.y,e.pos.z+o.z).setFOV(m._currPOV.fov);e.toggleSUI(!1),void 0!==m._prevLN&&m._prevLN.toggleSUI(!0),m.requestPOV(i,t),m._prevLN=e,ATON.fire("LocomotionNodeRequested",e)},m.requestTransitionToLocomotionNodeInSightIfAny=e=>{let t=ATON.XPFNetwork.getNextXPFindex();if(void 0!==t)return m.requestTransitionToLocomotionNode(ATON.XPFNetwork._list[t]._lnode,e),!0;let o=ATON.Nav.getLocomotionNodeInSight();if(void 0===o)return!1;let i=m._locNodes[o];return m.requestTransitionToLocomotionNode(i,e),!0},m.requestDeltaRotation=(e,t,o)=>{if(ATON.XR._bPresenting)return;let i=new THREE.Vector3,r=new THREE.Vector3;i.crossVectors(m._vDir,THREE.Object3D.DEFAULT_UP),r.x=m._currPOV.target.x+i.x*e,r.y=m._currPOV.target.y+t,r.z=m._currPOV.target.z+i.z*e;let a=new ATON.POV;a.setTarget(r),a.setPosition(ATON.Nav._currPOV.pos),ATON.Nav.requestPOV(a,o)},m.setUserControl=e=>{void 0!==e&&e!==m._bControl&&(m._bControl=e,void 0!==m._controls&&(m._controls.enabled=e),m._cOrbit&&(m._cOrbit.enabled=e),m._cFirstPerson&&(m._cFirstPerson.enabled=e),console.log("Nav controls: "+m._bControl))},m.toggleUserControl=()=>{m.setUserControl(!m._bControl)},m.isUserControlEnabled=()=>m._bControl,m.isOrbit=()=>!ATON.XR._bPresenting&&m._mode===m.MODE_ORBIT,m.isFirstPerson=()=>!ATON.XR._bPresenting&&m._mode===m.MODE_FP,m.isDevOri=()=>!ATON.XR._bPresenting&&m._mode===m.MODE_DEVORI,m.setNavMode=e=>{void 0!==e&&(e===m.MODE_ORBIT&&m.setOrbitControl(),e===m.MODE_FP&&m.setFirstPersonControl(),e===m.MODE_DEVORI&&m.setDeviceOrientationControl())},m.restorePreviousNavMode=()=>{void 0===m._prevMode&&m.setOrbitControl(),m.setNavMode(m._prevMode)},m._updCamera=e=>{if(void 0===e&&(e=m._camera),ATON.FX.composer){let t=ATON.FX.composer.passes;if(t)for(let o=0;o<t.length;o++)t[o].camera&&(t[o].camera=e)}m._currPOV&&(e.fov=m._currPOV.fov,e.updateProjectionMatrix()),ATON._setupGizmo(),ATON.MRes.updateTSetsCamera(e)},m.setOrbitControl=()=>{if(!ATON.XR.isPresenting()){if(m._prevMode=m._mode,m._mode=m.MODE_ORBIT,m._bInteracting=!1,ATON.fire("NavInteraction",!1),void 0===m._cOrbit){m._camOrbit=new THREE.PerspectiveCamera(m.STD_FOV,window.innerWidth/window.innerHeight,m.STD_NEAR,m.STD_FAR),m._camOrbit.layers.enableAll(),m._cOrbit=new THREE.OrbitControls(m._camOrbit,ATON._renderer.domElement);let e=m._cOrbit;e.rotateSpeed=m._rotSpeedOrbit,e.enablePan=!0,m._inertia>0&&(e.enableDamping=!0,e.dampingFactor=m._inertia),e.screenSpacePanning=!0,e.enableZoom=!0,e.minDistance=.03,e.maxDistance=300,m._bControl||(e.enabled=!1),e.addEventListener("start",()=>{m._bInteracting=!0,ATON.fire("NavInteraction",!0)}),e.addEventListener("end",()=>{m._bInteracting=!1,ATON.fire("NavInteraction",!1)})}m._controls=m._cOrbit,m._camera=m._camOrbit,ATON.AudioHub._listener&&m._camera.children.length<1&&m._camera.add(ATON.AudioHub._listener),m._updCamera(),m._controls.update(),m._currPOV&&m.syncCurrCamera(),ATON._onResize(),ATON.toggleCenteredQuery(!1),ATON.fire("NavMode",m._mode)}},m.setFirstPersonControl=()=>{if(!ATON.XR.isPresenting()){if(m._prevMode=m._mode,ATON.SUI.getSelectorRadius()>.1&&ATON.SUI.setSelectorRadius(.1),m._mode=m.MODE_FP,m._bInteracting=!1,ATON.fire("NavInteraction",!1),void 0===m._cFirstPerson){m._camFP=new THREE.PerspectiveCamera(m.STD_FOV,window.innerWidth/window.innerHeight,m.STD_NEAR,m.STD_FAR),m._camFP.layers.enableAll(),m._cFirstPerson=new THREE.OrbitControls(m._camFP,ATON._renderer.domElement);let e=m._cFirstPerson;e.enableZoom=!1,e.enablePan=!1,e.rotateSpeed=m._rotSpeedFP,m._inertia>0&&(e.enableDamping=!0,e.dampingFactor=m._inertia),e.target.copy(m._camera.position),e.minDistance=.01,e.maxDistance=.01,m._bControl||(e.enabled=!1)}m._controls=m._cFirstPerson,m._camera=m._camFP,ATON.AudioHub._listener&&m._camera.children.length<1&&m._camera.add(ATON.AudioHub._listener),m._updCamera(),m._controls.update(),m._currPOV&&m.syncCurrCamera(),ATON._onResize(),ATON.toggleCenteredQuery(!1),ATON.fire("NavMode",m._mode)}},m.setDeviceOrientationControl=()=>{ATON.Utils.isMobile()&&(m._prevMode=m._mode,m._mode=m.MODE_DEVORI,m._bInteracting=!1,ATON.fire("NavInteraction",!1),ATON._screenPointerCoords.set(0,0),void 0===m._cDevOri&&(m._camDevOri=new THREE.PerspectiveCamera(m.STD_FOV,window.innerWidth/window.innerHeight,m.STD_NEAR,m.STD_FAR),m._camDevOri.layers.enableAll(),m._cDevOri=new _(m._camDevOri,ATON._renderer.domElement),m._cDevOri.alphaOffset=0),m._controls=m._cDevOri,m._camera=m._camDevOri,ATON.AudioHub._listener&&m._camera.children.length<1&&m._camera.add(ATON.AudioHub._listener),m._updCamera(),m._controls.update(),m._currPOV&&m.syncCurrCamera(),ATON._onResize(),ATON.toggleCenteredQuery(!0),ATON.fire("NavMode",m._mode))},m.useAbsoluteOrientation=e=>{m._cDevOri},m.setMotionAmount=e=>{m._motionAmt=e},m.setMotionDirection=e=>{m._motionDir.copy(e)},m.stop=()=>{m._motionAmt=0},m.setFOV=e=>{if(ATON.XR.isPresenting())return;m._currPOV.fov=e;let t=m._camera;t.fov=e,t.updateProjectionMatrix()},m.getFOV=()=>m._currPOV.fov,m._deltaMotions=()=>{m._dOri=m._lastOri.angleTo(ATON.Nav._qOri),m._dPos=m._lastPos.distanceToSquared(m._currPOV.pos),m._lastPos.copy(m._currPOV.pos),m._lastOri.copy(ATON.Nav._qOri)},m.syncCurrPOV=()=>{if(ATON.XR.isPresenting()){const e=ATON._renderer.xr.getCamera().cameras[0];return e&&(m._currPOV.pos.copy(e.position),m._qOri.copy(e.quaternion),e.getWorldDirection(m._vDir)),m._currPOV.pos.x+=ATON.XR.rig.position.x,m._currPOV.pos.y+=ATON.XR.rig.position.y,m._currPOV.pos.z+=ATON.XR.rig.position.z,void m._deltaMotions()}const e=m._controls,t=m._camera;if(t.getWorldDirection(m._vDir),t.getWorldQuaternion(m._qOri),m._deltaMotions(),m._mode!==m.MODE_DEVORI){if(m._mode===m.MODE_FP)return m._currPOV.pos.copy(e.target),m._currPOV.target.x=m._currPOV.pos.x+m._vDir.x,m._currPOV.target.y=m._currPOV.pos.y+m._vDir.y,void(m._currPOV.target.z=m._currPOV.pos.z+m._vDir.z);m._currPOV.pos.copy(t.position),m._currPOV.target.copy(e.target)}else m._currPOV.pos.copy(t.position)},m.applyPOVconstraints=e=>{},m.handlePOV=()=>{ATON.XR.isPresenting()?m.handleXRtransition():m.handlePOVtransition(),m.handleMotion(),m.applyPOVconstraints(m._currPOV)},m.handleMotion=()=>{if(m.isTransitioning())return;if(0==m._motionAmt)return;ATON.XR.controller0&&ATON.XR.controller0.visible?(ATON.XR.controller0.getWorldDirection(m._motionDir),m._motionDir.negate()):m._motionDir.copy(m._vDir);let e=m._motionAmt*ATON._dt,t=m._motionDir.x*e,o=m._motionDir.y*e,i=m._motionDir.z*e;m._currPOV.pos.x+=t,m._currPOV.pos.y+=o,m._currPOV.pos.z+=i,m._currPOV.target.x+=t,m._currPOV.target.y+=o,m._currPOV.target.z+=i},m.handlePOVtransition=()=>{if(!(m._tPOVcall<0)){if(m.POVtransitionDuration<=0?m._tPOVprogress=1:m._tPOVprogress=(ATON._clock.elapsedTime-m._tPOVcall)/m.POVtransitionDuration,m._tPOVprogress>=1)return m._tPOVcall=-1,m._currPOV.pos.copy(m._reqPOV.pos),m._currPOV.target.copy(m._reqPOV.target),m._currPOV.fov=m._reqPOV.fov,void ATON.fire("POVTransitionCompleted",m._reqPOV.id);var e;m._tPOVprogress=(e=m._tPOVprogress,(1-Math.cos(e*Math.PI))/2),m._currPOV.pos.lerpVectors(m._fromPOV.pos,m._reqPOV.pos,m._tPOVprogress),m._currPOV.target.lerpVectors(m._fromPOV.target,m._reqPOV.target,m._tPOVprogress),m._fromPOV.fov&&m._reqPOV.fov&&(m._currPOV.fov=THREE.MathUtils.lerp(m._fromPOV.fov,m._reqPOV.fov,m._tPOVprogress),m._camera.fov=m._currPOV.fov,m._camera.updateProjectionMatrix())}},m.handleXRtransition=()=>{if(!(m._tPOVcall<0)){if(m.POVtransitionDuration<=0?m._tPOVprogress=1:m._tPOVprogress=(ATON._clock.elapsedTime-m._tPOVcall)/m.POVtransitionDuration,m._tPOVprogress>=1)return m._tPOVcall=-1,ATON.XR._currPos.copy(ATON.XR._reqPos),void ATON.fire("POVTransitionCompleted",m._reqPOV.id);ATON.XR._currPos.lerpVectors(ATON.XR._fromPos,ATON.XR._reqPos,m._tPOVprogress)}},m.syncCurrCamera=()=>{if(ATON.XR.isPresenting())return;let e=m._controls,t=m._camera,o=m._currPOV.pos,i=m._currPOV.target;m._mode!==m.MODE_DEVORI?(m._vDir.subVectors(i,o),m._vDir.normalize(),m._mode===m.MODE_FP?(e.target.copy(o),t.position.x=e.target.x-m._vDir.x*m.FP_EPS,t.position.y=e.target.y-m._vDir.y*m.FP_EPS,t.position.z=e.target.z-m._vDir.z*m.FP_EPS):(t.position.copy(o),e.target.copy(i))):t.position.copy(o)},m.update=()=>{m.syncCurrPOV(),m.handlePOV(),m.syncCurrCamera()},m.requestPOV=(e,t,o)=>{ATON._tPOVcall>=0||void 0!==e&&(ATON.XR._bPresenting&&"immersive-ar"===ATON.XR._sessionType||(m.POVtransitionDuration=void 0!==t?t:m.STD_POV_TRANS_DURATION,ATON.XR.isPresenting()?(m._reqPOV.pos.copy(e.pos?e.pos:m._currPOV.pos),m._fromPOV.pos.copy(m._currPOV.pos),ATON.XR._reqPos.copy(e.pos?e.pos:m._currPOV.pos),ATON.XR._fromPos.copy(ATON.XR._currPos)):(m._reqPOV.pos.copy(e.pos?e.pos:m._currPOV.pos),m._reqPOV.target.copy(e.target?e.target:m._currPOV.target),m._reqPOV.fov=e.fov?e.fov:m._currPOV.fov,m._fromPOV.pos.copy(m._currPOV.pos),m._fromPOV.target.copy(m._currPOV.target),m._fromPOV.fov=m._currPOV.fov),o&&(e.pos&&(m._reqPOV.pos.x*=ATON._worldScale,m._reqPOV.pos.y*=ATON._worldScale,m._reqPOV.pos.z*=ATON._worldScale,ATON.XR.isPresenting()&&(ATON.XR._reqPos.x*=ATON._worldScale,ATON.XR._reqPos.y*=ATON._worldScale,ATON.XR._reqPos.z*=ATON._worldScale)),e.target&&(m._reqPOV.target.x*=ATON._worldScale,m._reqPOV.target.y*=ATON._worldScale,m._reqPOV.target.z*=ATON._worldScale)),m._tPOVcall=ATON._clock.elapsedTime,ATON.fire("POVTransitionRequested",e.id)))},m.requestPOVbyBound=(e,t)=>{if(void 0===e)return;let o=new THREE.Vector3,i=3*e.radius;o.x=e.center.x-i*m._vDir.x,o.y=e.center.y-i*m._vDir.y,o.z=e.center.z-i*m._vDir.z;let r=(new ATON.POV).setPosition(o).setTarget(e.center);m.requestPOV(r,t)},m.requestPOVbyNode=(e,t)=>{if(void 0===e)return;let o=e.getBound();m.requestPOVbyBound(o,t)},m.requestPOVbyID=(e,t)=>{if(void 0===e)return;let o=m.povlist[e];void 0!==o&&m.requestPOV(o,t)},m.requestRetarget=(e,t,o)=>{let i=new THREE.Vector3;if(void 0===t)i.lerpVectors(e,m._currPOV.pos,.8);else{let o=e.distanceTo(m._currPOV.pos);o*=.5,i.x=e.x+t.x*o,i.y=e.y+t.y*o,i.z=e.z+t.z*o}let r=e.distanceTo(i);ATON.FX.setDOFfocus(r);let a=(new ATON.POV).setPosition(i).setTarget(e).setFOV(m._currPOV.fov);m.requestPOV(a,o),console.log(a)},m.computeDefaultHome=(e,t)=>{void 0===e&&(e=new THREE.Vector3(1,.7,1)),void 0===t&&(t=ATON.getRootScene().getBound());let o=new THREE.Vector3(t.center.x+t.radius*e.x*1.5,t.center.y+t.radius*e.y*1.5,t.center.z+t.radius*e.z*1.5);m.homePOV=(new ATON.POV).setPosition(o).setTarget(t.center)},m.setHomePOV=e=>{m.homePOV=e},m.computeAndRequestDefaultHome=(e,t,o)=>{m.computeDefaultHome(t,o),m.requestPOV(m.homePOV,e)},m.requestHomePOV=e=>{m.requestPOV(m.homePOV,e)},m.requestHome=m.requestHomePOV,m.setAndRequestHomePOV=(e,t)=>{m.setHomePOV(e),m.requestPOV(e,t)},m.clear=()=>{m.clearPOVs(),m.clearLocomotionNodes()},m.DeviceOrientationControls=function(e){let t=this;this.object=e,this.object.rotation.reorder("YXZ"),this.enabled=!0,this.deviceOrientation={},this.screenOrientation=0,this.alphaOffset=0,this.absolute=!1,this.alphaOffsetDevice=void 0,this.alphaOffsetScreen=void 0;let o=function(e){t.absolute||(t.deviceOrientation=e)},i=function(e){t.deviceOrientation=e,t.absolute=!0},r=function(){t.screenOrientation=window.orientation||0},a=function(){let e=new THREE.Vector3(0,0,1),t=new THREE.Euler,o=new THREE.Quaternion,i=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));return function(r,a,n,s,l){t.set(n,a,-s,"YXZ"),r.setFromEuler(t),r.multiply(i),r.multiply(o.setFromAxisAngle(e,-l))}}();this.connect=function(){r(),window.addEventListener("orientationchange",r,!1),window.addEventListener("deviceorientation",o,!1),window.addEventListener("deviceorientationabsolute",i,!1),t.enabled=!0},this.disconnect=function(){window.removeEventListener("orientationchange",r,!1),window.removeEventListener("deviceorientation",o,!1),window.removeEventListener("deviceorientationabsolute",i,!1),t.enabled=!1},this.update=function(){if(!1===t.enabled)return;let e;if(e=t.deviceOrientation,e){let o=this.getDirection()?THREE.Math.degToRad(this.getDirection())+t.alphaOffset:0,i=e.beta?THREE.Math.degToRad(e.beta):0,r=e.gamma?THREE.Math.degToRad(e.gamma):0,n=t.screenOrientation?THREE.Math.degToRad(t.screenOrientation):0;a(t.object.quaternion,o,i,r,n)}},this.dispose=()=>{t.disconnect()},this.iOSOrientationPermission=()=>{"function"==typeof DeviceOrientationEvent.requestPermission&&DeviceOrientationEvent.requestPermission().then(e=>{console.log(e)}).catch(console.error)},this.getDirection=()=>void 0!==t.deviceOrientation.webkitCompassHeading?t.deviceOrientation.webkitCompassHeading:t.deviceOrientation.alpha,this.getDirectionMap=()=>void 0!==t.deviceOrientation.webkitCompassHeading?360-t.deviceOrientation.webkitCompassHeading:t.deviceOrientation.alpha,this.connect()};const h=m;let T={STD_TELEP_DURATION:.03,HAND_R:0,HAND_L:1,HAND_PRIMARY:0,HAND_SECONDARY:1,LOW_DENSITY_F:.5,MAX_QUERY_DISTANCE:40,init:()=>{ATON._renderer.xr.enabled=!0,ATON._renderer.xr.setReferenceSpaceType("local"),T.setDensity(1),T._bPresenting=!1,T.currSession=null,T._sessionType="immersive-vr",T._bReqPresenting=!1,T.rig=new THREE.Group,T.rig.add(ATON.Nav._camera),ATON._rootUI.add(T.rig),T._cam=void 0,T._currPos=T.rig.position,T._fromPos=new THREE.Vector3,T._reqPos=new THREE.Vector3,T.setupControllers(),T._urlHand=ATON.PATH_RES+"models/hand/hand.glb",ATON.on("XRselectStart",e=>{e===T.HAND_R&&ATON._stdActivation()}),ATON.on("XRselectEnd",e=>{}),ATON.on("XRsqueezeStart",e=>{e===T.HAND_R&&ATON.Photon.setFocusStreaming(!0)}),ATON.on("XRsqueezeEnd",e=>{e===T.HAND_R&&ATON.Photon.setFocusStreaming(!1)}),ATON.on("VRC_IDassigned",e=>{T.setControllersMaterial(ATON.Photon.getAvatarMaterialByUID(e))})},setDensity:e=>{void 0!==ATON._renderer.xr&&(ATON.device.isMobile||ATON.device.lowGPU?ATON._renderer.xr.setFramebufferScaleFactor(e*ATON.XR.LOW_DENSITY_F):ATON._renderer.xr.setFramebufferScaleFactor(e))},setupControllers:()=>{T.gControllers=ATON.createUINode(),T.gControllers.disablePicking(),T.rig.add(T.gControllers);const e=ATON._renderer.xr;T._bGaze=!0,T.controller0=e.getController(0),T.gControllers.add(T.controller0),T.setupBaseController(T.controller0),T.controller1=e.getController(1),T.gControllers.add(T.controller1),T.setupBaseController(T.controller1),T.controller0.userData.pos=new THREE.Vector3,T.controller1.userData.pos=new THREE.Vector3,T.controller0.userData.dir=new THREE.Vector3(0,1,0),T.controller1.userData.dir=new THREE.Vector3(0,1,0),T.controllerModelFactory=new THREE.XRControllerModelFactory(null,()=>{void 0!==ATON.Photon.uid?T.setControllersMaterial(ATON.Photon.getAvatarMaterialByUID(ATON.Photon.uid)):T.setControllersMaterial(ATON.MatHub.materials.controllerRay)}),T.handModelFactory=new THREE.XRHandModelFactory(null,()=>{void 0!==ATON.Photon.uid?T.setControllersMaterial(ATON.Photon.getAvatarMaterialByUID(ATON.Photon.uid)):T.setControllersMaterial(ATON.MatHub.materials.controllerRay)}),T._lastPosR=void 0,T._lastPosL=void 0,T.controllerGrip0=e.getControllerGrip(0),T.controllerGrip0.add(T.controllerModelFactory.createControllerModel(T.controllerGrip0)),T.gControllers.add(T.controllerGrip0),T.hand0=e.getHand(0),T.hand0.add(T.handModelFactory.createHandModel(T.hand0)),T.gControllers.add(T.hand0),T.controllerGrip1=e.getControllerGrip(1),T.controllerGrip1.add(T.controllerModelFactory.createControllerModel(T.controllerGrip1)),T.gControllers.add(T.controllerGrip1),T.hand1=e.getHand(1),T.hand1.add(T.handModelFactory.createHandModel(T.hand1)),T.gControllers.add(T.hand1),T._pointerLineGeom=void 0,T._pointerLineMesh=void 0,T._cPrimary=T.controller0,T._cSecondary=T.controller1},setControllersMaterial:e=>{T.controllerGrip0.traverse(t=>{t.isMesh&&(t.material=e)}),T.controllerGrip1.traverse(t=>{t.isMesh&&(t.material=e)})},setupBaseController:e=>{e.userData.isConnected=!1,e.addEventListener("connected",t=>{e.userData.isConnected=!0;const o=t.data;if(e.userData.hand=o.handedness,e.userData.gm=o.gamepad,"gaze"!==o.targetRayMode)return"tracked-pointer"===o.targetRayMode?(T._bGaze=!1,e.userData.hand?void("left"===e.userData.hand?(T.setupControllerAsSecondary(e),ATON.fire("XRcontrollerConnected",T.HAND_L),console.log("Secondary Controller")):(T.setupControllerAsPrimary(e),ATON.fire("XRcontrollerConnected",T.HAND_R),console.log("Primary Controller"))):void T.setupControllerAsPrimary(e)):void 0;T._bGaze=!0}),e.addEventListener("disconnected",t=>{e.userData.isConnected=!1}),e.addEventListener("selectstart",()=>{ATON.fire("XRselectStart",T.getControllerHand(e))}),e.addEventListener("selectend",()=>{ATON.fire("XRselectEnd",T.getControllerHand(e))}),e.addEventListener("squeezestart",()=>{ATON.fire("XRsqueezeStart",T.getControllerHand(e))}),e.addEventListener("squeezeend",()=>{ATON.fire("XRsqueezeEnd",T.getControllerHand(e))})},getControllerHand:e=>{let t=T.HAND_R;return e.userData.hand&&"left"===e.userData.hand?T.HAND_L:t},setupControllerAsPrimary:e=>{e.userData.isPrimary=!0,T._cPrimary=e,T._pointerLineGeom=new THREE.CylinderGeometry(.003,.003,1,4),T._pointerLineGeom.rotateX(-Math.PI/2),T._pointerLineGeom.translate(0,0,-.5),T._pointerLineMesh=new THREE.Mesh(T._pointerLineGeom,ATON.MatHub.materials.controllerRay),e.add(T._pointerLineMesh),T._pointerLineMesh.visible=!1},setupControllerAsSecondary:e=>{e.userData.isPrimary=!1,T._cSecondary=e},getPrimaryController:()=>T._cPrimary,getSecondaryController:()=>T._cSecondary,setSessionType:e=>{void 0===e&&(e="immersive-vr"),T._sessionType=e,console.log("Session type: "+e)},isPresenting:()=>T._bPresenting,setupARLightEstimation:()=>{T._arEstLight=new THREE.XREstimatedLight(ATON._renderer),T._arEstLP=void 0,T._arEstLight.addEventListener("estimationstart",()=>{ATON._rootVisible.add(T._arEstLight),T._arEstLight.environment&&(ATON._rootVisible.setEnvMap(T._arEstLight.environment),ATON._dMainL&&ATON._dMainL.visible&&(ATON._dMainL.visible=!1),T._arEstLP=window.setInterval(()=>{ATON.updateLightProbes()},1e3))}),T._arEstLight.addEventListener("estimationend",()=>{ATON._rootVisible.remove(T._arEstLight),ATON._dMainL&&ATON._dMainL.visible&&(ATON._dMainL.visible=!0),window.clearInterval(T._arEstLP)})},teleportOnQueriedPoint:()=>{if(!ATON.Nav.currentQueryValidForLocomotion())return!1;const e=ATON._queryDataScene.p;return ATON.Nav.requestPOV((new ATON.POV).setPosition(e.x,e.y+ATON.userHeight,e.z),T.STD_TELEP_DURATION),!0},setupQueryRay:e=>{void 0!==e&&(T.controller0.userData.isConnected||T.controller1.userData.isConnected?T.controller0.userData.isPrimary?e.set(T.controller0.userData.pos,T.controller0.userData.dir):e.set(T.controller1.userData.pos,T.controller1.userData.dir):e.set(ATON.Nav.getCurrentEyeLocation(),ATON.Nav.getCurrentDirection()))},setRefSpaceLocation:e=>{T.rig.position.copy(e)},setupSceneForAR:()=>{if("immersive-ar"!==T._sessionType)return;ATON.recomputeSceneBounds();let e=ATON.bounds.center;ATON._rootVisible.position.x=-e.x,ATON._rootVisible.position.y=-e.y,ATON._rootVisible.position.z=-e.z,ATON._rootSem.position.x=-e.x,ATON._rootSem.position.y=-e.y,ATON._rootSem.position.z=-e.z,ATON.recomputeSceneBounds()},resetSceneOffsets:()=>{ATON._rootVisible.position.set(0,0,0),ATON._rootSem.position.set(0,0,0),ATON.recomputeSceneBounds()},onSessionStarted:e=>{T.currSession||(T._bReqPresenting=!1,e.addEventListener("end",T.onSessionEnded),console.log(T._sessionType+" session started."),"immersive-ar"===T._sessionType?ATON._renderer.xr.setReferenceSpaceType("local"):e.isImmersive=!0,ATON._renderer.xr.setSession(e).then(()=>{T.currSession=e,console.log(T.currSession),"immersive-ar"===T._sessionType?(ATON.UI.ARoverlay.style.display="",ATON._mainRoot.background=null,ATON._mMainPano&&(ATON._mMainPano.visible=!1)):(T.rig.add(ATON.Nav._camera),T.setRefSpaceLocation(ATON.Nav._currPOV.pos));let t=ATON._renderer.xr.getCamera(ATON.Nav._camera);t&&ATON.Nav._updCamera(t),T._bPresenting=!0,ATON.Nav._bInteracting=!1,console.log("XR now presenting"),ATON.toggleShadows(!1),ATON.SUI.getSelectorRadius()>.1&&ATON.SUI.setSelectorRadius(.1),ATON._qSyncInt=2,ATON.XPFNetwork.getNumXPFs()>0?ATON.setQueryRange(0,100):ATON.setQueryRange(0,T.MAX_QUERY_DISTANCE),ATON.MRes.estimateTSErrorTarget(),ATON.fire("XRmode",!0)}))},onSessionEnded:()=>{T.currSession.removeEventListener("end",T.onSessionEnded),T.currSession=null,T._bReqPresenting=!1,T._bPresenting=!1,ATON.Nav._bInteracting=!1,"immersive-ar"===T._sessionType&&(ATON._mMainPano&&(ATON._mMainPano.visible=!0),ATON.UI.ARoverlay.style.display="none"),T.setRefSpaceLocation(new THREE.Vector3(0,0,0)),ATON._qSyncInt=1,ATON.MediaFlow.stopAllStreams(),ATON.Nav.requestHome(),ATON.Nav._updCamera(),ATON.setQueryRange(0,1/0),ATON.MRes.estimateTSErrorTarget(),console.log("Quit XR"),ATON.fire("XRmode",!1)},toggle:e=>{if(T.setSessionType(e),null===T.currSession){T._bReqPresenting=!0;let e={optionalFeatures:[]};"immersive-ar"===T._sessionType&&(ATON.UI.setupARoverlay(),e.optionalFeatures.push("dom-overlay"),e.domOverlay={root:ATON.UI.ARoverlay}),navigator.xr.requestSession(T._sessionType,e).then(T.onSessionStarted)}else T.currSession.end()},setupControllerUI:(e,t)=>{let o,i;if(e===T.HAND_L?(T.gControllers.add(T.controller1),t&&(i=ATON.createUINode("Lhand").load(T._urlHand).setMaterial(ATON.MatHub.materials.controllerRay).setScale(-1,1,1),T.controller1.add(i))):(T.gControllers.add(T.controller0),t&&(T._pointerLineGeom=new THREE.CylinderGeometry(.003,.003,1,4),T._pointerLineGeom.rotateX(-Math.PI/2),T._pointerLineGeom.translate(0,0,-.5),T._pointerLineMesh=new THREE.Mesh(T._pointerLineGeom,ATON.MatHub.materials.controllerRay),T.controller0.add(T._pointerLineMesh),T._pointerLineMesh.visible=!1,o=ATON.createUINode("Rhand").load(T._urlHand).setMaterial(ATON.MatHub.materials.controllerRay),T.controller0.add(o))),void 0!==ATON.Photon.uid&&t){let t=ATON.MatHub.materials.avatars,r=t[ATON.Photon.uid%t.length];e===T.HAND_L?i.setMaterial(r):o.setMaterial(r)}},getControllerSpace:e=>1===e?T.controllerGrip1:T.controllerGrip0,getControllerWorldLocation:e=>e===T.HAND_PRIMARY?T._cPrimary.userData.pos:T._cSecondary.userData.pos,getControllerWorldDirection:e=>e===T.HAND_PRIMARY?T._cPrimary.userData.dir:T._cSecondary.userData.dir,getControllerWorldOrientation:e=>{let t=new THREE.Quaternion;return e===T.HAND_PRIMARY?T._cPrimary.getWorldQuaternion(t):T._cSecondary.getWorldQuaternion(t),t},update:()=>{T._bGaze||(T.controller0&&T.controller0.visible&&(T.controller0.getWorldPosition(T.controller0.userData.pos),T.controller0.getWorldDirection(T.controller0.userData.dir),T.controller0.userData.dir.negate()),T.controller1&&T.controller1.visible&&(T.controller1.getWorldPosition(T.controller1.userData.pos),T.controller1.getWorldDirection(T.controller1.userData.dir),T.controller1.userData.dir.negate()))},getAxisValue:e=>{let t=new THREE.Vector2(0,0);const o=(e===T.HAND_PRIMARY?T.getPrimaryController():T.getSecondaryController()).userData.gm;if(!o||!o.axes)return t;let i=o.axes[0],r=o.axes[2],a=o.axes[1],n=o.axes[3];return t.x=i>0?-i:r,t.y=a>0?a:-n,t}};const v=T,g=class extends t{constructor(e,t,o){super(e,ATON.NTYPES.UI),this.baseColor=ATON.MatHub.colors.black,this.baseOpacity=.5,this.container=new ThreeMeshUI.Block({width:t||.2,height:o||.05,padding:.001,borderRadius:.01,backgroundColor:this.baseColor,backgroundOpacity:this.baseOpacity,fontFamily:ATON.SUI.PATH_FONT_JSON,fontTexture:ATON.SUI.PATH_FONT_TEX,justifyContent:"center",textAlign:"center"}),this.container.position.z=.03,this.add(this.container),this.uiText=new ThreeMeshUI.Text({content:"Label",fontSize:.03,fontColor:ATON.MatHub.colors.white}),this.container.add(this.uiText),ThreeMeshUI.update()}setBaseColor(e){return this.baseColor=e,this.container.set({backgroundColor:this.baseColor}),ThreeMeshUI.update(),this}setTextColor(e){return this.uiText.set({fontColor:e}),ThreeMeshUI.update(),this}setBackgroundOpacity(e){return this.container.set({backgroundOpacity:e}),this.baseOpacity=e,ThreeMeshUI.update(),this}setText(e){return this.uiText.set({content:e}),ThreeMeshUI.update(),this}};let N={STD_BTN_SIZE:.1,STD_SELECTOR_TICKNESS:1.05};N.Button=class extends t{constructor(e,t=1,o=1){super(e,ATON.NTYPES.UI),this.baseColor=ATON.MatHub.colors.black,this.switchColor=ATON.MatHub.colors.green,this.baseOpacity=.5,this.hoverOpacity=.8,this._bSwitched=!1,this.container=new ThreeMeshUI.Block({width:.1*t,height:.1,padding:.01,borderRadius:.02,backgroundColor:this.baseColor,backgroundOpacity:this.baseOpacity,fontFamily:ATON.SUI.PATH_FONT_JSON,fontTexture:ATON.SUI.PATH_FONT_TEX,justifyContent:"center",textAlign:"center"}),this.add(this.container),this.uiText=new ThreeMeshUI.Text({content:"",fontSize:.02*o,fontColor:ATON.MatHub.colors.white}),this.container.add(this.uiText);let i=.9*ATON.SUI.STD_BTN_SIZE*t,r=.9*ATON.SUI.STD_BTN_SIZE;this._trigger=new THREE.Mesh(new THREE.PlaneGeometry(i,r,2),ATON.MatHub.materials.fullyTransparent),this._trigger.position.set(0,0,.002),this.add(this._trigger),this.onHover=()=>{this.container.set({backgroundOpacity:this.hoverOpacity})},this.onLeave=()=>{this.container.set({backgroundOpacity:this.baseOpacity})},this.enablePicking(),this.traverse(e=>{e.material&&(e.material.depthWrite=!1)}),ThreeMeshUI.update()}setBaseColor(e){return this.baseColor=e,this._bSwitched||this.container.set({backgroundColor:this.baseColor}),ThreeMeshUI.update(),this}setSwitchColor(e){return this.switchColor=e,this._bSwitched&&this.container.set({backgroundColor:this.switchColor}),ThreeMeshUI.update(),this}setBackgroundOpacity(e){return this.container.set({backgroundOpacity:e}),this.baseOpacity=e,ThreeMeshUI.update(),this}setText(e){return this.uiText.set({content:e}),ThreeMeshUI.update(),this}switch(e){return this._bSwitched=e,e?this.container.set({backgroundColor:this.switchColor}):this.container.set({backgroundColor:this.baseColor}),ThreeMeshUI.update(),this}setIcon(e,t){return ATON.Utils.textureLoader.load(e,e=>{this._trigger.material=new THREE.MeshStandardMaterial({map:e,transparent:!0,depthWrite:!1}),t&&(this.setBackgroundOpacity(0),this.hoverOpacity=0),this.uiText.position.set(0,-.035,0)}),ThreeMeshUI.update(),this}},N.Label=g,N.MediaPanel=class extends t{constructor(e){super(e,ATON.NTYPES.UI),this._resurl=void 0,this._mediamesh=void 0,this._vs=void 0,this._yratio=1,this._titleYoffs=.6,this._color=ATON.MatHub.colors.black;let t=this;this.onSelect=()=>{t._vs&&t._vs.el}}load(e,t){this._yratio=1,this._mediamesh||(this._mediamesh=new THREE.Mesh(new THREE.PlaneGeometry(1,1)),this.add(this._mediamesh)),e=ATON.Utils.resolveCollectionURL(e);let o=this;return ATON.Utils.isVideo(e)?(this._vs=ATON.MediaFlow.getOrCreateVideoStream(this.nid,e,!1),this._mediamesh.material=this._vs.matStream,this._vs.el.addEventListener("loadedmetadata",i=>{o._yratio=o._vs.el.videoHeight/o._vs.el.videoWidth,o._mediamesh.scale.y=-o._yratio,o._resurl=e,o._onContentLoad(),t&&t()})):ATON.Utils.loadTexture(e,i=>{i.image&&(this._yratio=i.image.height/i.image.width),o._mediamesh.scale.y=o._yratio,o._mediamesh.material=ATON.MatHub.materials.chromakey.clone(),o._mediamesh.material.uniforms.tBase.value=i,o._mediamesh.material.needsUpdate=!0,o._resurl=e,o._onContentLoad(),t&&t()}),this.enablePicking(),this}setColor(e){return this._color=e,this._labelTitle&&this._labelTitle.setBaseColor(e),this._bd&&(this._bd.material.color=e),this}getMaterial(){return this._mediamesh.material}_onContentLoad(){this._labelTitle&&(this._labelTitle.position.y=this._yratio*this._titleYoffs),this._bd&&(this._bd.scale.y=1.05*this._yratio)}setTitle(e){return this._labelTitle||(this._labelTitle=new g(void 0,.5,.07),this._labelTitle.position.z=-.01,this._labelTitle.attachTo(this)),this._labelTitle.setText(e),this._labelTitle.setBaseColor(this._color),this}toggleTitle(e){return this._labelTitle?(this._labelTitle.toggle(e),this):this}setBackdrop(e){return this._bd=new THREE.Mesh(new THREE.PlaneGeometry(1,1)),this._bd.material=new THREE.MeshStandardMaterial({transparent:!0,side:THREE.DoubleSide,color:this._color,opacity:e||.5}),this._bd.scale.x=1.05,this._bd.scale.y=1.05*this._yratio,this._bd.position.z=-.005,this.add(this._bd),this}},N.init=()=>{N.initSelector(),N.fpTeleport=ATON.createUINode();let e=new THREE.CylinderGeometry(.4,.4,.9,32,1,!0),t=new THREE.Mesh(e,ATON.MatHub.getMaterial("teleportLoc"));t.renderOrder=100,N.fpTeleport.add(t),N.fpTeleport.disablePicking(),N.fpTeleport.visible=!1,ATON._rootUI.add(N.fpTeleport),N.PATH_FONT_JSON||(N.PATH_FONT_JSON=ATON.PATH_RES+"fonts/custom-msdf.json"),N.PATH_FONT_TEX||(N.PATH_FONT_TEX=ATON.PATH_RES+"fonts/custom.png"),N.gMeasures=ATON.createUINode(),N._prevMPoint=void 0,N._measLabels=[],ATON._rootUI.add(N.gMeasures);let o=(new THREE.BufferGeometry).setFromPoints([new THREE.Vector3,new THREE.Vector3]);N._measLine=new THREE.Line(o,ATON.MatHub.getMaterial("measurement")),N._measLine.visible=!1,ATON._rootUI.add(N._measLine),N.gPoints=ATON.createUINode(),ATON._rootUI.add(N.gPoints),N.gLocNodes=ATON.createUINode(),ATON._rootUI.add(N.gLocNodes),N.buildInfoNode(),N.bShowInfo=!0,N._labelScale=ATON.Utils.isMobile()?80:90,N._labelScaleVR=2,N.sprites={},N._sync=0},N.getOrCreateSpritePointEdit=()=>(N.sprites.pointEdit||(N.sprites.pointEdit=new THREE.SpriteMaterial({map:(new THREE.TextureLoader).load(ATON.PATH_RES+"sui-point.png"),color:ATON.MatHub.colors.orange,transparent:!0,opacity:1,depthTest:!1})),N.sprites.pointEdit),N.getOrCreateSpriteSemIcon=()=>(N.sprites.semIcon||(N.sprites.semIcon=new THREE.SpriteMaterial({map:(new THREE.TextureLoader).load(ATON.PATH_RES+"sui-sem.png"),transparent:!0,opacity:1,depthWrite:!1,depthTest:!1})),N.sprites.semIcon),N.getOrCreateSpriteLP=()=>(N.sprites.lp||(N.sprites.lp=new THREE.SpriteMaterial({map:(new THREE.TextureLoader).load(ATON.PATH_RES+"sui-lp.png"),transparent:!0,opacity:1,depthWrite:!1}),N.sprites.lp.sizeAttenuation=!1),N.sprites.lp),N.getOrCreateSpriteWalk=()=>(N.sprites.walk||(N.sprites.walk=new THREE.SpriteMaterial({map:(new THREE.TextureLoader).load(ATON.PATH_RES+"sui-walk.png"),transparent:!0,opacity:1,depthWrite:!1})),N.sprites.walk),N.initSelector=()=>{N.mainSelector=ATON.createUINode(),N._mSelectorSphere=new THREE.Mesh(ATON.Utils.geomUnitSphere,ATON.MatHub.getMaterial("selector")),N._mSelectorSphere.renderOrder=100,N.mainSelector.add(N._mSelectorSphere),N.mainSelector.disablePicking(),N.setSelectorRadius(.05),N.mainSelector.visible=!1,ATON._rootUI.add(N.mainSelector),N._selOffset=new THREE.Vector3,N._bShowSelector=!0},N.enableLPIcons=()=>{N.gLPIcons=ATON.createUINode(),N.gLPIcons.disablePicking(),ATON._rootUI.add(N.gLPIcons)},N.enableSemIcons=()=>{N.gSemIcons=ATON.createUINode(),N.gSemIcons.disablePicking(),ATON._rootUI.add(N.gSemIcons)},N.showSelector=e=>{N._bShowSelector=e},N.setSelectorRadius=e=>{N._selectorRad=e,N.mainSelector.scale.set(e,e,e)},N.setSelectorOffset=(e,t,o)=>{void 0!==e&&(N._selOffset.x=e),void 0!==t&&(N._selOffset.y=t),void 0!==o&&(N._selOffset.z=o);let i=ATON.getSceneQueriedPoint();void 0!==i&&(N.mainSelector.position.x=i.x+N._selOffset.x,N.mainSelector.position.y=i.y+N._selOffset.y,N.mainSelector.position.z=i.z+N._selOffset.z)},N.getSelectorRadius=()=>N._selectorRad,N.getSelectorLocation=()=>N.mainSelector.position,N.setSelectorModel=(e,t)=>{void 0!==e&&(N.mainSelector.removeChildren(),N.mainSelector.load(e).disablePicking(),t&&N.mainSelector.setMaterial(ATON.MatHub.getMaterial("selector")))},N.setSelectorColor=(e,t)=>{let o=ATON.MatHub.materials.selector;o.uniforms.tint.value=e,void 0!==t&&(o.uniforms.opacity.value=t)},N.addSemIcon=(e,t)=>{if(void 0===N.gSemIcons)return;let o=(new THREE.Box3).setFromObject(t),i=new THREE.Sphere;o.getBoundingSphere(i);let r=new THREE.Sprite(N.getOrCreateSpriteSemIcon());r.position.copy(i.center),r.scale.set(.8,.8,1),r.name=e,N.gSemIcons.add(r)},N.addLPIcon=e=>{if(void 0===N.gLPIcons)return;let t=e._near,o=new THREE.Sprite(N.getOrCreateSpriteLP());o.position.copy(e.pos),o.scale.set(.1,.1,.1);let i=new THREE.Mesh(ATON.Utils.geomUnitSphere,ATON.MatHub.materials.lp);i.scale.set(t,t,t),i.position.copy(e.pos),N.gLPIcons.add(o),N.gLPIcons.add(i)},N.setSemIconsOpacity=e=>{ATON.MatHub.spriteSemIcon.opacity=void 0===e?1:e},N.buildInfoNode=()=>{N.infoNode=ATON.createUINode(),N.infoNode.attachToRoot(),N.infoContainer=new ThreeMeshUI.Block({width:.2,height:.05,padding:.01,borderRadius:.02,backgroundColor:ATON.MatHub.colors.black,backgroundOpacity:.4,fontFamily:N.PATH_FONT_JSON,fontTexture:N.PATH_FONT_TEX,justifyContent:"center",textAlign:"center"}),N.infoContainer.position.y=.03,N.infoNode.add(N.infoContainer),N.infoNodeText=new ThreeMeshUI.Text({content:"Info",fontSize:.02,fontColor:ATON.MatHub.colors.white}),N.infoContainer.add(N.infoNodeText),ThreeMeshUI.update()},N.getInfoNode=()=>N.infoNode,N.setInfoNodeText=e=>{N.bShowInfo&&(N.infoNodeText.set({content:e}),ThreeMeshUI.update())},N.createToolbar=(e,t,o,i=1.1)=>{let r=ATON.createUINode(),a=e.length,n=.3*N.STD_BTN_SIZE,s=new ThreeMeshUI.Block({width:N.STD_BTN_SIZE*a*i+n,height:N.STD_BTN_SIZE+n,padding:.01,borderRadius:.02,backgroundColor:t||ATON.MatHub.colors.black,backgroundOpacity:void 0!==o?o:.3,fontFamily:N.PATH_FONT_JSON,fontTexture:N.PATH_FONT_TEX,justifyContent:"center",textAlign:"center",contentDirection:"row-reverse"}),l=.5*a*N.STD_BTN_SIZE*i;l-=.5*N.STD_BTN_SIZE;for(let t=0;t<a;t++){let o=e[t];o&&(o.position.set(t*N.STD_BTN_SIZE*i-l,0,.005),s.add(o))}return r.add(s),ThreeMeshUI.update(),r},N.buildPanelNode=(e,t,o,i)=>{void 0===o&&(o=1),void 0===i&&(i=1);let r=ATON.createUINode(e),a=new THREE.Mesh(new THREE.PlaneGeometry(o,i,2),ATON.MatHub.materials.fullyTransparent);return r.add(a),void 0!==t&&ATON.Utils.textureLoader.load(t,e=>{a.material=new THREE.MeshStandardMaterial({map:e,transparent:!0,depthWrite:!1,side:THREE.DoubleSide})}),r},N.createLayout=(e,t)=>{let o=e.children.length;for(let i=0;i<o;i++)t(e.children[i],i);return ThreeMeshUI.update(),e},N.addMeasurementPoint=e=>{if(void 0===e)return;let t=.01,o=.001;if(void 0===N._prevMPoint){N._prevMPoint=e;let t=N._measLine.geometry.attributes.position.array;return t[0]=e.x,t[1]=e.y,void(t[2]=e.z)}N._measLine.visible=!1;let i=N._prevMPoint.distanceTo(e);t*=i,o*=i;let r=new THREE.Mesh(ATON.Utils.geomUnitCube,ATON.MatHub.getMaterial("measurement"));r.position.copy(N._prevMPoint),r.scale.set(t,t,t),N.gMeasures.add(r);let a=new THREE.Mesh(ATON.Utils.geomUnitCube,ATON.MatHub.getMaterial("measurement"));a.position.copy(e),a.scale.set(t,t,t),N.gMeasures.add(a);let n=2*i,s=(new THREE.BufferGeometry).setFromPoints([N._prevMPoint,e]);N.gMeasures.add(new THREE.Line(s,ATON.MatHub.getMaterial("measurement")));let l=new N.Label;l.setBaseColor(ATON.MatHub.colors.white).setTextColor(ATON.MatHub.colors.black),l.userData.vStart=new THREE.Vector3,l.userData.vEnd=new THREE.Vector3,l.userData.vStart.copy(N._prevMPoint),l.userData.vEnd.copy(e),l.userData.vSEdir=new THREE.Vector3,l.userData.vSEdir.x=l.userData.vStart.x-l.userData.vEnd.x,l.userData.vSEdir.y=l.userData.vStart.y-l.userData.vEnd.y,l.userData.vSEdir.z=l.userData.vStart.z-l.userData.vEnd.z,l.userData.vSEdir.normalize(),l.setPosition(.5*(N._prevMPoint.x+e.x),.5*(N._prevMPoint.y+e.y),.5*(N._prevMPoint.z+e.z)),l.setScale(n).setText(ATON.Utils.getHumanReadableDistance(i)),N.gMeasures.add(l),N._measLabels.push(l);let d={};return d.A=l.userData.vStart,d.B=l.userData.vEnd,N._prevMPoint=void 0,d},N.clearMeasurements=()=>{N.gMeasures.removeChildren(),N._measLabels=[]},N._updateMeasurements=()=>{if(!(N._measLabels.length<=0))for(let e in N._measLabels)N._measLabels[e].orientToCamera()},N.update=()=>{if(ATON.Nav.isTransitioning()||ATON._bPauseQuery)N.infoNode.visible=!1;else{if(N._prevMPoint){if(ATON._queryDataScene){let e=N._measLine.geometry.attributes.position.array;e[3]=ATON._queryDataScene.p.x,e[4]=ATON._queryDataScene.p.y,e[5]=ATON._queryDataScene.p.z,N._measLine.geometry.attributes.position.needsUpdate=!0}N._measLine.visible=!0}else N._measLine.visible=!1;if(ATON._queryDataScene&&!ATON.Nav._bInteracting?(N._bShowSelector&&(N.mainSelector.visible=!0),N.mainSelector.position.x=ATON._queryDataScene.p.x+N._selOffset.x,N.mainSelector.position.y=ATON._queryDataScene.p.y+N._selOffset.y,N.mainSelector.position.z=ATON._queryDataScene.p.z+N._selOffset.z):N.mainSelector.visible=!1,N.gSemIcons&&(ATON.Nav._bInteracting?N.gSemIcons.hide():void 0===ATON._hoveredSemNode&&N.gSemIcons.show()),ATON.Nav.isOrbit()&&!ATON.XR._bPresenting||!ATON.Nav.currentQueryValidForLocomotion()?N.fpTeleport.visible=!1:(N.fpTeleport.visible=!0,N.fpTeleport.position.copy(ATON._queryDataScene.p)),ATON.XR._pointerLineMesh){let e=0;ATON._queryDataScene&&(e=ATON._queryDataScene.d),ATON._queryDataUI&&(e<=0||ATON._queryDataUI.d<e)&&(e=ATON._queryDataUI.d,N.mainSelector.visible=!1,N.fpTeleport.visible=!1),e>0?(ATON.XR._pointerLineMesh.visible=!0,ATON.XR._pointerLineMesh.scale.set(1,1,e)):ATON.XR._pointerLineMesh.visible=!1}if(N._updateMeasurements(),ATON._queryDataSem){if(ATON.XR._bPresenting){if(N.bShowInfo&&(N.infoNode.visible=!0),ATON.XR._bGaze)N.infoNode.position.lerpVectors(ATON._queryDataSem.p,ATON.Nav._currPOV.pos,.1),N.infoNode.setScale(ATON._queryDataSem.d*N._labelScaleVR);else{let e=ATON.XR.getPrimaryController();e&&(N.infoNode.position.copy(e.userData.pos),N.infoNode.position.x-=.1*e.userData.dir.x,N.infoNode.position.y-=.1*e.userData.dir.y,N.infoNode.position.z-=.1*e.userData.dir.z,N.infoNode.setScale(1))}N.infoNode.orientToCamera()}ATON.Photon._bStreamFocus||(N.mainSelector.visible=!1)}else if(ATON.XR._bPresenting&&N.bShowInfo&&ATON._queryDataScene&&void 0!==ATON.XPFNetwork._semCurr){N.infoNode.position.lerpVectors(ATON._queryDataScene.p,ATON.Nav._currPOV.pos,.5);const e=ATON._queryDataScene.d*(ATON.Nav._currPOV.fov/N._labelScale);N.infoNode.setScale(e),N.infoNode.orientToCamera(),N.infoNode.visible=!0}else N.infoNode.visible=!1;if(N.mainSelector.visible&&ATON.Photon._bStreamFocus){let e=N._selectorRad*(1+.2*Math.cos(10*ATON._clock.elapsedTime));N.mainSelector.scale.set(e,e,e);let t=ATON.getSceneFocalPoint();void 0!==t&&void 0!==ATON.plight&&(ATON.enablePointLight(),ATON.plight.position.copy(t),ATON.plight.distance=2*N._selectorRad)}}};const S=N;let O={};O._parser=new DOMParser,O.COMP_ATTR="data-aton-comp",O.SCENES_SORTER=(e,t)=>{let o=new Date(e.creationDate),i=new Date(t.creationDate);return o&&i?o>i?-1:i>o?1:0:0},O.init=()=>{window.bootstrap&&window.bootstrap.Offcanvas&&(O.PATH_RES_ICONS=ATON.PATH_RES+"icons/",O._bModal=!1,O._bSidePanel=!1,O._bSemL=!1,O._bReqHome=!1,O._setupBase())},O.setTheme=e=>{document.body.setAttribute("data-bs-theme",e)},O.createElementFromHTMLString=e=>O._parser.parseFromString(e,"text/html").body.firstElementChild,O.get=e=>document.getElementById(e),O.onContextMenu=()=>!1,O._setupBase=()=>{document.body.oncontextmenu=O.onContextMenu,O.setTheme("dark"),O.elCenteredOverlay=O.createElementFromHTMLString('\n        <div class="d-flex align-items-center justify-content-center aton-centered-container">\n            <div class="spinner-border aton-spinner" role="status"><span class="visually-hidden">Loading...</span></div>\n        </div>\n\t'),document.body.append(O.elCenteredOverlay),O.hideCenteredOverlay(),O.elLabelCon=document.createElement("div"),O.elLabelCon.classList.add("aton-floating-label-container"),O.elLabel=document.createElement("div"),O.elLabel.classList.add("aton-floating-label"),O.elLabelCon.append(O.elLabel),document.body.prepend(O.elLabelCon),O.hideSemLabel(),O.elModal=O.createElementFromHTMLString('\n        <div class="modal fade modal-fullscreen-md-down" id="staticBackdrop" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">\n            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">\n                <div class="modal-content aton-std-bg" id="uiModalContent"></div>\n            </div>\n        </div>\n\t'),O.modal=new bootstrap.Modal(O.elModal),document.body.append(O.elModal),O.elModalContent=document.getElementById("uiModalContent"),O.elSidePanel=O.createElementFromHTMLString('\n        <div class="offcanvas offcanvas-end aton-std-bg aton-sidepanel" tabindex="-1"></div>\n\t'),O.sidepanel=new bootstrap.Offcanvas(O.elSidePanel),document.body.append(O.elSidePanel),O.setupARoverlay()},O.setupARoverlay=()=>{if(O.ARoverlay)return;O.ARoverlay=ATON.UI.createContainer(),O.ARoverlay.style.display="none",document.body.appendChild(O.ARoverlay);const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("width",38),e.setAttribute("height",38),e.style.position="absolute",e.style.right="20px",e.style.top="20px",e.addEventListener("click",()=>{ATON.XR.currSession&&ATON.XR.currSession.end()}),O.ARoverlay.appendChild(e);const t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttribute("d","M 12,12 L 28,28 M 28,12 12,28"),t.setAttribute("stroke","#fff"),t.setAttribute("stroke-width",2),e.appendChild(t)},O.showCenteredOverlay=e=>{O.elCenteredOverlay.classList.add("d-flex"),O.elCenteredOverlay.classList.remove("d-none")},O.hideCenteredOverlay=()=>{O.elCenteredOverlay.classList.remove("d-flex"),O.elCenteredOverlay.classList.add("d-none")},O.showModal=e=>{if(e){if(O.elModalContent.innerHTML="",e.header){let t=document.createElement("div");t.classList.add("modal-header"),t.innerHTML="<h4 class='modal-title' id='staticBackdropLabel'>"+e.header+"</h4><button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close' onclick='ATON.UI.hideModal()'></button>",O.elModalContent.append(t)}if(e.body){let t=document.createElement("div");t.classList.add("modal-body"),t.append(e.body),O.elModalContent.append(t)}if(e.footer){let t=document.createElement("div");t.classList.add("modal-footer"),t.append(e.footer),O.elModalContent.append(t)}O.modal.show(),O._bModal=!0}},O.hideModal=()=>{O.elModalContent.innerHTML="",O.modal.hide(),O._bModal=!1},O.showSidePanel=e=>{if(e||(e={}),O.elSidePanel.innerHTML="",e.header){let t=document.createElement("div");t.classList.add("offcanvas-header"),t.innerHTML="<h4 class='offcanvas-title' id='staticBackdropLabel'>"+e.header+"</h4><button type='button' class='btn-close' aria-label='Close' onclick='ATON.UI.hideSidePanel()'></button>",e.headelement&&t.prepend(e.headelement),O.elSidePanel.append(t)}if(e.body){let t=document.createElement("div");t.classList.add("offcanvas-body"),t.append(e.body),O.elSidePanel.append(t)}O.sidepanel.show(),O._bSidePanel=!0},O.hideSidePanel=()=>{O.sidepanel.hide(),O._bSidePanel=!1},O.setSidePanelLeft=()=>{O.elSidePanel.classList.remove("offcanvas-end"),O.elSidePanel.classList.add("offcanvas-start")},O.setSidePanelRight=()=>{O.elSidePanel.classList.remove("offcanvas-start"),O.elSidePanel.classList.add("offcanvas-end")},O.showElement=e=>{e.classList.remove("d-none")},O.hideElement=e=>{e.classList.add("d-none")},O.toggleElement=(e,t)=>{t?O.showElement(e):O.hideElement(e)},O.addBasicEvents=()=>{let e=document.querySelector("canvas");ATON.on("NodeRequestFired",()=>{O.showCenteredOverlay()}),ATON.on("AllNodeRequestsCompleted",()=>{O.hideCenteredOverlay(),O._bReqHome||(ATON.Nav.homePOV||ATON.Nav.computeAndRequestDefaultHome(.5),ATON.Nav.requestHomePOV(.2),O._bReqHome=!0)}),ATON.on("SemanticNodeHover",t=>{let o=ATON.getSemanticNode(t);void 0!==o&&(O.showSemLabel(t),o.highlight(),e.style.cursor="pointer",ATON.SUI.gSemIcons&&ATON.SUI.gSemIcons.hide())}),ATON.on("SemanticNodeLeave",t=>{let o=ATON.getSemanticNode(t);void 0!==o&&(O.hideSemLabel(),o.restoreDefaultMaterial(),e.style.cursor="grab",ATON.SUI.gSemIcons&&ATON.SUI.gSemIcons.show())}),ATON.on("SemanticMaskHover",t=>{O.showSemLabel(t),e.style.cursor="pointer"}),ATON.on("SemanticMaskLeave",t=>{O.hideSemLabel(),e.style.cursor="grab"}),ATON.addUpdateRoutine(O.update)},O.update=()=>{if(O._bSemL&&!ATON.XR._bPresenting){let e=.5*ATON._screenPointerCoords.x*window.innerWidth,t=.5*(1-ATON._screenPointerCoords.y)*window.innerHeight;t-=35,O.elLabel.style.transform="translate("+e+"px, "+t+"px)"}},O.showSemLabel=e=>{O.elLabel.innerHTML=e,O.elLabel.style.display="inline-block",O._bSemL=!0},O.hideSemLabel=()=>{O.elLabel.style.display="none",O._bSemL=!1},O.loadPartial=(e,t,o,i)=>{fetch(e).then(e=>e.text()).then(e=>{let i=O.createElementFromHTMLString(e);t?o?document.getElementById(t).prepend(i):document.getElementById(t).append(i):o?document.body.prepend(i):document.body.append(i)}).catch(e=>`Error fetching partial: ${e}`),i&&i()},O.resolveIconURL=e=>e.includes("/")?e:O.PATH_RES_ICONS+e+".png",O.createIcon=e=>e.startsWith("bi-")?O.createElementFromHTMLString("<i class='bi "+e+"' style='font-size:1.5em; vertical-align:middle;'></i>"):O.createElementFromHTMLString("<img class='icon aton-icon' src='"+O.resolveIconURL(e)+"'>"),O.prependIcon=(e,t)=>{e.prepend(O.createIcon(t))},O.createSceneCoverIMG=e=>{let t=document.createElement("img");return t.src=ATON.PATH_RESTAPI2+"scenes/"+e+"/cover",t.onerror=()=>{t.src=ATON.PATH_RES+"scenecover.png"},t},O.createContainer=e=>{let t="";e&&(e.id&&(t+=` id="${e.id}"`),e.classes&&(t+=` class="${e.classes}"`),e.style&&(t+=` style="${e.style}"`));let o=O.createElementFromHTMLString(`<div${t}></div>`);if(e&&e.items)for(let t in e.items)e.items[t]&&o.append(e.items[t]);return o},O.registerElementAsComponent=(e,t)=>{e.setAttribute(O.COMP_ATTR,t)},O.getComponent=(e,t)=>{if(!e)return;let o=e.querySelectorAll("["+O.COMP_ATTR+"='"+t+"']");return o?o[0]:void 0},O.createButton=e=>{let t=document.createElement("button");return t.classList.add("btn","aton-btn"),t.setAttribute("type","button"),e.variant&&t.classList.add("btn-"+e.variant),e.text&&(t.innerHTML="<span class='aton-btn-text'>"+e.text+"</span>"),e.icon&&O.prependIcon(t,e.icon),e.size&&("large"===e.size&&t.classList.add("btn-lg"),"small"===e.size&&t.classList.add("btn-sm")),e.badge&&t.append(O.createElementFromHTMLString("<span class='position-absolute top-0 start-100 translate-middle badge rounded-pill'>"+e.badge+"</span>")),e.onpress&&(t.onclick=e.onpress),e.classes&&(t.className=t.className+" "+e.classes),e.tooltip&&t.setAttribute("title",e.tooltip),t},O.createButtonHome=e=>{const t={icon:"home",tooltip:"Go home",onpress:()=>{ATON.Nav.requestHome(.3)}};return O.createButton({...t,...e})},O.createButtonFullscreen=e=>{const t={icon:"fullscreen",tooltip:"Fullscreen",onpress:()=>{ATON.toggleFullScreen()}},o=O.createButton({...t,...e});return ATON.on("Fullscreen",e=>{e?o.classList.add("aton-btn-highlight"):o.classList.remove("aton-btn-highlight")}),o},O.createButtonBack=e=>{const t={icon:"back",tooltip:"Go back",onpress:()=>{history.back()}};return O.createButton({...t,...e})},O.createButtonVR=e=>{const t={icon:"vr",tooltip:"Immersive VR",onpress:()=>{ATON.XR.toggle("immersive-vr")}};let o=O.createButton({...t,...e});return ATON.device.xrSupported["immersive-vr"]||ATON.UI.hideElement(o),ATON.on("XR_support",e=>{ATON.device.xrSupported["immersive-vr"]&&ATON.UI.showElement(o)}),o},O.createButtonAR=e=>{const t={icon:"ar",tooltip:"Augmented Reality",onpress:()=>{ATON.XR.toggle("immersive-ar")}};let o=O.createButton({...t,...e});return ATON.device.xrSupported["immersive-ar"]||ATON.UI.hideElement(o),ATON.on("XR_support",e=>{ATON.device.xrSupported["immersive-ar"]&&ATON.UI.showElement(o)}),o},O.createButtonDeviceOrientation=e=>{const t={icon:"devori",tooltip:"Device Orientation",onpress:()=>{ATON.Nav.isDevOri()?ATON.Nav.restorePreviousNavMode():ATON.Nav.setDeviceOrientationControl()}};let o=O.createButton({...t,...e});return ATON.Utils.isConnectionSecure()&&ATON.Utils.isMobile()||ATON.UI.hideElement(o),o},O.createButtonQR=e=>(e||(e={}),O.createButton({icon:"qr",text:e.text,onpress:()=>{let t=e.url?e.url:window.location.href,o=ATON.UI.createContainer({classes:"aton-QR-container"});new QRCode(o,t),O.showModal({header:e.title?e.title:"QR code",body:ATON.UI.createContainer({style:"text-align:center",items:[o,e.content]})})}})),O.createButtonUser=e=>{let t;e||(e={});let o=O.createElementFromHTMLString("<span class='aton-btn-text'></span>");o.classList.add("d-none");const i=e=>{e?(t.classList.add("btn-accent"),o.innerHTML=e,o.classList.remove("d-none")):(t.classList.remove("btn-accent"),o.innerHTML="",o.classList.add("d-none"))};return t=ATON.UI.createButton({icon:"bi-person-fill",onpress:()=>{e.onmodalopen&&e.onmodalopen(),ATON.checkAuth(t=>{let o=ATON.UI.createContainer(),r=ATON.UI.createContainer({classes:"d-grid gap-2"});r.append(ATON.UI.createButton({text:"Logout",icon:"exit",classes:"btn-accent",onpress:()=>{ATON.REQ.logout(),O.hideModal(),i(),e.onlogout&&e.onlogout()}})),e.modallogged&&o.append(e.modallogged),o.append(r),ATON.UI.showModal({header:e.titlelogged?e.titlelogged:t.username,body:o})},()=>{i(),ATON.UI.showModal({header:e.titlelogin?e.titlelogin:"Authentication",body:ATON.UI.createLoginForm({onSuccess:t=>{O.hideModal(),i(t.username),e.onlogin&&e.onlogin()},onFail:()=>{}})})})}}),t.append(o),ATON.checkAuth(e=>{i(e.username)}),t},O.createDropdown=e=>{e.title||(e.title="Dropdown");let t=ATON.UI.createContainer({classes:"dropdown"}),o=O.createElementFromHTMLString(`\n        <button type="button" class="btn aton-btn dropdown-toggle px-2" data-bs-toggle="dropdown" aria-expanded="false"><span class="aton-btn-text">${e.title}</span></button>\n    `);if(e.variant&&o.classList.add("btn-"+e.variant),e.icon&&O.prependIcon(o,e.icon),t.append(o),e.items){let o=document.createElement("ul");o.classList.add("dropdown-menu","aton-dropdown-menu"),e.align&&"right"===e.align&&o.classList.add("dropdown-menu-sm-end"),e.dropdownclasses&&(o.className=o.className+" "+e.dropdownclasses);for(let t=0;t<e.items.length;t++){let i,r=e.items[t];r.el?(i=O.createContainer({classes:"dropdown-item aton-dropdown-item"}),i.append(r.el)):i=O.createElementFromHTMLString(`\n                <a class="dropdown-item aton-dropdown-item" href="${r.url}">${r.title}</a>\n            `);let a=document.createElement("li");a.append(i),o.append(a),r.icon&&O.prependIcon(i,r.icon)}t.append(o)}return e.btnclasses&&(o.className=o.className+" "+e.btnclasses),e.classes&&(t.className=t.className+" "+e.classes),t},O.createTabsGroup=e=>{if(!e.items)return;let t=ATON.Utils.generateID("tabgroup"),o=document.createElement("div"),i=document.createElement("ul");i.classList.add("nav","nav-justified","nav-tabs"),i.setAttribute("role","tablist");let r=document.createElement("div");r.classList.add("tab-content"),o.append(i),o.append(r);for(let o=0;o<e.items.length;o++){let a=e.items[o],n=a.title?a.title:"",s=a.content,l=a.icon,d=a.classes,c="";l&&(c="<img class='icon aton-icon aton-icon-small' src='"+O.resolveIconURL(l)+"'>");let u,p=t+"-"+o,_=document.createElement("li");_.classList.add("nav-item"),_.setAttribute("role","presentation"),_.innerHTML=0===o?"<button class='nav-link aton-tab active' id='"+p+"-tab' data-bs-toggle='pill' data-bs-target='#"+p+"' type='button' role='tab' aria-controls='"+p+"' aria-selected='true'>"+c+n+"</button>":"<button class='nav-link aton-tab' id='"+p+"-tab' data-bs-toggle='pill' data-bs-target='#"+p+"' type='button' role='tab' aria-controls='"+p+"'>"+c+n+"</button>",i.append(_),u=0===o?O.createElementFromHTMLString("<div class='tab-pane show active' id='"+p+"' role='tabpanel' aria-labelledby='"+p+"-tab'></div>"):O.createElementFromHTMLString("<div class='tab-pane show' id='"+p+"' role='tabpanel' aria-labelledby='"+p+"-tab'></div>"),u.style.padding="10px 0px 10px 0px",s&&u.append(s),r.append(u),d&&(_.className=_.className+" "+d)}return o},O.createTreeGroup=e=>{if(!e.items)return;let t=ATON.Utils.generateID("tree"),o=document.createElement("div");o.classList.add("aton-tree-container");for(let i=0;i<e.items.length;i++){let r,a,n=e.items[i],s=n.title,l=n.content;if(s){if(r=document.createElement("details"),r.classList.add("aton-tree-item"),n.open&&r.setAttribute("open",!0),r.id=t+"-"+i,r.append(O.createElementFromHTMLString("<summary>"+s+"</summary>")),l){let e=document.createElement("div");e.classList.add("aton-tree-item-content"),e.append(l),r.append(e)}}else r=ATON.UI.createContainer(),l&&(a=ATON.UI.createContainer(),a.append(l),r.append(a));o.append(r)}return o},O.createVectorControl=e=>{let t,o=ATON.Utils.generateID("vec3");e.vector&&(t=e.vector);let i=.01;e.step&&(i=e.step);let r=t?t.x:0,a=t?t.y:0,n=t?t.z:0,s=O.createElementFromHTMLString(`\n        <div class="input-group mb-3">\n            <input type="number" class="form-control aton-input-x" placeholder="x" aria-label="x" step="${i}" value="${r}">\n            <input type="number" class="form-control aton-input-y" placeholder="y" aria-label="y" step="${i}" value="${a}">\n            <input type="number" class="form-control aton-input-z" placeholder="z" aria-label="z" step="${i}" value="${n}">\n        </div>\n    `);if(e.label&&s.prepend(ATON.UI.createElementFromHTMLString("<span class='input-group-text'>"+e.label+"</span>")),e.reset){let o=e.reset;s.append(ATON.UI.createButton({icon:"cancel",classes:"btn-default",onpress:()=>{l.value=o[0],d.value=o[1],c.value=o[2],t&&t.set(o[0],o[1],o[2]),e.onupdate&&e.onupdate()}}))}s.id=o;let l=s.children[0],d=s.children[1],c=s.children[2];l.oninput=()=>{let o=l.value;t&&(t.x=o),e.onupdate&&e.onupdate()},d.oninput=()=>{let o=d.value;t&&(t.y=o),e.onupdate&&e.onupdate()},c.oninput=()=>{let o=c.value;t&&(t.z=o),e.onupdate&&e.onupdate()};let u=o=>{o.preventDefault();let i=o.clipboardData.getData("text");i=i.split(","),3===i.length&&(l.value=parseFloat(i[0]),d.value=parseFloat(i[1]),c.value=parseFloat(i[2]),t&&(t.set(l.value,d.value,c.value),e.onupdate&&e.onupdate()))};return l.onpaste=u,d.onpaste=u,c.onpaste=u,s},O.createQuaternionControl=e=>{let t,o=ATON.Utils.generateID("vec3");e.quat&&(t=e.quat);let i=.01;e.step&&(i=e.step);let r=t?t.x:0,a=t?t.y:0,n=t?t.z:0,s=t?t.w:0,l=O.createElementFromHTMLString(`\n        <div class="input-group mb-3">\n            <input type="number" class="form-control" placeholder="x" aria-label="x" step="${i}" value="${r}">\n            <input type="number" class="form-control" placeholder="y" aria-label="y" step="${i}" value="${a}">\n            <input type="number" class="form-control" placeholder="z" aria-label="z" step="${i}" value="${n}">\n            <input type="number" class="form-control" placeholder="w" aria-label="w" step="${i}" value="${s}">\n        </div>\n    `);if(e.label&&l.prepend(ATON.UI.createElementFromHTMLString("<span class='input-group-text'>"+e.label+"</span>")),e.reset){let t=e.reset;l.append(ATON.UI.createButton({icon:"cancel",classes:"btn-default",onpress:()=>{d.value=t[0],c.value=t[1],u.value=t[2],p.value=t[3],V&&V.set(t[0],t[1],t[2],t[3]),e.onupdate&&e.onupdate()}}))}l.id=o;let d=l.children[0],c=l.children[1],u=l.children[2],p=l.children[3];d.oninput=()=>{let o=d.value;t&&(t.x=o),e.onupdate&&e.onupdate()},c.oninput=()=>{let o=c.value;t&&(t.y=o),e.onupdate&&e.onupdate()},u.oninput=()=>{let o=u.value;t&&(t.z=o),e.onupdate&&e.onupdate()},p.oninput=()=>{let o=p.value;t&&(t.w=o),e.onupdate&&e.onupdate()};let _=o=>{o.preventDefault();let i=o.clipboardData.getData("text");i=i.split(","),3===i.length&&(d.value=parseFloat(i[0]),c.value=parseFloat(i[1]),u.value=parseFloat(i[2]),p.value=parseFloat(i[3]),t&&(t.set(d.value,c.value,u.value,p.value),e.onupdate&&e.onupdate()))};return d.onpaste=_,c.onpaste=_,u.onpaste=_,p.onpaste=_,l},O.createNodeTrasformControl=e=>{let t,o=ATON.Utils.generateID("ftrans"),i=document.createElement("div");if(i.id=o,e.node&&(t=ATON.getSceneNode(e.node)),e.position){let o=O.createVectorControl({vector:t.position,step:e.position.step,reset:[0,0,0]});i.append(O.createElementFromHTMLString("<label class='form-label hathor-text-block' for='"+o.id+"'>Position</label>")),i.append(o)}if(e.scale){let o=O.createVectorControl({vector:t.scale,step:e.scale.step,reset:[1,1,1]});i.append(O.createElementFromHTMLString("<label class='form-label hathor-text-block' for='"+o.id+"'>Scale</label>")),i.append(o)}if(e.rotation){let o=O.createVectorControl({vector:t.rotation,step:e.rotation.step,reset:[0,0,0]});i.append(O.createElementFromHTMLString("<label class='form-label hathor-text-block' for='"+o.id+"'>Rotation</label>")),i.append(o)}return i},O.createCard=e=>{let t="card aton-card ";e.classes&&(t+=e.classes);let o=ATON.UI.createContainer({classes:t});"small"===e.size&&o.classList.add("aton-card-small"),"large"===e.size&&o.classList.add("aton-card-large");let i="";if(e.keywords){for(let t in e.keywords)i+=t+" ";i=i.trim().toLowerCase(),o.setAttribute("data-search-term",i)}if(e.cover){if(e.useblurtint){let t=document.createElement("div");t.classList.add("aton-card-bg"),t.style.backgroundImage="url('"+e.cover+"')",o.append(t)}let t=ATON.UI.createElementFromHTMLString("<div class='aton-card-cover'></div>"),i=document.createElement("img");if(i.classList.add("card-img-top"),i.src=e.cover,e.stdcover&&(i.onerror=()=>{i.src=e.stdcover}),e.onactivate)t.append(i),t.onclick=e.onactivate;else if(e.url){let o=ATON.UI.createElementFromHTMLString(`<a href='${e.url}'></a>`);o.append(i),t.append(o)}O.registerElementAsComponent(i,"img"),o.append(t)}let r=document.createElement("div");r.classList.add("card-body","aton-card-body"),O.registerElementAsComponent(r,"body"),o.append(r);let a=document.createElement("div");if(a.classList.add("card-title","aton-card-title"),a.innerHTML="Title",r.append(a),O.registerElementAsComponent(a,"title"),e.title&&(a.innerHTML=e.title,i+=" "+e.title.trim().toLowerCase(),o.setAttribute("data-search-term",i)),e.subtitle){let t=ATON.UI.createElementFromHTMLString("<div class='card-subtitle mb-2 text-body-secondary'></div>");t.append(e.subtitle),O.registerElementAsComponent(t,"subtitle"),r.append(t)}if(e.footer){let t=document.createElement("div");t.classList.add("card-footer"),t.append(e.footer),O.registerElementAsComponent(t,"footer"),r.append(t)}if(e.badge){let t=O.createElementFromHTMLString("<span class='position-absolute top-0 start-0 translate-middle aton-card-badge'></span>");t.append(e.badge),o.append(t)}return o},O.createSceneCard=e=>{let t,o,i=e.sid;i||(i="samples/welcome");let r=i.split("/");t=r[0],o=r[1];let a=e.keywords?e.keywords:{};a[t]=1;let n=e.subtitle;return n||(n=ATON.UI.createElementFromHTMLString(`\n            <div><img class='icon aton-icon aton-icon-small' src='${O.resolveIconURL("user")}'>${t}</div>\n        `)),ATON.UI.createCard({title:e.title?e.title:o,keywords:a,size:e.size,useblurtint:e.useblurtint,classes:e.classes,cover:ATON.PATH_RESTAPI2+"scenes/"+i+"/cover",url:e.url?e.url:ATON.PATH_FE+i,subtitle:n,footer:e.footer,badge:e.badge})},O.createLiveFilter=e=>{let t=ATON.Utils.generateID("filter"),o=t+"-input",i=document.createElement("form");i.id=t,i.classList.add("d-flex"),i.setAttribute("role","search");let r="Search";e.placeholder&&(r=e.placeholder);let a=O.createElementFromHTMLString(`<input class="form-control me-2 aton-input" type="search" placeholder="${r}" aria-label="Search" id="${o}" spellcheck="false" >`);O.registerElementAsComponent(a,"input");const n=document.createElement("div");return n.classList.add("input-group"),n.append(O.createElementFromHTMLString("<span class='input-group-text'><i class='bi bi-search'></i></span>")),n.append(a),e.oninput?a.oninput=e.oninput:a.oninput=()=>{if(!e.filterclass)return;let t=a.value.trim().toLowerCase(),o=document.querySelectorAll(`.${e.filterclass}`);if(t.length<3)for(let e of o)ATON.UI.showElement(e);else for(let e of o){let o=e.getAttribute("data-search-term");o&&(o.includes(t)||t.length<1)?ATON.UI.showElement(e):ATON.UI.hideElement(e)}},e.onfocus&&(a.onfocus=e.onfocus),e.onblur&&(a.onblur=e.onblur),i.append(n),i},O.createPublicScenesGallery=e=>{if(!e.containerid)return;let t=document.getElementById(e.containerid);if(!t)return;const o=o=>{o.sort(O.SCENES_SORTER),console.log(o);for(let i of o){let o=i.sid.startsWith("samples/");if(!o||o&&e.samples){let o=ATON.UI.createSceneCard({title:i.title?i.title:i.sid,sid:i.sid,showuser:!0,keywords:i.kwords,classes:e.classes,useblurtint:!0,size:e.size});t.append(o)}}};return e.entries?o(e.entries):ATON.REQ.get("scenes/",e=>o(e)),t},O.createOwnScenesGallery=e=>{if(!e.containerid)return;let t=document.getElementById(e.containerid);t&&ATON.checkAuth(o=>{ATON.REQ.get("scenes/"+o.username,o=>{o.sort(O.SCENES_SORTER),console.log(o);for(let i of o){let o=ATON.UI.createSceneCard({title:i.title?i.title:i.sid,sid:i.sid,keywords:i.kwords,useblurtint:!0,classes:e.classes,size:e.size});t.append(o)}})})},O.createKeyword=e=>{let t;return t=e.count?O.createElementFromHTMLString(`\n            <button type="button" class="btn btn-sm btn-outline-secondary aton-keyword">\n                ${e.term} <span class="badge text-bg-secondary">${e.count}</span>\n            </button>\n        `):O.createElementFromHTMLString(`\n            <button type="button" class="btn btn-sm btn-outline-secondary aton-keyword">${e.term}</button>\n        `),e.classes&&(t.className=t.className+" "+e.classes),e.onpress&&(t.onclick=e.onpress),t},O.createLayerControl=e=>{let t=e.node,o=ATON.getSceneNode(t),i=ATON.UI.createContainer({classes:"btn-group",style:"width:100%"}),r=ATON.UI.createButton({text:t,classes:"btn-default",onpress:e.mainaction?()=>{e.mainaction(t)}:void 0});o.visible||i.classList.add("aton-layer-hidden");const a=ATON.UI.createContainer({classes:"btn-group",style:"display:inline-block; margin-right:0px"});O.registerElementAsComponent(a,"actions"),i.append(a);const n=ATON.UI.createButton({icon:"visibility",classes:o.visible?"aton-btn-highlight":void 0,onpress:()=>{o.visible?(o.hide(),n.classList.remove("aton-btn-highlight"),i.classList.add("aton-layer-hidden")):(o.show(),n.classList.add("aton-btn-highlight"),i.classList.remove("aton-layer-hidden"))}});if(a.append(n),e.actions)for(let t in e.actions){let o=e.actions[t];a.append(o)}return i.append(r),i},O.createBasicLayersManager=e=>{let t=ATON.UI.createContainer();for(let e in root.children){const o=root.children[e];if(o.nid){let e=ATON.UI.createLayerControl({node:o.nid});t.append(e)}}return t},O.createSlider=e=>{let t,o,i=O.createContainer({classes:"aton-range-container"}),r=ATON.Utils.generateID("slider");e.label&&(o=O.createElementFromHTMLString("<label for='"+r+"' class='aton-range-label'><b>"+e.label+"</b>: </label>"),i.append(o),t=document.createElement("span"),o.append(t),e.value&&(t.innerText=e.value));let a=0,n=1,s=e.step?e.step:1;e.range&&(a=e.range[0],n=e.range[1]);let l=O.createElementFromHTMLString(`\n        <input type="range" class="aton-range aton-input" list="ticks-${r}" min="${a}" max="${n}" step="${s}" id="${r}">\n    `);return void 0!==e.value&&(l.value=e.value),e.classes&&(i.className=i.className+" "+e.classes),i.append(l),l.oninput=()=>{t&&(t.innerText=l.value),e.oninput&&e.oninput(l.value)},e.onchange&&(l.onchange=()=>{t&&(t.innerText=l.value),e.onchange(l.value)}),i},O.createInputText=e=>{let t=ATON.Utils.generateID("txtfield"),o=ATON.UI.createContainer({classes:"input-group"});o.id=t;let i="";e.label&&(i=e.label,o.append(O.createElementFromHTMLString("<span class='input-group-text'>"+i+"</span>")));let r=O.createElementFromHTMLString(`<input class="form-control aton-input" aria-label="${i}" type="search" spellcheck="false" >`);if(O.registerElementAsComponent(r,"input"),r.id=t+"-input",e.value&&(r.value=String(e.value)),e.placeholder&&r.setAttribute("placeholder",e.placeholder),e.oninput&&(r.oninput=()=>{e.oninput(r.value)}),e.onchange&&(r.onchange=()=>{e.onchange(r.value)}),o.append(r),e.list){const i=e.list;r.setAttribute("list",t+"-list");let a=O.createElementFromHTMLString("<datalist id='"+t+"-list'></datalist>");O.registerElementAsComponent(a,"datalist");for(let t in i){let o=i[t];e.listnames&&(o=e.listnames[t]),a.append(O.createElementFromHTMLString("<option value='"+i[t]+"'></option>"))}o.append(a)}return o},O.createInput3DModel=e=>{let t=ATON.UI.createContainer();return e||(e={}),ATON.checkAuth(o=>{ATON.REQ.get("items/"+o.username+"/models/",i=>{const r=i.map(e=>e.replace(o.username+"/models/",""));let a=ATON.UI.createInputText({label:e.label,placeholder:"3D model URL...",list:i,listnames:r,oninput:e.oninput,onchange:e.onchange});t.append(a);let n=a.getElementsByTagName("input")[0];a.append(ATON.UI.createButton({icon:e.actionicon?e.actionicon:"collection-item",text:e.actiontext,classes:"btn-default",onpress:()=>{e.onaction&&e.onaction(n.value),n.value=""}}))})}),t},O.createColorPicker=e=>{e||(e={});let t=ATON.UI.createContainer({classes:"input-group"}),o="";e.label&&(o=e.label,t.append(O.createElementFromHTMLString("<span class='input-group-text'>"+o+"</span>")));let i=O.createElementFromHTMLString(`<input class="form-control aton-input" aria-label="${o}" type="color">`);return O.registerElementAsComponent(i,"input"),t.append(i),e.color&&(i.value=e.color),e.onchange&&(i.onchange=()=>{e.onchange(i.value)}),e.oninput&&(i.oninput=()=>{e.oninput(i.value)}),t},O.createAudioRecorder=e=>{let t,o,i,r,a;return o=ATON.UI.createButton({icon:e.iconrec?e.iconrec:"rec",classes:"btn-default",text:e.textrec,tooltip:"Record new audio",onpress:()=>{ATON.MediaFlow.startRecording(),i.classList.remove("d-none"),o.classList.add("d-none"),r.setAttribute("disabled",!0)}}),i=ATON.UI.createButton({icon:"cancel",classes:"d-none btn-default aton-recording-bg",text:e.textrec,tooltip:"Stop recording audio",onpress:()=>{ATON.MediaFlow.stopRecording()}}),ATON.on("AudioRecordCompleted",t=>{t&&(a=new Audio,a.src=t,a.onended=e=>{r.classList.remove("aton-btn-highlight")},i.classList.add("d-none"),o.classList.remove("d-none"),r.removeAttribute("disabled"),e.onaudio&&e.onaudio(t))}),r=ATON.UI.createButton({icon:"play",tooltip:"Play recorded audio",text:e.textplay,classes:"btn-default",onpress:()=>{a&&(a.duration>0&&!a.paused?(a.pause(),a.currentTime=0,r.classList.remove("aton-btn-highlight")):(a.play(),r.classList.add("aton-btn-highlight")))}}),r.setAttribute("disabled",!0),t=ATON.UI.createContainer({classes:"btn-group"}),t.append(o,i,r),e.classes&&(t.className=t.className+" "+e.classes),t},O.createLoginForm=e=>{let t=document.createElement("form");t.classList.add("container-sm","text-center");let o=O.createElementFromHTMLString('<div class="input-group mb-4"><span class="input-group-text">Username</span></div>'),i=O.createElementFromHTMLString('<div class="input-group mb-4"><span class="input-group-text">Password</span></div>'),r=O.createElementFromHTMLString('<input id="uname" type="text" maxlength="30" class="form-control aton-input" aria-label="Username" aria-describedby="inputGroup-sizing-sm" placeholder="Username" spellcheck="false" >'),a=O.createElementFromHTMLString('<input id="passw" type="password" maxlength="30" class="form-control aton-input" aria-label="Password" aria-describedby="inputGroup-sizing-sm" placeholder="Password" spellcheck="false" >');o.append(r),i.append(a);let n=ATON.UI.createButton({text:"Login",icon:"bi-person-fill",variant:"accent",classes:"px-4",onpress:()=>{let t=r.value.trim(),o=a.value.trim();ATON.REQ.login(t,o,e.onSuccess,e.onFail)}});return e.header?t.append(e.header):t.append(O.createElementFromHTMLString('<i class="bi bi-person" style="font-size:3em;"></i>')),t.append(o),t.append(i),t.append(O.createContainer({items:[n],classes:"d-grid gap-2"})),t};const A=O;let b={USER_STATE_FREQ:.25,REPLICATED_EVT:"EREP",THRES_STATE_POS:.01,THRES_STATE_ORI:.08};b.Avatar=class extends t{constructor(e){super(void 0,ATON.NTYPES.UI),this.userid=e,this.username=void 0,this.message="...",this.color=ATON.Photon.ucolors[this.userid%ATON.Photon.ucolors.length],this._auTalk=[],this._auTalk.push(new THREE.PositionalAudio(ATON.AudioHub._listener)),this._auTalk.push(new THREE.PositionalAudio(ATON.AudioHub._listener));for(let e=0;e<2;e++)this._auTalk[e].setRefDistance(30),this._auTalk[e].setLoop(!1),this.add(this._auTalk[e]);this._auTalki=0,this.bMuted=!1,this._bPlayingAudio=!1,this._blob=void 0,this._b64=void 0,this._tStateCall=-1,this._tProgress=0,this._tFocCall=-1,this._currFocusPos=new THREE.Vector3,this._tgtFocusPos=new THREE.Vector3,this._currState={position:new THREE.Vector3,quaternion:new THREE.Quaternion,scale:1},this._tgtState={position:new THREE.Vector3,quaternion:new THREE.Quaternion,scale:1},this.userlabelnode=void 0,this.mStream=void 0,this._elVStream=void 0,this.realize()}getColor(){return this.color}setTalkDistance(e){e>0&&this._auTalk.setRefDistance(e)}setMuted(e){this.bMuted=e}getAvatarMaterialByUID(e){return ATON.Photon.getAvatarMaterialByUID(e)}_buildLabel(){this.userlabelnode=ATON.createUINode(),this.labelcontainer=new ThreeMeshUI.Block({width:.5,height:.2,padding:.03,borderRadius:.05,backgroundColor:ATON.MatHub.colors.black,fontFamily:ATON.SUI.PATH_FONT_JSON,fontTexture:ATON.SUI.PATH_FONT_TEX,justifyContent:"center",textAlign:"center"}),this.userlabelnode.position.y=.4,this.userlabelnode.add(this.labelcontainer),this.usernametext=new ThreeMeshUI.Text({content:"User #"+this.userid,fontSize:.07,fontColor:this.color}),this.usernametext.position.y=.01,this.labelcontainer.add(this.usernametext),this.add(this.userlabelnode),ThreeMeshUI.update()}realizeStreamPanel(){let e=ATON.MediaFlow.getOrCreateVideoStream(this.userid,void 0,!0);this._elVStream=e.el;let t=new THREE.PlaneGeometry(1,1);this.mStream=new THREE.Mesh(t,e.matStream),this.mStream.position.y=1;let o=.5625;this.mStream.scale.y=-o,this.mStream.position.y=.8*o,this._elVStream.addEventListener("loadedmetadata",e=>{o=this._elVStream.videoHeight/this._elVStream.videoWidth,this.mStream.scale.y=-o,this.mStream.position.y=.8*o})}getStreamPanel(){return this.mStream}toggleStreamPanel(e){void 0!==this.mStream&&(this.mStream.visible=e)}realize(){let e=new THREE.SphereGeometry(.2,16,16);ATON.Photon.customAvatarMaterial?this.usermaterial=ATON.Photon.customAvatarMaterial():this.usermaterial=ATON.Photon.getAvatarMaterialByUID(this.userid);let t=new THREE.Mesh(e,this.usermaterial);this.usermeshnode=ATON.createUINode(),this.usermeshnode.add(t),this.usermeshnode.setMaterial(this.usermaterial),this.usermeshnode.setCloneOnLoadHit(!1),this.add(this.usermeshnode),this.userauinode=new THREE.Sprite(ATON.Photon.uspritemats[this.userid%ATON.Photon.uspritemats.length]),this.userauinode.position.set(0,0,0),this.userauinode.visible=!1,this.add(this.userauinode),this.userfpnode=new THREE.Sprite(ATON.Photon.ufocmats[this.userid%ATON.Photon.ufocmats.length]),this.userfpnode.position.set(0,0,0),this.userfpnode.visible=!1,void 0===ATON.Photon._focNodes[this.userid]&&(ATON.Photon._focNodes[this.userid]=this.userfpnode,ATON.Photon.focGroup.add(this.userfpnode)),this._buildLabel()}loadRepresentation(e){let t=this;return void 0!==t.usermeshnode.children[0]&&t.usermeshnode.remove(t.usermeshnode.children[0]),t.usermeshnode.load(e),this}setUsername(e){return void 0===this.userlabelnode||(this.username=e,this.usernametext.set({content:e}),ThreeMeshUI.update()),this}getUsername(){if(void 0!==this.userid)return void 0===this.username?"User #"+this.userid:this.username}setMessage(e){if(void 0===this.userlabelnode)return this;this.message=e}setTalkVolume(e){if(void 0!==e)if(e>0){this.userauinode.visible=!0;let t=.1+.03*e;this.userauinode.scale.set(t,t,t)}else this.userauinode.visible=!1;else this.userauinode.visible=!1}hideFocalPoint(){this.userfpnode.visible=!1}requestFocus(e){if(void 0===e)return;if(this._tFocCall>=0)return;this._tFocCall=ATON._clock.elapsedTime,this._currFocusPos.copy(this.userfpnode.position);let t=this.scale.x*ATON._worldScale,o=parseFloat(e[0])*t,i=parseFloat(e[1])*t,r=parseFloat(e[2])*t,a=parseFloat(e[3])*t;this._tgtFocusPos.set(o,i,r),this._tgtFocusRad=2*a,this.userfpnode.scale.set(this._tgtFocusRad,this._tgtFocusRad,this._tgtFocusRad),this.userfpnode.visible=!0,ATON.enablePointLight(),ATON.plight.color=this.color,ATON.plight.position.copy(this._tgtFocusPos),ATON.plight.distance=this._tgtFocusRad}handleFocusTransition(){if(this._tFocCall<0)return;let e=ATON.Photon.USER_STATE_FREQ,t=(ATON._clock.elapsedTime-this._tFocCall)/e;if(t>=1)return this._tFocCall=-1,this.userfpnode.position.copy(this._tgtFocusPos),this.userfpnode.scale.set(this._tgtFocusRad,this._tgtFocusRad,this._tgtFocusRad),void(this.userfpnode.visible=!0);this.userfpnode.position.lerpVectors(this._currFocusPos,this._tgtFocusPos,t),ATON.plight.position.copy(this.userfpnode.position),this.userfpnode.visible=!0}requestStateTransition(e){this._tStateCall>=0||void 0!==e&&(this._tStateCall=ATON._clock.elapsedTime,this._currState.position.copy(this.position),this._currState.quaternion.copy(this.quaternion),this._currState.scale=this.scale,this._tgtState.position.copy(e.position),this._tgtState.quaternion.copy(e.quaternion),this._tgtState.scale=1/e.scale)}handleStateTransition(){if(this._tStateCall<0)return;let e=ATON.Photon.USER_STATE_FREQ;this._tProgress=e<=0?1:(ATON._clock.elapsedTime-this._tStateCall)/e;let t=this._currState,o=this._tgtState;if(this._tProgress>=1)return this._tStateCall=-1,this.position.copy(o.position),void this.usermeshnode.quaternion.copy(o.quaternion);this.position.lerpVectors(t.position,o.position,this._tProgress),this.usermeshnode.quaternion.slerp(o.quaternion,this._tProgress)}update(){if(this.handleStateTransition(),this.userfpnode&&this.userfpnode.visible){this.handleFocusTransition();let e=this.userfpnode.scale.x;e>.001?(this.userfpnode.scale.set(.99*e,.99*e,.99*e),ATON.plight.intensity*=.99):(this.userfpnode.visible=!1,ATON.disablePointLight())}let e=ATON.Nav._camera,t=ATON.Nav._currPOV.pos;if(void 0===e||void 0===t)return;this.userlabelnode&&this.userlabelnode.orientToCamera();let o=this.userauinode.scale.x;o*=.99,o>.01?this.userauinode.scale.set(o,o,o):this.userauinode.visible=!1}_handleTalk(){if(this._auTalk.isPlaying)return;if(this._auChunks.length<2)return;let e=this._auChunks[this._iAU];this._auTalk.setBuffer(e),this._auTalk.play(),this.setTalkVolume(5)}_handleTalkOLD(){if(this._bPlayingAudio)return;if(this._auChunks.length<1)return;let e=this._auChunks.shift();this._auTalk.setBuffer(e),this._auTalk.play(),this._bPlayingAudio=!0,this._auTalk.onended=()=>{this._bPlayingAudio=!1,e=null},this.setTalkVolume(5)}},b.CSTATE={DISCONNECTED:0,CONNECTING:1,CONNECTED:2},b.init=()=>{b.address=window.location.origin,b.initMaterials(),b.socket=void 0,b._cstate=b.CSTATE.DISCONNECTED,b._reqSSID=void 0,b._username=void 0,b.uid=void 0,b.color=ATON.MatHub.colors.white,b._bStreamFocus=!1,b._numUsers=1,b.avatarList=[],b.avaGroup=ATON.createUINode("avatars"),b.avaGroup.attachToRoot(),b.focGroup=ATON.createUINode("focus"),b.focGroup.attachTo(b.avaGroup),b._focNodes=[],b.bSendState=!0,window.setInterval(b.sendState,1e3*b.USER_STATE_FREQ),b._lastStateSent=void 0,b._bShowAvaG=!0,b._bSpatial=!0,b._decS={quaternion:new THREE.Quaternion,position:new THREE.Vector3},b.customAvatarMaterial=void 0,console.log("Photon initialized"),b.enableChatLog(),b._elVStream=void 0,window.addEventListener("beforeunload",e=>{b.disconnect()})},b.setCustomAvatarMaterialRoutine=e=>{b.customAvatarMaterial=e},b.enableChatLog=()=>{b._elChat=$("<div id='idChatBox' class='atonVRCchatBox'></div>").text("")},b.getNumUsers=()=>b._numUsers,b.initMaterials=()=>{b.ucolorhex=[],b.ucolorhex.push("#D88"),b.ucolorhex.push("#DD8"),b.ucolorhex.push("#8D8"),b.ucolorhex.push("#8DD"),b.ucolorhex.push("#88D"),b.ucolorhex.push("#D8D"),b.ucolorhex_light=[],b.ucolorhex_light.push("#FAA"),b.ucolorhex_light.push("#FFA"),b.ucolorhex_light.push("#AFA"),b.ucolorhex_light.push("#AFF"),b.ucolorhex_light.push("#AAF"),b.ucolorhex_light.push("#FAF"),b.ucolors=[],b.ucolors.push(new THREE.Color(b.ucolorhex[0])),b.ucolors.push(new THREE.Color(b.ucolorhex[1])),b.ucolors.push(new THREE.Color(b.ucolorhex[2])),b.ucolors.push(new THREE.Color(b.ucolorhex[3])),b.ucolors.push(new THREE.Color(b.ucolorhex[4])),b.ucolors.push(new THREE.Color(b.ucolorhex[5])),b.ucolorsdark=[],b.ucolorsdark.push(new THREE.Color(.2,0,0)),b.ucolorsdark.push(new THREE.Color(.2,.2,0)),b.ucolorsdark.push(new THREE.Color(0,.2,0)),b.ucolorsdark.push(new THREE.Color(0,.2,.2)),b.ucolorsdark.push(new THREE.Color(0,0,.2)),b.ucolorsdark.push(new THREE.Color(.2,0,.2));let e=ATON.MatHub.materials;e&&(e.avatars=[]);for(let t=0;t<b.ucolors.length;t++){let o=ATON.MatHub.materials.defUI.clone();o.color=b.ucolors[t],o.uniforms.tint.value=b.ucolors[t],o.uniforms.opacity.value=.5,e.avatars.push(o)}b.uspritemats=[];let t=(new THREE.TextureLoader).load(ATON.PATH_RES+"useraui.png");for(let e=0;e<b.ucolors.length;e++){let o=new THREE.SpriteMaterial({map:t,depthWrite:!1,color:b.ucolors[e]});o.sizeAttenuation=!0,b.uspritemats.push(o)}b.ufocmats=[];let o=(new THREE.TextureLoader).load(ATON.PATH_RES+"focus.png");for(let e=0;e<b.ucolors.length;e++){let t=new THREE.SpriteMaterial({map:o,depthWrite:!1,depthTest:!1,color:b.ucolors[e]});t.sizeAttenuation=!0,b.ufocmats.push(t)}},b.fire=(e,t)=>{if(!b.isConnected())return;let o=b.socket;o&&o.emit(b.REPLICATED_EVT,{e,d:t})},b.fireEvent=b.fire,b.on=(e,t)=>{if(void 0===t)return;let o=ATON.EventHub.evNetwork;void 0===o[e]&&(o[e]=[]),o[e].push(t)},b.isConnected=()=>b._cstate===b.CSTATE.CONNECTED,b.hasID=()=>void 0!==b.uid,b.log=e=>{if(!b.isConnected())return;let t=b.socket;t&&t.emit("UMSG",e)},b.joinSession=e=>{b.socket&&(void 0===e&&(e=ATON.SceneHub.currID),void 0!==e?(console.log("Joining Photon session '"+e+"'..."),b.socket.emit("SENTER",e)):console.log("Photon ERROR: current session ID is undefined"))},b.requestSceneState=()=>{b.socket&&b.socket.emit("SSTATE")},b.setAvatarsVisibility=e=>{b._bShowAvaG=e,e?b.avaGroup.show():b.avaGroup.hide()},b.disableSpatiality=()=>{b._bSpatial=!1},b.enableSpatiality=()=>{b._bSpatial=!0},b.setAddress=e=>{e&&(b.address=e)},b.connect=e=>{if(b._cstate===b.CSTATE.CONNECTED)return;if(b._cstate===b.CSTATE.CONNECTING)return;b._reqSSID=e;let t={};ATON.Utils.isConnectionSecure()?(t.path="/svrc/socket.io",t.secure=!0,t.rejectUnauthorized=!1):t.path="/vrc/socket.io",b._cstate=b.CSTATE.CONNECTING,b.socket=io.connect(b.address,t),void 0!==b.socket?b._registerSocketHandlers():b._cstate=b.CSTATE.DISCONNECTED},b.disconnect=()=>{void 0!==b.socket&&(b._numUsers=1,b.socket.disconnect(),b.color=ATON.MatHub.colors.white,ATON.plight.color=ATON.MatHub.colors.white,b._cstate=b.CSTATE.DISCONNECTED)},b._onConnected=()=>{},b.setUsername=e=>{(e=e.trim()).length<1||(b._username=e,void 0!==b.socket&&void 0!==b.uid&&(b.appendToChatBox("<i>Your username is now: "+e+"</i>"),b.socket.emit("UNAME",e)))},b.setMessage=e=>{(e=e.trim()).length<1||e.length>3e3||(b._msg=e,void 0!==b.socket&&void 0!==b.uid&&(b.socket.emit("UMSG",e),b._elChat&&(e=b.chatMessageProcessor(b.uid,e),b.appendToChatBox("<div class='"+ATON.FE.getVRCclassFromID(b.uid)+" atonVRCchatUsername'>YOU</div>: <span style='color:"+b.ucolorhex_light[b.uid%6]+"'>"+e+"</span>"))))},b.appendToChatBox=e=>{b._elChat&&(b._elChat.append("<div class='atonVRCchatMessage'>"+e+"</div>"),b._elChat.scrollTop(b._elChat[0].scrollHeight))},b._registerSocketHandlers=()=>{b.socket.on("connect",()=>{b._cstate=b.CSTATE.CONNECTED,void 0!==b._reqSSID?b.joinSession(b._reqSSID):b.joinSession(ATON.SceneHub.currID),console.log("Connected to Photon service!"),ATON.fire("VRC_Connected"),b._onConnected()}),b.socket.on("disconnect",()=>{b._cstate=b.CSTATE.DISCONNECTED,b.uid=void 0,b.avaGroup.hide(),b.appendToChatBox("<i>YOU disconnected from the Photon session</i>"),console.log("Disconnected from Photon service!"),ATON.fire("VRC_Disconnected")}),b.socket.on(b.REPLICATED_EVT,e=>{let t=e.e,o=e.d,i=ATON.EventHub.evNetwork[t];ATON.EventHub.executeHandlers(i,o)}),b.socket.on("ID",e=>{console.log("Your ID is "+e),b.uid=e,b.color=b.ucolors[b.uid%b.ucolors.length],b._bShowAvaG&&b.avaGroup.show(),b.appendToChatBox("<i>Your ID is #"+e+"</i>"),b.requestSceneState(),ATON.fire("VRC_IDassigned",e)}),b.socket.on("SSTATE",e=>{b._numUsers=e.numUsers,console.log("Num. users: "+b._numUsers),ATON.fire("VRC_SceneState",e)}),b.socket.on("UENTER",e=>{let t=e;console.log("User #"+t+" entered the session"),b.appendToChatBox("<i>User #"+t+" entered the session</i>"),b.requestSceneState(),ATON.fire("VRC_UserEnter",t)}),b.socket.on("ULEAVE",e=>{let t=e;if(void 0===t)return;let o=b.avatarList[t];o&&(o.toggleStreamPanel(!1),o.hide()),console.log("User #"+t+" left the session"),b.appendToChatBox("<i>User #"+t+" left the session</i>"),b.requestSceneState(),ATON.fire("VRC_UserLeave",t)}),b.socket.on("USTATE",e=>{if(!b._bShowAvaG)return;if(!b._bSpatial)return;let t=b.decodeState(e),o=t.userid,i=b.touchAvatar(o);i.requestStateTransition(t);let r=1/t.scale;i.scale.set(r,r,r)}),b.socket.on("UFOCUS",e=>{if(!b._bSpatial)return;let t=e.uid,o=e.fp;b.touchAvatar(t).requestFocus(o)}),b.socket.on("UNAME",e=>{let t=e.uid,o=e.name;void 0!==t&&(b.touchAvatar(t).setUsername(o),console.log("User #"+t+" changed username to: "+o),b.appendToChatBox("<i>User #"+t+" changed username to: "+o+"</i>"),ATON.fire("VRC_UName",e))}),b.socket.on("UMSG",e=>{let t=e.uid,o=e.msg;if(void 0===t)return;let i=b.touchAvatar(t);o.length<100&&i.setMessage(o),console.log("User #"+t+": "+o);let r=i.getUsername();o=b.chatMessageProcessor(t,o),b.ucolorhex[t%6];let a=b.ucolorhex_light[t%6];b.appendToChatBox("<div class='"+ATON.FE.getVRCclassFromID(t)+" atonVRCchatUsername'>"+r+"</div>: <span style='color:"+a+"'>"+o+"</span>"),ATON.fire("VRC_UMessage",e)}),b.socket.on("UTALK",e=>{let t=e.uid;if(void 0===t)return;let o=e.audio;if(o){if(b._bSpatial){let e=b.touchAvatar(t);if(e.bMuted)return;ATON.AudioHub._loader.load(o,t=>{let o=e._auTalk[e._auTalki],i=(e._auTalki+1)%2;o.setBuffer(t),o.isPlaying||o.play(),e.setTalkVolume(5),e._auTalki=i})}ATON.fire("VRC_UTalk",e),o=null}}),b.socket.on("UTALKSTOP",e=>{void 0!==e.uid&&ATON.fire("VRC_UTalkStop",e)}),b.socket.on("UVIDEO",e=>{void 0!==e.uid&&ATON.fire("VRC_UVideo",e)}),b.socket.on("UVIDEOSTOP",e=>{let t=e.uid;if(void 0===t)return;let o=b.avatarList[t];o&&o.toggleStreamPanel(!1),ATON.fire("VRC_UVideoStop",e)})},b.chatMessageProcessor=(e,t)=>{const o=(t=String(t)).match(/(((ftp|https?):\/\/)[\-\w@:%_\+.~#?,&\/\/=]+)/g);return o&&o.forEach(e=>{t=t.replace(e,"<a target='_blank' href='"+e+"'>"+e+"</a>")}),t},b.encodeState=e=>{if(!e)return;let t=new Float32Array(5);t[0]=e.position.x,t[1]=e.position.y,t[2]=e.position.z;var o=new Int8Array(t.buffer);return o[12]=128*e.quaternion.x,o[13]=128*e.quaternion.y,o[14]=128*e.quaternion.z,o[15]=128*e.quaternion.w,o[16]=e.userid,o[17]=ATON._ws,o},b.decodeState=e=>{let t=new Int8Array(e);b._decS.userid=t[16];let o=ATON._unpackScale(t[17]);return b._decS.scale=o,b._decS.quaternion.set(parseFloat(t[12])/128,parseFloat(t[13])/128,parseFloat(t[14])/128,parseFloat(t[15])/128),t=new Float32Array(e),b._decS.position.set(parseFloat(t[0])/o,parseFloat(t[1])/o,parseFloat(t[2])/o),b._decS},b.update=()=>{if(b.isConnected())for(let e=0;e<b.avatarList.length;e++){let t=b.avatarList[e];t&&t.visible&&t.update()}},b.setFocusStreaming=e=>{if(void 0!==e){if(e)return b._bStreamFocus||(ATON.fire("VRC_FocusStreamingStarted"),ATON.enablePointLight(),ATON.plight.color=ATON.Photon.color),void(b._bStreamFocus=!0);{b._bStreamFocus&&(ATON.fire("VRC_FocusStreamingStopped"),ATON.disablePointLight());let e=ATON.SUI._selectorRad;ATON.SUI.mainSelector.scale.set(e,e,e),b._bStreamFocus=!1}}},b.sendState=()=>{if(!b.bSendState||!b._bSpatial)return;if(void 0===b.uid)return;if(!b.socket||!b.isConnected())return;let e=ATON.Nav._currPOV;if(!e)return;let t=ATON.getSceneFocalPoint();if(b._bStreamFocus&&void 0!==t){let e=t.x.toFixed(3),o=t.y.toFixed(3),i=t.z.toFixed(3),r=ATON.SUI.getSelectorRadius().toFixed(3);b.socket.emit("UFOCUS",[e,o,i,r])}if(!e.pos)return;if(!ATON.Nav._qOri)return;if(void 0!==b._lastStateSent){let t=b._lastStateSent.position,o=b._lastStateSent.quaternion,i=t.distanceToSquared(e.pos),r=o.angleTo(ATON.Nav._qOri);if(i<b.THRES_STATE_POS&&r<b.THRES_STATE_ORI)return}void 0===b._lastStateSent&&(b._lastStateSent={},b._lastStateSent.position=new THREE.Vector3,b._lastStateSent.quaternion=new THREE.Quaternion),b._lastStateSent.position.copy(e.pos),b._lastStateSent.quaternion.copy(ATON.Nav._qOri),b._lastStateSent.userid=b.uid,b._lastStateSent.scale=ATON._worldScale;let o=b.encodeState(b._lastStateSent);b.socket.emit("USTATE",o)},b.getAvatar=e=>b.avatarList[e],b.touchAvatar=e=>{if(void 0===b.avatarList[e]){let t=new b.Avatar(e);t.attachTo(b.avaGroup),t.loadRepresentation(ATON.PATH_RES+"models/vrc/head.glb"),b.avatarList[e]=t}let t=b.avatarList[e];return t.visible||ATON.fire("VRC_UserEnter",e),b._bShowAvaG&&t.show(),t},b.destroyAvatar=e=>{let t=b.avatarList[e];void 0!==t&&t.destroy()},b.clearAllAvatars=()=>{for(let e in b.avatarList)b.avatarList[e].hide()},b.getAvatarMaterialByUID=e=>{const t=ATON.MatHub.materials.avatars;return t[e%t.length]};const P=b;let f={FLOAT_PREC:5,init:()=>{f.bConvexBuilding=!1,f.convexPoints=[],f.convexNode=void 0,f.currConvexMesh=void 0,f.currSemNode=ATON.createSemanticNode(),f.currSemNode.disablePicking(),f.currSemNode.attachToRoot(),f.resetMaterial(),f._numShapes=0},resetMaterial:()=>{f.currMaterial=ATON.MatHub.getMaterial("semanticShapeHL")},setMaterial:e=>{void 0!==e&&(f.currMaterial=e)},addConvexPoint:e=>{if(void 0===e)return!1;if(f.convexPoints.length>0){let t=f.convexPoints[f.convexPoints.length-1];if(e.equals(t))return!1}f.convexPoints.push(e);let t=f.convexPoints.length,o=new THREE.Sprite(ATON.SUI.getOrCreateSpritePointEdit()),i=.02*ATON.getSceneQueriedDistance();if(void 0===i&&(i=.02),o.position.copy(e),o.scale.set(i,i,i),ATON.SUI.gPoints.add(o),t<4)return!1;let r=new THREE.ConvexGeometry(f.convexPoints),a=new THREE.Mesh(r,ATON.MatHub.getMaterial("semanticShapeEdit"));if(f.bConvexBuilding){let t=f.currConvexMesh;t.geometry.dispose(),t.geometry=r,ATON.Utils.setVectorPrecision(e,4),t.userData._convexPoints.push(e.x),t.userData._convexPoints.push(e.y),t.userData._convexPoints.push(e.z)}else{f.currSemNode.add(a),a.userData._convexPoints=[];for(let e=0;e<t;e++)ATON.Utils.setVectorPrecision(f.convexPoints[e],f.FLOAT_PREC),a.userData._convexPoints.push(f.convexPoints[e].x),a.userData._convexPoints.push(f.convexPoints[e].y),a.userData._convexPoints.push(f.convexPoints[e].z);f.currConvexMesh=a,f.bConvexBuilding=!0}return!0},undoConvexPoint:()=>{if(0!==f.convexPoints.length&&(f.convexPoints.pop(),f.currConvexMesh)){let e=f.currConvexMesh.userData;e._convexPoints&&e._convexPoints.pop()}},stopCurrentConvex:()=>{f.bConvexBuilding&&(f.convexPoints=[],f.bConvexBuilding=!1,f.currSemNode.removeChildren(),ATON.SUI.gPoints.removeChildren())},getCurrentConvexShape:()=>f.currSemNode,isBuildingShape:()=>f.convexPoints.length>0,completeConvexShape:e=>{if(f.convexPoints=[],f.bConvexBuilding=!1,void 0===f.currSemNode)return;void 0===e&&(e="sem"+f._numShapes);let t=ATON.getSemanticNode(e)||ATON.createSemanticNode(e),o=f.currSemNode.children[0];return ATON.SUI.addSemIcon(e,o),t.add(o),t.setMaterial(ATON.MatHub.materials.semanticShape),t.setDefaultAndHighlightMaterials(ATON.MatHub.materials.semanticShape,f.currMaterial),t.enablePicking(),f.currSemNode.removeChildren(),f._numShapes++,ATON.SUI.gPoints.removeChildren(),ATON._bqSem=!0,t},createConvexShape:(e,t)=>{let o=new THREE.ConvexGeometry(t),i=new THREE.Mesh(o,ATON.MatHub.materials.semanticShape);i.userData._convexPoints=[];for(let e=0;e<t.length;e++){let o=t[e];ATON.Utils.setVectorPrecision(o,4),i.userData._convexPoints.push(o.x),i.userData._convexPoints.push(o.y),i.userData._convexPoints.push(o.z)}ATON.SUI.addSemIcon(e,i);let r=ATON.getOrCreateSemanticNode(e);return r.add(i),r.setDefaultAndHighlightMaterials(ATON.MatHub.materials.semanticShape,f.currMaterial),r.enablePicking(),ATON._bqSem=!0,r},addSurfaceConvexPoint:e=>{if(void 0===ATON._queryDataScene)return!1;void 0===e&&(e=.02);let t=ATON._queryDataScene.p,o=ATON.Nav.getCurrentEyeLocation();return t.lerpVectors(t,o,e),f.addConvexPoint(t),t},createSphere:(e,t,o)=>{if(void 0===t)return;if(void 0===o)return;void 0===e&&(e="sem"+f._numShapes);let i=ATON.getOrCreateSemanticNode(e),r=new THREE.Mesh(ATON.Utils.geomUnitSphere,ATON.MatHub.materials.semanticShape),a=new THREE.Object3D;return a.position.copy(t),a.scale.set(o,o,o),a.add(r),ATON.SUI.addSemIcon(e,a),i.add(a),i.enablePicking(),i.setDefaultAndHighlightMaterials(ATON.MatHub.materials.semanticShape,f.currMaterial),f._numShapes++,ATON._bqSem=!0,i},createSurfaceSphere:e=>{if(!ATON._queryDataScene)return;let t=ATON._queryDataScene.p,o=ATON.SUI.getSelectorRadius();return f.createSphere(e,t,o)},deleteSemanticNode:e=>{let t=ATON.getSemanticNode(e);if(void 0===t)return!1;if(t.removeChildren(),void 0===ATON.SUI.gSemIcons)return!0;for(let t in ATON.SUI.gSemIcons.children){let o=ATON.SUI.gSemIcons.children[t];o&&o.name===e&&ATON.SUI.gSemIcons.removeChild(o)}return!0}};const E=f;let R={SEMSHAPE_SPHERE:0,SEMSHAPE_CONVEX:1,POPUP_DT:500,STD_SEL_RAD:.05,_bRealized:!1,realize:()=>{if(R._bRealized)return;R.PATH_RES_ICONS=ATON.PATH_RES+"icons/",R._bPopup=!1,R._tPopup=void 0,R.popupBlurBG=0,R._userAuth={},R._bControlLight=!1,R._bControlSelScale=!1,R._cLightDir=new THREE.Vector3,R._auSemNode=void 0,R._auSemNodePlaying=!1,R._bReqHome=!1,R._bVRCsetup=!1,R.urlParams=new URLSearchParams(window.location.search),R._uiSetupBase(),R._uiProfiles={},R._uiCurrProfile=void 0,R._selRanges=[.01,50],R._selRefRadius=.5,ATON.realize(),ATON.on("Fullscreen",e=>{R.uiSwitchButton("fullscreen",e)});let e=ATON.FE.urlParams.get("d");e&&e>0&&(ATON.setDefaultPixelDensity(e),ATON.toggleAdaptiveDensity(!1));let t=ATON.FE.urlParams.get("dd");t&&t>0&&ATON.toggleAdaptiveDensity(!0),R._canvas=ATON._renderer.domElement,R._bSem=!1,R._bShowSemLabel=!0,R._bRealized=!0,R.loadSceneID=ATON.App.loadScene},_handleHomeReq:()=>{R._bReqHome||ATON.getRootScene().getBound().radius<=0||(R._bReqHome=!0,void 0!==ATON.Nav.homePOV?ATON.Nav.requestHome(1):ATON.Nav.computeAndRequestDefaultHome(.5))},addBasicLoaderEvents:()=>{ATON.on("NodeRequestFired",()=>{$("#idLoader").show()}),ATON.on("SceneJSONLoaded",()=>{ATON.SceneHub.getDescription()&&$("#btn-info").show(),void 0!==ATON.Nav.homePOV&&ATON.Nav.requestHome(1),ATON.XPFNetwork._list.length>0&&void 0===ATON.Nav.homePOV&&(ATON.XPFNetwork.setHomeXPF(0),ATON.XPFNetwork.requestTransitionByIndex(0))}),ATON.on("AllNodeRequestsCompleted",()=>{$("#idLoader").hide(),ATON.CC.anyCopyrightFound()&&$("#btn-cc").show(),R.computeSelectorRanges(),ATON.SUI.setSelectorRadius(Math.min(R.STD_SEL_RAD,R._selRefRadius)),R._handleHomeReq()}),ATON.on("XR_support",e=>{"immersive-vr"===e.type&&(e.v?$("#btn-vr").show():$("#btn-vr").hide())}),ATON.on("SemanticNodeHover",e=>{let t=ATON.getSemanticNode(e);void 0!==t&&(R.showSemLabel(e),R._bSem=!0,t.highlight(),$("canvas").css({cursor:"crosshair"}),ATON.SUI.gSemIcons&&ATON.SUI.gSemIcons.hide())}),ATON.on("SemanticNodeLeave",e=>{let t=ATON.getSemanticNode(e);void 0!==t&&(R.hideSemLabel(),R._bSem=!1,t.restoreDefaultMaterial(),$("canvas").css({cursor:"grab"}),ATON.SUI.gSemIcons&&ATON.SUI.gSemIcons.show())}),ATON.on("SemanticMaskHover",e=>{R.showSemLabel(e),R._bSem=!0,$("canvas").css({cursor:"crosshair"})}),ATON.on("SemanticMaskLeave",e=>{R.hideSemLabel(),R._bSem=!1,$("canvas").css({cursor:"grab"})}),ATON.addUpdateRoutine(R._update)},showSemLabel:e=>{R._bShowSemLabel&&($("#idPopupLabel").html(e),$("#idPopupLabel").show(),ATON.SUI.setInfoNodeText(e))},hideSemLabel:()=>{$("#idPopupLabel").hide(),$("#idPopupLabel").html("")},controlLight:e=>{R._bControlLight=e,ATON.Nav.setUserControl(!e)},controlSelectorScale:e=>{R._bControlSelScale=e,ATON._bPauseQuery=e,ATON.Nav.setUserControl(!e)},attachGizmoToNode:e=>{if(void 0===ATON._gizmo)return;let t=ATON.getSceneNode(e);void 0!==t&&ATON._gizmo.attach(t)},useMouseWheelToScaleSelector:e=>{void 0===e&&(e=.9),ATON.on("MouseWheel",t=>{if(ATON._kModCtrl){let e=ATON.Nav.getFOV();return t>0?e+=1:e-=1,void ATON.Nav.setFOV(e)}if(ATON._kModShift){let o=ATON.SUI.mainSelector.scale.x;return t>0?o*=e:o/=e,o<R._selRanges[0]&&(o=R._selRanges[0]),o>R._selRanges[1]&&(o=R._selRanges[1]),void ATON.SUI.setSelectorRadius(o)}})},_update:()=>{if(R._bControlLight){const e=ATON._screenPointerCoords.x,t=ATON._screenPointerCoords.y;R._cLightDir.x=-Math.cos(e*Math.PI),R._cLightDir.y=4*-t,R._cLightDir.z=-Math.sin(e*Math.PI),R._cLightDir.normalize(),ATON.setMainLightDirection(R._cLightDir)}if(ATON.XR._bPresenting){let e=ATON.XR.getAxisValue(ATON.XR.HAND_R);if(!ATON.Photon._bStreamFocus){let t=ATON.SUI._selectorRad;t+=.01*e.y,t>.001&&ATON.SUI.setSelectorRadius(t)}}else{if(ATON.Nav.isTransitioning()||ATON.Nav._bInteracting||ATON._bPauseQuery)return void $("#idPopupLabel").hide();if(R._bSem&&R._bShowSemLabel){$("#idPopupLabel").show();let e=.5*ATON._screenPointerCoords.x*window.innerWidth,t=.5*(1-ATON._screenPointerCoords.y)*window.innerHeight;t-=55,$("#idPopupLabel").css("transform","translate("+e+"px, "+t+"px)")}else $("#idPopupLabel").hide()}},uiBasicSetup:()=>{R.uiAddButton("idTopToolbar","fullscreen",ATON.toggleFullScreen),ATON.Utils.isConnectionSecure()&&R.uiAddButton("idTopToolbar","vr",ATON.XR.toggle),R.uiAddButton("idBottomToolbar","home",()=>{ATON.Nav.requestHome(.1)})},_uiSetupBase:()=>{$("#idPopup").click(R.popupClose),$("#idLoader").html("<img src='"+ATON.PATH_RES+"loader.png'>"),$("body").prepend("<div class='atonPopupLabelContainer'><div id='idPopupLabel' class='atonPopupLabel'></div></div>"),R.hideSemLabel()},uiAddButton:(e,t,o,i)=>{let r,a;t.endsWith(".png")?(r=t,a=t.slice(0,-4)):(r=R.PATH_RES_ICONS+t+".png",a=t);let n=$("<div id='btn-"+a+"' class='atonBTN' ><img src='"+r+"'></div>");$("#"+e).append(n),o&&n.click(o),i&&n.attr("title",i)},uiSwitchButton:(e,t)=>{t?$("#btn-"+e).addClass("switchedON"):$("#btn-"+e).removeClass("switchedON")},uiSetButtonHandler:(e,t)=>{$("#"+e).click(t)},uiAddButtonHome:e=>{R.uiAddButton(e,"home",()=>{ATON.Nav.requestHome(.3)},"Home viewpoint")},uiAddButtonBack:(e,t)=>{R.uiAddButton(e,"back",()=>{t&&t.length>1&&t.startsWith("http:")?ATON.Utils.goToURL(t):history.back()},"Go Back")},uiAddButtonFirstPerson:e=>{R.uiAddButton(e,"fp",()=>{ATON.Nav.isFirstPerson()?(ATON.Nav.setOrbitControl(),R.uiSwitchButton("fp",!1)):(ATON.Nav.setFirstPersonControl(),R.uiSwitchButton("fp",!0))},"First-person navigation mode"),ATON.Nav.isFirstPerson()?R.uiSwitchButton("fp",!0):R.uiSwitchButton("fp",!1)},uiAddButtonVR:e=>{ATON.Utils.isConnectionSecure()&&(R.uiAddButton(e,"vr",()=>{ATON.XR.toggle("immersive-vr")},"Immersive VR mode"),ATON.Utils.isVRsupported()||$("#btn-vr").hide())},uiAddButtonAR:e=>{ATON.Utils.isConnectionSecure()&&R.uiAddButton(e,"ar",()=>{ATON.Utils.isARsupported()&&ATON.XR.toggle("immersive-ar")},"Immersive AR mode")},uiAddButtonDeviceOrientation:e=>{ATON.Utils.isConnectionSecure()&&ATON.Utils.isMobile()&&(R.uiAddButton(e,"devori",()=>{ATON.Nav.isDevOri()?(ATON.Nav.restorePreviousNavMode(),R.uiSwitchButton("devori",!1)):(ATON.Nav.setDeviceOrientationControl(),R.uiSwitchButton("devori",!0))},"Device-orientation mode"),ATON.Nav.isDevOri()?R.uiSwitchButton("devori",!0):R.uiSwitchButton("devori",!1))},uiAddButtonNav:e=>{R.uiAddButton(e,"nav",()=>{R.popupNav()},"Navigation")},uiAddButtonTalk:e=>{ATON.Utils.isConnectionSecure()&&(R.uiAddButton(e,"talk",()=>{ATON.MediaFlow.isAudioRecording()?(ATON.MediaFlow.stopAudioStreaming(),$("#btn-talk").removeClass("atonBTN-rec")):(ATON.MediaFlow.startAudioStreaming(),$("#btn-talk").addClass("atonBTN-rec"))},"Talk ON/OFF"),ATON.MediaFlow.isAudioRecording()?$("#btn-talk").addClass("atonBTN-rec"):$("#btn-talk").removeClass("atonBTN-rec"))},uiAddButtonStreamFocus:e=>{R.uiAddButton(e,"focus",()=>{ATON.Photon._bStreamFocus?(ATON.Photon.setFocusStreaming(!1),$("#btn-focus").removeClass("atonBTN-rec")):(ATON.Photon.setFocusStreaming(!0),$("#btn-focus").addClass("atonBTN-rec"))},"Focus streaming ON/OFF"),ATON.Photon._bStreamFocus?$("#btn-focus").addClass("atonBTN-rec"):$("#btn-focus").removeClass("atonBTN-rec")},uiAddButtonMainVideoPanoPlayPause:e=>{R.uiAddButton(e,"playpause",()=>{ATON._vpanoPlaying?ATON._elPanoVideo&&ATON._elPanoVideo.pause():ATON._elPanoVideo&&ATON._elPanoVideo.play()},"360 Video play/pause"),ATON._elPanoVideo?$("#btn-playpause").show():$("#btn-playpause").hide()},uiAddButtonQR:e=>{ATON.Utils.isLocalhost()||R.uiAddButton(e,"qr",R.popupQR,"QR-code")},uiAddButtonScreenshot:e=>{R.uiAddButton(e,"sshot",R.popupScreenShot,"Screenshot")},uiAddButtonInfo:e=>{R.uiAddButton(e,"info",ATON.FE.popupSceneInfo,"Scene information"),$("#btn-info").hide()},uiAddButtonFullScreen:e=>{R.uiAddButton(e,"fullscreen",()=>{ATON.toggleFullScreen()},"Fullscreen"),R.uiSwitchButton("fullscreen",ATON.isFullscreen())},uiAddKeywordsArea:(e,t,o,i)=>{let r="";r+="Add keyword: <input id='idKWordInput' list='lkwords' type='text' maxlength='100' size='20'><div class='atonBTN atonBTN-green' id='idKWadd'><img src='"+ATON.FE.PATH_RES_ICONS+"add.png'></div><br>",r+="<div id='idKWords'></div>",$("#"+e).html(r),R.uiAttachInputFilterID("idKWordInput"),$.getJSON(ATON.PATH_RESTAPI+"keywords/",t=>{let o="<datalist id='lkwords'>";for(let e in t)o+="<option>"+e+"</option>";o+="</datalist>",$("#"+e).append(o)});let a={},n=e=>{a[e]||(e=e.toLowerCase().trim(),$("#idKWordInput").val(""),a[e]=1,console.log("Added keyword "+e),o&&o(e),$("#idKWords").append("<div class='atonKeyword atonKeywordActivable' id='idkw-"+e+"'>"+e+"</div>"),$("#idkw-"+e).click(()=>{$("#idkw-"+e).remove(),a[e]=void 0,console.log("Removed keyword "+e),i&&i(e)}))};if(t)for(let e in t)n(t[e]);$("#idKWordInput").keypress(function(e){if("13"!=(e.keyCode?e.keyCode:e.which))return;let t=$("#idKWordInput").val().toLowerCase().trim();!t||t.length<3||n(t)}),$("#idKWadd").click(()=>{let e=$("#idKWordInput").val().toLowerCase().trim();!e||e.length<3||n(e)})},uiAttachCollectionItemsToInput:(e,t)=>{let o="";$("#"+e).attr("list",e+"-list"),$("#"+e).attr("name",e+"-list"),$.getJSON(ATON.PATH_RESTAPI+"c/"+t+"/",t=>{o+="<datalist id='"+e+"-list'>";for(let e in t){let i=t[e];o+="<option value='"+i+"'>"+i+"</option>"}o+="</datalist>",$("#"+e).html(o)})},getVRCclassFromID:e=>"atonVRCu"+e%6,_setupVRCevents:()=>{R._bVRCsetup||(ATON.on("VRC_IDassigned",e=>{$("#btn-vrc").addClass(R.getVRCclassFromID(e)),ATON.SUI.setSelectorColor(ATON.Photon.color),ATON.plight.color=ATON.Photon.color,R.checkAuth(e=>{void 0!==e.username&&ATON.Photon.setUsername(e.username)})}),ATON.on("VRC_SceneState",e=>{let t=ATON.Photon.getNumUsers();t>1?$("#idVRCnumusers").html(t):$("#idVRCnumusers").html(""),console.log("Users: "+t)}),ATON.on("VRC_Disconnected",()=>{$("#btn-vrc").attr("class","atonBTN"),ATON.SUI.setSelectorColor(ATON.MatHub.colors.defUI),ATON.MediaFlow.stopAllStreams(),$("#idVRCnumusers").html("")}),R._bVRCsetup=!0)},uiAddButtonPhoton:e=>{R.uiAddButton(e,"vrc",()=>{ATON.Photon.isConnected()?R.popupVRC():ATON.Photon.connect()},"Photon (collaborative session)"),$("#btn-vrc").append("<span id='idVRCnumusers' class='atonVRCcounter'></span>"),R._setupVRCevents(),void 0!==ATON.Photon.uid?$("#btn-vrc").addClass(R.getVRCclassFromID(ATON.Photon.uid)):$("#btn-vrc").attr("class","atonBTN")}};R.uiAddButtonVRC=R.uiAddButtonPhoton,R.uiAddButtonUser=e=>{R.uiAddButton(e,"user",()=>{R.popupUser()},"User"),R.checkAuth(e=>{void 0!==e.username?$("#btn-user").addClass("switchedON"):$("#btn-user").removeClass("switchedON")})},R.uiSetEditMode=(e,t)=>{ATON.SceneHub._bEdit=e,R.uiSwitchButton("edit",e),ATON._renderer.domElement,e?$("#"+t).addClass("atonToolbar-bg-edit"):$("#"+t).removeClass("atonToolbar-bg-edit")},R.uiAddButtonEditMode=e=>{R.uiAddButton(e,"edit",()=>{R.checkAuth(t=>{void 0!==t.username?(ATON.SceneHub._bEdit?R.uiSetEditMode(!1,e):R.uiSetEditMode(!0,e),console.log("Persistent Edit Mode: "+ATON.SceneHub._bEdit)):R.popupUser()})},"Persistent Edit Mode"),ATON.SceneHub._bEdit?R.uiSwitchButton("edit",!0):R.uiSwitchButton("edit",!1)},R.uiAddProfile=(e,t)=>{"function"==typeof t&&(R._uiProfiles[e]=t)},R.uiLoadProfile=e=>{let t=R._uiProfiles[e];void 0!==t&&(t(),R._uiCurrProfile=e,console.log("Loaded UI Profile: "+R._uiCurrProfile))},R.getCurrentUIP=()=>R._uiCurrProfile,R.attachHandlerToButton=(e,t)=>{void 0!==t&&$("#"+e).click(()=>{t()})},R.uiAttachInputFilterID=e=>{$("#"+e).on("keyup change input",()=>{let t=$("#"+e).val(),o=new RegExp("[^A-Za-z0-9-_]","ig");$("#"+e).val(t.replace(o,""))})},R.switchNode=(e,t,o)=>{let i;i=o===ATON.NTYPES.SEM?ATON.getSemanticNode(e):ATON.getSceneNode(e),void 0!==i&&(i.toggle(t),ATON.fire("FE_NodeSwitch",{nid:e,t:o,v:t}))},R.uiCreateGraph=e=>{let t=ATON.snodes;e===ATON.NTYPES.SEM&&(t=ATON.semnodes);let o="";for(let i in t){let r=t[i].visible?"checked":"";"."!==i&&(o+="<input type='checkbox' "+r+" onchange=\"ATON.FE.switchNode('"+i+"',this.checked,"+e+');">'+i,o+="<br>")}return o},R.setupBasicUISounds=()=>{R.auLib={},R.auLib.switch=new Audio(ATON.PATH_RES+"audio/switch.wav"),R.auLib.switch.loop=!1},R.playAudioFromSemanticNode=e=>{if(void 0===e)return;let t=ATON.getSemanticNode(e);if(void 0===t)return;let o=t.getAudio();void 0!==o&&("string"!=typeof o||o.startsWith("data:audio")||(o=ATON.Utils.resolveCollectionURL(o)),void 0===R._auSemNode||null===R._auSemNode?R._auSemNode=new THREE.Audio(ATON.AudioHub._listener):R._auSemNode.stop(),ATON.AudioHub._loader.load(o,e=>{R._auSemNode.setBuffer(e),R._auSemNode.setLoop(!1),R._auSemNode.play()}))},R.popupShow=(e,t)=>{if(R._bPopup)return!1;R._tPopup=Date.now();let o="atonPopup ";t&&(o+=t);let i="<div id='idPopupContent' class='"+o+"'>";return i+=e+"</div>",R._bPopup=!0,ATON._bListenKeyboardEvents=!1,$("#idPopup").html(i),$("#idPopupContent").click(e=>{e.stopPropagation()}),$("#idPopup").show(),R.popupBlurBG>0&&(ATON._renderer.domElement.style.filter="blur("+R.popupBlurBG+"px)"),ATON._bPauseQuery=!0,$("#idTopToolbar").hide(),$("#idBottomToolbar").hide(),$("#idBottomRToolbar").hide(),$("#idPoweredBy").hide(),!0},R.popupClose=e=>{Date.now()-R._tPopup<R.POPUP_DT||(R._bPopup=!1,ATON._bListenKeyboardEvents=!0,R.popupBlurBG>0&&(ATON._renderer.domElement.style.filter="none"),$("#idPopup").hide(),ATON._bPauseQuery=!1,$("#idTopToolbar").show(),$("#idBottomToolbar").show(),$("#idBottomRToolbar").show(),$("#idPoweredBy").show(),ATON.focusOn3DView())},R.subPopup=e=>{ATON.FE.popupClose(),e()},R.popupQR=()=>{let e="<div class='atonPopupTitle'>Share</div>";if(e+="<div class='atonQRcontainer' id='idQRcode'></div><br><br>",!ATON.FE.popupShow("<div class='atonPopupTitle'>Share</div><div class='atonQRcontainer' id='idQRcode'></div><br><br>"))return;let t=window.location.href;new QRCode(document.getElementById("idQRcode"),t)},R.popupScreenShot=()=>{let e=ATON.Utils.takeScreenshot(256);R.checkAuth(t=>{let o="<div class='atonPopupTitle'>Capture</div>";o+="This is a preview of what your screenshot will look like:<br><br>",o+="<img src='"+e.src+"'><br>",o+="Resolution: <input id='isShotSize' type='number' min='100' max='4000' value='256'>px<br>",o+="<div class='atonBTN atonBTN-horizontal' id='btnScreenShot'><img src='"+R.PATH_RES_ICONS+"sshot.png'>Screenshot</div>",o+="<div class='atonBTN atonBTN-horizontal' id='btnScreenRec'><img src='"+R.PATH_RES_ICONS+"recscreen.png'>Record video</div>",void 0!==t.username&&(o+="<div class='atonBTN atonBTN-green atonBTN-horizontal' id='btnSetCover'>Set as Cover</div>"),ATON.FE.popupShow(o)&&(ATON.MediaFlow._bScreenRec?$("#btnScreenRec").addClass("atonBTN-rec"):$("#btnScreenRec").removeClass("atonBTN-rec"),$("#btnScreenShot").click(()=>{let e=parseInt($("#isShotSize").val());e<100||(ATON.FE.popupClose(),ATON.Utils.takeScreenshot(e,"shot.png"))}),$("#btnScreenRec").click(()=>{ATON.MediaFlow._bScreenRec||ATON.MediaFlow.startScreenRecording(),ATON.FE.popupClose()}),$("#btnSetCover").click(()=>{ATON.FE.popupClose(),ATON.Utils.postJSON(ATON.PATH_RESTAPI+"cover/scene/",{sid:ATON.SceneHub.currID,img:e.src},e=>{console.log(e)})}))})},R.popupVRC=()=>{let e="",t=ATON.Photon.getNumUsers();e+=t>1?"<div class='atonPopupTitle'>Collaborative Session ("+t+" users)</div>":"<div class='atonPopupTitle'>Collaborative Session</div>",e+="<div id='idCollabTools' style='display:inline'></div>",e+="<input id='idVRCusername' type='text' size='10' placeholder='username...' style='display:none'>",e+="<div id='idVRCusernameBTN' class='atonBTN' style='width:150px; display:none'>"+ATON.Photon._username+"</div>",e+="<div class='atonBTN atonBTN-text' id='idVRCdisconnect'><img src='"+ATON.FE.PATH_RES_ICONS+"exit.png'>LEAVE</div>",e+="<div id='idChatBoxPopup' style='display:block'></div>",e+="<input id='idVRCmsg' style='width:90%;margin:auto' type='text' placeholder='message...'>",ATON.FE.popupShow(e,"atonPopupLarge")&&(ATON.checkAuth(e=>{console.log(e),ATON.MediaFlow._bCamStream||ATON.FE.uiAddButton("idCollabTools","screenshare",()=>{ATON.MediaFlow._bScreenStream?$("#btn-screenshare").addClass("atonBTN-rec"):$("#btn-screenshare").removeClass("atonBTN-rec"),ATON.MediaFlow.startOrStopScreenStreaming(),ATON.FE.popupClose()},"Share your screen with other participants"),!ATON.MediaFlow._bScreenStream&&ATON.MediaFlow.hasVideoInput()&&ATON.FE.uiAddButton("idCollabTools","camera",()=>{ATON.MediaFlow._bCamStream?$("#btn-camera").addClass("atonBTN-rec"):$("#btn-camera").removeClass("atonBTN-rec"),ATON.MediaFlow.startOrStopCameraStreaming(),ATON.FE.popupClose()},"Share your camera with other participants"),ATON.MediaFlow._bScreenStream?$("#btn-screenshare").addClass("atonBTN-rec"):$("#btn-screenshare").removeClass("atonBTN-rec"),ATON.MediaFlow._bCamStream?$("#btn-camera").addClass("atonBTN-rec"):$("#btn-camera").removeClass("atonBTN-rec")}),void 0===ATON.Photon._username?($("#idVRCusername").show(),$("#idVRCusernameBTN").hide()):($("#idVRCusername").val(ATON.Photon._username),$("#idVRCusername").hide(),$("#idVRCusernameBTN").show()),void 0!==ATON.Photon.uid&&$("#idVRCusernameBTN").addClass("atonVRCu"+ATON.Photon.uid%6),$("#idChatBoxPopup").append(ATON.Photon._elChat),$("#idVRCmsg").keypress(e=>{if("13"==(e.keyCode?e.keyCode:e.which)){let e=$("#idVRCmsg").val();ATON.Photon.setMessage(e),$("#idVRCmsg").val("")}}),$("#idVRCusername").keypress(e=>{if("13"==(e.keyCode?e.keyCode:e.which)){let e=$("#idVRCusername").val();ATON.Photon.setUsername(e),$("#idVRCusername").hide(),$("#idVRCusernameBTN").html(ATON.Photon._username),$("#idVRCusernameBTN").show()}}),$("#idVRCusernameBTN").click(()=>{$("#idVRCusername").show(),$("#idVRCusernameBTN").hide()}),$("#idVRCdisconnect").click(()=>{ATON.Photon.disconnect(),ATON.FE.popupClose()}))},R.checkAuth=e=>{ATON.Utils.checkAuth(t=>{R._userAuth=t,void 0!==t.username?($("#btn-user").addClass("switchedON"),void 0===ATON.Photon._username&&ATON.Photon.setUsername(t.username)):$("#btn-user").removeClass("switchedON"),e&&e(t)})},R.popupUser=()=>{R.checkAuth(e=>{if(void 0!==e.username){let t="<img src='"+R.PATH_RES_ICONS+"user.png'><br>";if(t+="<b>'"+e.username+"'</b><br><br>",Object.keys(R._uiProfiles).length>0){t+="UI Profile:<br><div class='select' style='width:150px;'><select id='idUIProfiles'>";for(let e in R._uiProfiles)t+="<option value='"+e+"'>"+e+"</option>";t+="</select><div class='selectArrow'></div></div><br><br>"}if(t+="<div class='atonBTN atonBTN-red atonBTN-text atonBTN-horizontal' id='idLogoutBTN'>LOGOUT</div>",!ATON.FE.popupShow(t))return;R._uiCurrProfile&&(console.log(R._uiCurrProfile),$("#idUIProfiles").val(R._uiCurrProfile)),$("#idLogoutBTN").click(()=>{$.get(ATON.PATH_RESTAPI+"logout",e=>{console.log(e),ATON.SceneHub.setEditMode(!1),R.uiSwitchButton("edit",!1),ATON.fire("Logout"),$("#btn-user").removeClass("switchedON")}),ATON.FE.popupClose()}),$("#idSHUscenes").click(()=>{ATON.Utils.goToURL("/shu/scenes/")}),$("#idSHUuser").click(()=>{ATON.Utils.goToURL("/shu/auth/")}),$("#idUIProfiles").on("change",()=>{let e=$("#idUIProfiles").val();R.uiLoadProfile(e),ATON.FE.popupClose()})}else{let e="<img src='"+R.PATH_RES_ICONS+"user.png'><br>";if(e+="username:<input id='idUsername' type='text' maxlength='15' size='15' ><br>",e+="password:<input id='idPassword' type='password' maxlength='15' size='15' ><br>",e+="<div class='atonBTN atonBTN-green atonBTN-text atonBTN-horizontal' id='idLoginBTN'>LOGIN</div>",!ATON.FE.popupShow(e))return;$("#idLoginBTN").click(()=>{let e=JSON.stringify({username:$("#idUsername").val(),password:$("#idPassword").val()});$.ajax({url:ATON.PATH_RESTAPI+"login",type:"POST",data:e,contentType:"application/json; charset=utf-8",dataType:"json",success:e=>{console.log(e),e&&(ATON.fire("Login",e),$("#btn-user").addClass("switchedON"),ATON.FE.popupClose())}}).fail(e=>{$("#idLoginBTN").html("LOGIN FAILED"),$("#idLoginBTN").attr("class","atonBTN atonBTN-red")})})}})},R.popupSceneInfo=()=>{let e=ATON.SceneHub.getTitle();void 0===e&&(e=ATON.SceneHub.currID);let t=ATON.SceneHub.getDescription(),o="<div class='atonPopupTitle'>"+e+"</div>";t&&(o+="<div class='atonPopupDescriptionContainer'>"+JSON.parse(t)+"</div>"),o+="<div class='atonBTN atonBTN-green' id='btnOK' style='width:90%'>OK</div>",ATON.FE.popupShow(o)&&$("#btnOK").click(()=>{ATON._onUserInteraction(),ATON.FE.popupClose()})},R.computeSelectorRanges=()=>{let e=ATON.bounds.radius;e<=0||(R._selRanges[0]=.001*e,R._selRefRadius=.01*e,R._selRanges[1]=.5*e)},R.popupSelector=()=>{let e="<div class='atonPopupTitle'>3D Selector</div>",t=ATON.SUI.getSelectorRadius(),o=ATON.Utils.getHumanReadableDistance(t);R.computeSelectorRanges(),e+="Radius (<span id='idSelRadTxt'>"+o+"</span>):<br>",e+="<input id='idSelRad' type='range' min='"+R._selRanges[0]+"' max='"+R._selRanges[1]+"' step='"+R._selRanges[0]+"' style='width:90%'>",ATON.FE.popupShow(e,"atonPopupLarge")&&($("#idSelRad").val(t),$("#idSelRad").on("input change",()=>{let e=parseFloat($("#idSelRad").val());ATON.SUI.setSelectorRadius(e),$("#idSelRadTxt").html(ATON.Utils.getHumanReadableDistance(e))}))},R.popupNav=()=>{let e="<div class='atonPopupTitle'>Navigation</div>";e+="<div style='display:block; width:90%; min-height:50px; vertical-align:top'>",e+="<div style='display:inline-block; width:60px; float:left' id='idNMfp'></div>",e+="<div style='text-align:left'>Switch between first-person and orbit navigation mode</div>",e+="</div>",ATON.Utils.isConnectionSecure()&&(e+="<div style='display:block; width:90%; min-height:50px; vertical-align:top'>",e+="<div style='display:inline-block; width:60px; float:left' id='idNMvr'></div>",e+="<div style='text-align:left'>Immersive VR mode</div>",e+="</div>",ATON.Utils.isMobile()&&(e+="<div style='display:block; width:90%; min-height:50px; vertical-align:top'>",e+="<div style='display:inline-block; width:60px; float:left' id='idNMdevori'></div>",e+="<div style='text-align:left'>Enable or disable device-orientation mode</div>",e+="</div>")),R.popupShow(e)&&(R.uiAddButtonFirstPerson("idNMfp"),R.uiAddButtonDeviceOrientation("idNMdevori"),R.uiAddButtonVR("idNMvr"))},R.popupModalToken=(e,t)=>{if(void 0===t)return;ATON.FE.popupClose();let o="<div class='atonPopupTitle'>Token Required</div>";e&&(o+=e),o+="<br><input id='idTokStr' style='width:90%' type='text' placeholder='paste your token here'><br>",o+="<br><div class='atonBTN atonBTN-green atonBTN-horizontal atonBTN-text' id='btnTokenOK'>OK</div>",R.popupShow(o)&&$("#btnTokenOK").click(()=>{let e=$("#idTokStr").val();void 0===e||e.length<2||(ATON.FE.popupClose(),t(e))})},R.popupNewNode=e=>{void 0===e&&(e=ATON.NTYPES.SCENE);let t="";e===ATON.NTYPES.SCENE&&(t="<div class='atonPopupTitle'>New Scene Node</div>"),e===ATON.NTYPES.SEM&&(t="<div class='atonPopupTitle'>New Semantic Node</div>"),t+="<strong>ID</strong>: <input id='idNID' type='text' size='20' placeholder='node-id'><br>",t+="<div class='atonBTN atonBTN-green atonBTN-horizontal atonBTN-text' id='btnNewNID'><img src='"+ATON.FE.PATH_RES_ICONS+"add.png'>Add</div><br>",R.popupShow(t)&&$("#btnNewNID").click(()=>{let t=$("#idNID").val().trim();void 0===t||t.length<3||new ATON.Node(t,e).attachToRoot()})};const y=R;let w={auType:"audio/wav",auStreamSegmentInterval:200,auStreamNumSegments:2,vidStreamSegmentInterval:300,vidStreamNumSegments:1,auMinVol:1,init:()=>{w._bAudioRecording=!1,w._bAudioStreaming=!1,w._bScreenRec=!1,w._blobOptAudio={type:"audio/wav"},w._blobOptVideo={type:"video/mp4"},w._cAuStream={audio:{channelCount:1,echoCancellation:!0,noiseSuppression:!0}},w._cAuRec={audio:{channelCount:1}},w._cScreenRec={video:{width:1280,height:720,framerate:30}},w._cScreenStream={video:{cursor:"always",width:{max:640},height:{max:360},framerate:15}},w._cCamStream={video:{width:{max:512},height:{max:512}}},w._oStream={audioBitsPerSecond:9e3,videoBitsPerSecond:5e5},w._aurec=void 0,w._sblob=void 0,w._schunks=[],w._bVideoStream=!1,w._vrec=void 0,w._scblob=void 0,w._scchunks=[],w._bCamStream=!1,w._bScreenStream=!1,w._setupFR(),w.detectDevices(),navigator.mediaDevices&&navigator.mediaDevices.addEventListener("devicechange",e=>{w.detectDevices()}),w._vStreams={}},_setupFR:()=>{w._frAR=new window.FileReader,w._frAR.onloadend=()=>{let e=w._frAR.result;ATON.fire("AudioRecordCompleted",e),w._bAudioRecording=!1},w._frAS=new window.FileReader,w._frAS.onloadend=()=>{if(!w._bAudioStreaming)return;let e=w._frAS.result;ATON.Photon.socket.emit("UTALK",{audio:e,uid:ATON.Photon.uid}),e=null},w._frVS=new window.FileReader,w._frVS.onloadend=()=>{if(!w._bVideoStream)return;let e=w._frVS.result;ATON.Photon.socket.emit("UVIDEO",{video:e,uid:ATON.Photon.uid}),e=null}},detectDevices:()=>{w.audioInputDevices=[],w.videoInputDevices=[],navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices().then(e=>{for(let t in e){let o=e[t];"audioinput"===o.kind&&w.audioInputDevices.push(o),"videoinput"===o.kind&&w.videoInputDevices.push(o)}})},hasAudioInput:()=>w.audioInputDevices.length>0,hasVideoInput:()=>w.videoInputDevices.length>0,isAudioRecording:()=>w._bAudioRecording,startRecording:()=>{w._bAudioRecording?console.log("Already recording."):navigator.mediaDevices.getUserMedia(w._cAuRec).then(e=>{w._aurec=new MediaRecorder(e),w._aurec.onstart=function(e){console.log("Start recording..."),w._bAudioRecording=!0,w._schunks=[]},w._aurec.ondataavailable=function(e){w._schunks.push(e.data)},w._aurec.onstop=function(e){console.log("Stop recording..."),w._sblob=new Blob(w._schunks,w._blobOptAudio),w._frAR.readAsDataURL(w._sblob)},w._aurec.start()}).catch(e=>{console.log(e)})},stopRecording:()=>{w._aurec&&w._bAudioRecording&&w._aurec.stop()},startOrStopRecording:()=>{w._bAudioRecording?w.stopRecording():w.startRecording()},startAudioStreaming:()=>{navigator.mediaDevices.getUserMedia(w._cAuStream).then(e=>{w._aurec=new MediaRecorder(e,w._oStream),w._aurec.start(w.auStreamSegmentInterval),console.log("Start audio streaming"),ATON.fire("MediaFlow_AudioStream",!0),w._aurec.onstart=e=>{w._bAudioStreaming=!0,w._bAudioRecording=!0,w._schunks=[]},w._aurec.ondataavailable=e=>{e.data.size<=0||(w._schunks.push(e.data),w._schunks.length<w.auStreamNumSegments||"inactive"!==w._aurec.state&&w._aurec.stop())},w._aurec.onstop=e=>{w._sblob=new Blob(w._schunks,w._blobOptAudio),w._frAS.readAsDataURL(w._sblob),w._bAudioStreaming&&w._aurec.start(w.auStreamSegmentInterval)}}).catch(e=>{console.log(e)})},stopAudioStreaming:()=>{w._aurec&&w._bAudioStreaming&&("inactive"!==w._aurec.state&&w._aurec.stop(),console.log("Stop audio streaming"),w._bAudioStreaming=!1,w._bAudioRecording=!1,ATON.fire("MediaFlow_AudioStream",!1),ATON.Photon.socket.emit("UAUDIOSTOP",{uid:ATON.Photon.uid}))},startOrStopAudioStreaming:()=>{w._bAudioRecording?w.stopAudioStreaming():w.startAudioStreaming()},startScreenRecording:()=>{w._bScreenRec||w._bScreenStream||navigator.mediaDevices.getDisplayMedia(w._cScreenRec).then(e=>{w._vrec=new MediaRecorder(e),w._scchunks=[],w._vrec.ondataavailable=e=>{e.data.size>0&&w._scchunks.push(e.data)},w._vrec.onstop=()=>{w._scblob=new Blob(w._scchunks,w._blobOptVideo),console.log(w._scblob.size),ATON.Utils.downloadBlob(w._scblob,"capture.mp4"),w._scchunks=[],w._bScreenRec=!1},w._vrec.start(200),w._bScreenRec=!0,ATON.fire("MediaFlow_ScreenRec",!0)}).catch(e=>{console.log(e)})},stopScreenRecording:()=>{w._bScreenRec&&(w._vrec.stop(),w._bVideoStream=!1,w._bScreenStream=!1,console.log("Stop screen recording"),ATON.fire("MediaFlow_ScreenRec",!1))},startScreenStreaming:()=>{navigator.mediaDevices.getDisplayMedia(w._cScreenStream).then(e=>{w.realizeOrUpdateVStream(e,w.stopScreenStreaming),w._vrec=new MediaRecorder(e,w._oStream),w._vrec.start(w.vidStreamSegmentInterval),console.log("Start screen streaming"),ATON.fire("MediaFlow_ScreenStream",!0),w._vrec.onstart=e=>{w._bVideoStream=!0,w._bScreenStream=!0,w._scchunks=[]},w._vrec.ondataavailable=e=>{e.data.size<1||(w._scchunks.push(e.data),w._scchunks.length<w.vidStreamNumSegments||"inactive"!==w._vrec.state&&w._vrec.stop())},w._vrec.onstop=()=>{w._scblob=new Blob(w._scchunks,w._blobOptVideo),w._frVS.readAsDataURL(w._scblob),w._bVideoStream&&w._vrec.start(w.vidStreamSegmentInterval)}}).catch(e=>{console.log(e)})},stopScreenStreaming:()=>{if(w._vrec&&w._bVideoStream){if(w._vrec.stop(),w._bVideoStream=!1,w._bScreenStream=!1,console.log("Stop screen streaming"),void 0!==ATON.Photon.uid){let e=w.getVideoStream(ATON.Photon.uid);e.el.style.display="none",e.el.pause(),ATON.Photon.socket.emit("UVIDEOSTOP",{uid:ATON.Photon.uid})}ATON.fire("MediaFlow_ScreenStream",!1)}},startOrStopScreenStreaming:()=>{w._bVideoStream?w.stopScreenStreaming():w.startScreenStreaming()},startCameraStreaming:()=>{w._bVideoStream||navigator.mediaDevices.getUserMedia(w._cCamStream).then(e=>{w.realizeOrUpdateVStream(e,w.stopCameraStreaming),w._vrec=new MediaRecorder(e,w._oStream),w._vrec.start(w.vidStreamSegmentInterval),console.log("Start camera streaming"),ATON.fire("MediaFlow_CamStream",!0),w._vrec.onstart=e=>{w._bVideoStream=!0,w._bCamStream=!0,w._scchunks=[]},w._vrec.ondataavailable=e=>{e.data.size<1||(w._scchunks.push(e.data),w._scchunks.length<w.vidStreamNumSegments||"inactive"!==w._vrec.state&&w._vrec.stop())},w._vrec.onstop=()=>{w._scblob=new Blob(w._scchunks,w._blobOptVideo),w._frVS.readAsDataURL(w._scblob),w._bVideoStream&&w._vrec.start(w.vidStreamSegmentInterval)}}).catch(e=>{console.log(e)})},stopCameraStreaming:()=>{if(w._vrec&&w._bVideoStream){if(w._vrec.stop(),w._bVideoStream=!1,w._bCamStream=!1,console.log("Stop camera streaming"),void 0!==ATON.Photon.uid){let e=w.getVideoStream(ATON.Photon.uid);e.el.style.display="none",e.el.pause(),ATON.Photon.socket.emit("UVIDEOSTOP",{uid:ATON.Photon.uid})}ATON.fire("MediaFlow_CamStream",!1)}},startOrStopCameraStreaming:()=>{w._bVideoStream?w.stopCameraStreaming():w.startCameraStreaming()},realizeOrUpdateVStream:(e,t)=>{let o=ATON.Photon.uid;if(void 0===o)return;let i=w.getOrCreateVideoStream(o,void 0,!0);i.el.playsinline=!0,i.el.style.display="inline-block",i.el.classList.add("atonVRCvidStream"),i.el.classList.add("atonVRCu"+o%6),t&&(i.el.onclick=t),i.el.srcObject=e},stopAllStreams:()=>{w.stopAudioStreaming(),w.stopCameraStreaming(),w.stopScreenStreaming()},getOrCreateVideoStream:(e,t,o)=>{if(w._vStreams[e])t&&(w._vStreams[e].el.src=t);else{w._vStreams[e]={};let i="vStream-"+e;if(o&&(i="uStream"+e,w._vStreams[e].uid=e),$("<video id='"+i+"' autoplay crossorigin='anonymous' style='display:none' ></video>").appendTo("body"),w._vStreams[e].el=document.getElementById(i),t)if(t.endsWith("m3u8"))if(Hls.isSupported()){let o=new Hls;o.loadSource(t),o.attachMedia(w._vStreams[e].el)}else w._vStreams[e].el.src=t;else w._vStreams[e].el.src=t;o||(w._vStreams[e].el.loop=!0),w._vStreams[e].texStream=new THREE.VideoTexture(w._vStreams[e].el),w._vStreams[e].texStream.colorSpace=ATON._stdEncoding,w._vStreams[e].texStream.flipY=!1,w._vStreams[e].matStream=ATON.MatHub.materials.chromakey.clone(),w._vStreams[e].matStream.uniforms.tBase.value=w._vStreams[e].texStream}return w._vStreams[e]},getVideoStream:e=>w._vStreams[e],downloadVideoSnapshot:(e,t,o)=>{o||(o=1);let i=e.videoWidth*o,r=e.videoHeight*o,a=document.createElement("canvas");a.width=i,a.height=r,a.getContext("2d").drawImage(e,0,0,i,r),ATON.Utils.downloadImageFromCanvas(a,t)}};const M=w;let C={EARTH_R_KM:6371};C.EARTH_D_KM=2*C.EARTH_R_KM,C.init=()=>{C._bActive=!1,C._wpid=void 0,C._currGeoPos=new THREE.Vector2,C._GeoPOIs=[],C._currGeoPOI=void 0,C._closestGeoPOI=void 0,C._maxGeoError=40},C.enableGeoTracking=()=>{C._bActive||ATON.Utils.isConnectionSecure()&&navigator.geolocation&&(C._wpid=navigator.geolocation.watchPosition(C._onGeoPosition,C._onGeoError,{enableHighAccuracy:!0}),C._bActive=!0)},C.disableGeoTracking=()=>{C._bActive&&(navigator.geolocation.clearWatch(C._wpid),C._bActive=!1)},C.setMaxGeoError=e=>{e>0&&(C._maxGeoError=e)},C._onGeoError=()=>{console.log("Geolocation error")},C._onGeoPosition=e=>{if(!C._bActive)return;if(!e.coords)return;let t=e.coords.accuracy;t&&t>C._maxGeoError||(C._currGeoPos.x=e.coords.latitude,C._currGeoPos.y=e.coords.longitude,ATON.fire("GeoLocation",e),C._handleGeoPOIs())},C._handleGeoPOIs=()=>{let e=C._GeoPOIs.length;if(!(e<=0)){C._closestGeoPOIdist=void 0,C._closestGeoPOI=void 0;for(let t=0;t<e;t++){let e=C._GeoPOIs[t],o=C.geodistance(C._currGeoPos,e.pos);(void 0===C._closestGeoPOIdist||o<C._closestGeoPOIdist)&&(C._closestGeoPOIdist=o,C._closestGeoPOI=t),o<=e.radius?(C._currGeoPOI!==t&&ATON.fire("EnterGeoPOI",{id:t,distance:o}),C._currGeoPOI=t):(void 0!==C._currGeoPOI&&ATON.fire("LeaveGeoPOI",{id:C._currGeoPOI,distance:o}),C._currGeoPOI=void 0)}}},C.getCurrentGeoLocation=()=>{if(C._bActive)return C._currGeoPos},C.geolocationFromLatLon=(e,t)=>new THREE.Vector2(e,t),C.geodistance_orig=(e,t)=>{let o=ATON.DEG2RAD*(t.x-e.x),i=ATON.DEG2RAD*(t.y-e.y),r=Math.sin(o/2)*Math.sin(o/2)+Math.cos(ATON.DEG2RAD*e.x)*Math.cos(ATON.DEG2RAD*t.x)*Math.sin(i/2)*Math.sin(i/2),a=2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r));return C.EARTH_R_KM*a*1e3},C.geodistance=(e,t)=>{let o=.5-Math.cos((t.x-e.x)*ATON.DEG2RAD)/2+Math.cos(e.x*ATON.DEG2RAD)*Math.cos(t.x*ATON.DEG2RAD)*(1-Math.cos((t.y-e.y)*ATON.DEG2RAD))/2;return C.EARTH_D_KM*Math.asin(Math.sqrt(o))*1e3},C.addGeoPOI=(e,t)=>{let o={};return o.pos=new THREE.Vector2(e.x,e.y),o.radius=t,C._GeoPOIs.push(o),C._bActive||C.enableTracking(),C._handleGeoPOIs(),C._GeoPOIs.length-1},C.getGeoPOIbyIndex=e=>C._GeoPOIs[e],C.getClosestGeoPOI=()=>C._closestGeoPOI,C.getClosestGeoPOIdistance=()=>C._closestGeoPOIdist;const L=C;let D={};D._id=$("meta[name='aton\\:appid']").attr("content"),D._data={},D.setup=void 0,D.update=void 0,D._bRunning=!1,D._pDeps=[],D._fLoading=0,D._sendDataPatch=(e,t,o)=>new Promise((i,r)=>{if(void 0===e)return void r("No storage ID specified");if(e.length<3)return void r("Storage ID too short");if(void 0===t)return void r("No storage patch");if(void 0===D._id)return void r("No app-ID");void 0===o&&(o=ATON.PATCH_ADD);let a={};a.wappid=D._id,a.fid=e,a.data=t,a.mode=o===ATON.PATCH_DEL?"DEL":"ADD";let n=JSON.stringify(a);$.ajax({url:ATON.PATH_RESTAPI+"patch/wapp",type:"POST",data:n,contentType:"application/json; charset=utf-8",dataType:"json",success:t=>{void 0!==t?(D._data[e]=t,i(t)):r("Error writing on server")}})}),D.getAppID=()=>D._id,D.addToStorage=(e,t)=>D._sendDataPatch(e,t,ATON.PATCH_ADD),D.deleteFromStorage=(e,t)=>D._sendDataPatch(e,t,ATON.PATCH_DEL),D.getStorage=e=>new Promise((t,o)=>{void 0!==D._id?void 0!==e?$.getJSON(ATON.PATH_WAPPS+D._id+"/data/"+e+".json",o=>{console.log(o),D._data[e]=o,t(o)}):o("No storage ID specified"):o()}),D.loadJSONConfig=(e,t)=>(ATON.Utils.getJSON(e,t),D),D.registerServiceWorker=e=>{if(e)return D.basePath&&(e=D.basePath+e),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register(e).then(e=>console.log("PWA service worker registered")).catch(e=>console.log("PWA service worker not registered",e))}),D},D.requireFlares=e=>{if(e)return ATON._fReqList=e,console.log("Required Flares: "+ATON._fReqList),D},D.loadScene=(e,t)=>{void 0!==e&&ATON.SceneHub.load(ATON.PATH_RESTAPI2+"scenes/"+e,e,t)},D.realize=(e,t,o)=>{D.setup=e,D.update=t,D.params=new URLSearchParams(window.location.search),D.basePath=ATON.Utils.getBaseFolder(window.location.href.split("?")[0]),D.registerServiceWorker(o);let i=D.params.get("ff");if(i){let e=String(i).split(",");D.requireFlares(e)}return window.addEventListener("load",()=>{D.run()}),D},D.run=()=>!D._bRunning&&(D._bRunning=!0,D.setup?D.setup():(ATON.realize(),console.log("App [Warn]: your App should define a setup() routine")),D.update&&(ATON.addUpdateRoutine(D.update),console.log("App: update routine registered")),ATON._fRequired<=0&&ATON.fire("AllFlaresReady"),!0);const H=D;let x={PASS_BASE:"p_base",PASS_AA:"p_aa",PASS_AO:"p_ao",PASS_SSR:"p_ssr",PASS_BLOOM:"p_bloom",PASS_DOF:"p_dof",PASS_GAMMA:"p_gamma",PASS_SOBEL:"p_sobel",init:()=>{if(void 0===ATON._renderer)return;let e=ATON._renderer.getPixelRatio(),t=ATON._renderer.getSize(new THREE.Vector2);const o=new THREE.WebGLRenderTarget(t.width*e,t.height*e,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,colorSpace:ATON._stdEncoding});o.texture.name="EffectComposer.rt1",x.composer=new THREE.EffectComposer(ATON._renderer,o),x.passes={},ATON._renderer.autoClear=!1;let i=window.innerWidth*ATON._stdpxd,r=window.innerHeight*ATON._stdpxd;x.passes[x.PASS_BASE]=new THREE.RenderPass(ATON._mainRoot,ATON.Nav._camera),x.composer.addPass(x.passes[x.PASS_BASE]),x.passes[x.PASS_AO]=new THREE.SAOPass(ATON._mainRoot,ATON.Nav._camera,i,r),x.passes[x.PASS_AO].params.saoBias=1,x.passes[x.PASS_AO].params.saoScale=100,x.passes[x.PASS_AO].params.saoIntensity=.2,x.passes[x.PASS_BLOOM]=new THREE.UnrealBloomPass(new THREE.Vector2(i,r),1.5,.4,.85),x.passes[x.PASS_BLOOM].threshold=.9,x.passes[x.PASS_BLOOM].strength=1,x.passes[x.PASS_BLOOM].radius=1.2,x.passes[x.PASS_DOF]=new THREE.BokehPass(ATON._mainRoot,ATON.Nav._camera,{focus:5,aperture:.001,maxblur:.01,width:i,height:r}),x.composer.addPass(x.passes[x.PASS_AO]),x.composer.addPass(x.passes[x.PASS_DOF]),x.composer.addPass(x.passes[x.PASS_BLOOM]),x.reset()},reset:()=>{x.togglePass(x.PASS_AO,!1),x.togglePass(x.PASS_BLOOM,!1),x.togglePass(x.PASS_DOF,!1)},togglePass:(e,t)=>{void 0!==x.composer&&(ATON.device.lowGPU||void 0!==x.passes[e]&&(x.passes[e].enabled=void 0===t?!x.passes[e].enabled:t))},isPassEnabled:e=>void 0!==x.composer&&(void 0!==x.passes[e]&&x.passes[e].enabled),setAOintensity:e=>{void 0!==x.composer&&void 0!==x.passes[x.PASS_AO]&&(x.passes[x.PASS_AO].params.saoIntensity=e)},getAOintensity:()=>void 0===x.composer||void 0===x.passes[x.PASS_AO]?0:x.passes[x.PASS_AO].params.saoIntensity,setBloomStrength:e=>{void 0!==x.composer&&void 0!==x.passes[x.PASS_BLOOM]&&(x.passes[x.PASS_BLOOM].strength=e)},getBloomStrength:()=>void 0===x.composer||void 0===x.passes[x.PASS_BLOOM]?0:x.passes[x.PASS_BLOOM].strength,setBloomThreshold:e=>{void 0!==x.composer&&void 0!==x.passes[x.PASS_BLOOM]&&(x.passes[x.PASS_BLOOM].threshold=e)},getBloomThreshold:()=>void 0===x.composer||void 0===x.passes[x.PASS_BLOOM]?0:x.passes[x.PASS_BLOOM].threshold,setDOFfocus:e=>{if(void 0===x.composer)return;if(void 0===x.passes[x.PASS_DOF])return;let t=x.passes[x.PASS_DOF].uniforms;void 0!==t&&(t.focus.value=e)},getDOFfocus:()=>{if(void 0===x.composer)return 0;if(void 0===x.passes[x.PASS_DOF])return 0;let e=x.passes[x.PASS_DOF].uniforms;return void 0===e?0:e.focus.value},setDOFaperture:e=>{if(void 0===x.composer)return;if(void 0===x.passes[x.PASS_DOF])return;let t=x.passes[x.PASS_DOF].uniforms;void 0!==t&&(t.aperture.value=e)}};const I=x;let F={STD_XPF_TRANSITION_DURATION:1,SEM_PREFIX:"XPF",SEMGROUP_PREFIX:"GXPF",init:()=>{F._list=[],F._iCurr=void 0,F._iNext=void 0,F._geom=void 0,F._mesh=void 0,F._mat=void 0,F._size=50,F._gSem=[],F._semIMGMasks={},F._semCanvas=void 0,F._semCTX=void 0,F._semCurr=void 0,F._shColor=new THREE.Color(0,0,1),F._shOpacity=.2,F._txCache={},F._pathMod=void 0,F._realizeBaseMat(),F._elVid=void 0,F._vidPlaying=!1},_realizeBaseMat:()=>{F._uniforms={tBase:{type:"t"},tSem:{type:"t"},tSemHint:{type:"t"},semHL:{type:"vec4",value:new THREE.Vector4(0,1,0,.15)},opacity:{type:"float",value:1},shColor:{type:"vec4",value:new THREE.Vector4(0,0,1,.2)},time:{type:"float",value:0}},F._mat=new THREE.ShaderMaterial({uniforms:F._uniforms,vertexShader:"\n            varying vec3 vPositionW;\n            varying vec3 vNormalW;\n            varying vec3 vNormalV;\n            varying vec2 vUv;\n\n            void main(){\n                vUv = uv;\n\n                vPositionW = vec3( vec4( position, 1.0 ) * modelMatrix);\n                vNormalW   = normalize( vec3( vec4( normal, 0.0 ) * modelMatrix ) );\n                vNormalV   = normalize( vec3( normalMatrix * normal ));\n\n                gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n            }\n        ",fragmentShader:"\n            varying vec3 vPositionW;\n\t\t    varying vec3 vNormalW;\n            varying vec3 vNormalV;\n            varying vec2 vUv;\n\n            uniform float time;\n            uniform sampler2D tBase;\n            uniform sampler2D tSem;\n            uniform sampler2D tSemHint;\n            //uniform sampler2D tDepth;\n\n            uniform vec4 semHL, shColor;\n            uniform float opacity;\n\n\t\t    void main(){\n                vec4 frag = texture2D(tBase, vUv);\n                vec4 sem  = texture2D(tSem, vUv);\n                vec4 semH = texture2D(tSemHint, vUv);\n                float shv = max( max(semH.r,semH.g), semH.b);\n\n                float t = (1.0 * cos(time*2.0));\n                t = clamp(t, 0.0,1.0);\n\n                frag = mix(frag, semHL, (sem.r * semHL.a));\n\n                frag = mix(frag, shColor, (t * shv * shColor.a));\n\n                frag.a = opacity;\n\n                gl_FragColor = frag;\n\t\t    }\n        ",depthTest:!1,depthWrite:!1}),F.setSemanticHintMapOpacity(.2)},setPathModifier:e=>{if(void 0!==e){F._pathMod=e;for(let t in F.list)F.list[t].setPathModifier(e)}},update:()=>{if(ATON.Nav.isTransitioning())return;if(F._list.length<1)return;let e,t,o,i,r=F._list.length,a=ATON.Nav._currPOV.pos,n=ATON.Nav._vDir;F._uniforms.time.value+=ATON._dt,void 0===F._dirLNode&&(F._dirLNode=new THREE.Vector3);for(let s=0;s<r;s++){let r=F._list[s],l=a.distanceToSquared(r._location);(void 0===e||l<e)&&(e=l,t=s),s!==F._iCurr&&(F._dirLNode.x=r._location.x-a.x,F._dirLNode.y=r._location.y-a.y,F._dirLNode.z=r._location.z-a.z,F._dirLNode=F._dirLNode.normalize(),F._dirLNode.dot(n)>.8&&(void 0===o||l<o)&&(o=l,i=s))}i!==F._iNext&&(F.toggleSUI(i,!0),ATON.fire("NextXPF",i)),F._iNext=i,F.querySemanticMasks(),t!==F._iCurr&&(void 0!==F._iCurr&&F._gSem[F._iCurr].hide(),F.setCurrentXPF(t))},realizeBaseGeometry:()=>{void 0===F._geom&&(F._group=new THREE.Group,ATON._rootVisibleGlobal.add(F._group),F._geom=new THREE.SphereGeometry(1,40,40),F._geom.scale(-F._size,F._size,F._size),F._geom.castShadow=!1,F._geom.receiveShadow=!1,F._mesh=new THREE.Mesh(F._geom,F._mat),F._mesh.frustumCulled=!1,F._mesh.renderOrder=-100,F._mesh.layers.enable(ATON.NTYPES.SCENE),F._group.add(F._mesh),F._mesh.visible=!1)},setBaseGeometry:e=>{},add:e=>{if(void 0===e)return;F.realizeBaseGeometry();let t=F._list.length;F._list.push(e);let o=e.getMesh();o&&F._group.add(o);let i=ATON.getOrCreateSemanticNode(F.SEMGROUP_PREFIX+t);F._gSem.push(i),i.attachToRoot(),t>0||(ATON.Nav.toggleLocomotionValidator(!1),ATON._bqScene=!0)},clear:()=>{F._iCurr=void 0,F._iNext=void 0,F._semCurr=void 0;for(let e=0;e<F._list.length;e++){let t=F._list[e];t=null,F._gSem[e]&&(F._gSem[e].removeChildren(),F._gSem[e]=null)}F._gSem=[],F._list=[]},getNumXPFs:()=>F._list.length,getMainGroup:()=>F._group,getSemanticGroup:e=>F._gSem[e],getCurrentSemanticGroup:()=>{if(void 0!==F._iCurr)return F._gSem[F._iCurr]},_preloadBaseLayer:(e,t)=>{if(void 0!==F._txCache[e])return F._txCache[e];let o=F._list[e]._pathbaselayer;F._pathMod&&(o=F._pathMod(o)),ATON.Utils.textureLoader.load(o,o=>{o.colorSpace=ATON._stdEncoding,o.generateMipmaps=!0,F._txCache[e]=o,t&&t(o)})},_clearTexCache:()=>{if(void 0!==F._iCurr)for(let e in F._txCache)F._txCache[e]&&e!==F._iCurr&&(F._txCache[e].dispose(),F._txCache[e]=void 0)},_setBaseLayerTexture:(e,t)=>{F._mat.map=t,F._mat.needsUpdate=!0,F._mesh.position.copy(e.getLocation()),F._mesh.rotation.set(e.getRotation().x,e.getRotation().y,e.getRotation().z)},updateCurrentXPFbaseLayer:e=>{if(void 0===F._iCurr)return;let t=F._list[F._iCurr];if(void 0===t)return;let o=t._pathbaselayer;if(F._pathMod&&(o=F._pathMod(o)),ATON.Utils.isVideo(o)){if(void 0===F._elVid){let e="<video id='idXPFVideo' loop crossOrigin='anonymous' playsinline style='display:none'>";e+="<source src='"+o+"'>",e+="</video>",$(e).appendTo("body"),F._elVid=document.getElementById("idXPFVideo"),F._elVid.onplaying=()=>{console.log("XPF VideoPano playing"),F._vidPlaying=!0},F._elVid.onpause=()=>{console.log("XPF VideoPano paused"),F._vidPlaying=!1},F._elVid.addEventListener("touchstart",function(){F._elVid.play()}),enableInlineVideo(F._elVid)}let i=new THREE.VideoTexture(F._elVid);return i.colorSpace=ATON._stdEncoding,F._mat.map=i,F._mat.needsUpdate=!0,F._uniforms.tBase.value=i,F._mesh.position.copy(t.getLocation()),F._mesh.rotation.set(t.getRotation().x,t.getRotation().y,t.getRotation().z),void(e&&e(i))}ATON.Utils.textureLoader.load(o,o=>{o.colorSpace=ATON._stdEncoding,o.generateMipmaps=!0,F._mat.map=o,F._mat.needsUpdate=!0,F._uniforms.tBase.value=o,F._mesh.position.copy(t.getLocation()),F._mesh.rotation.set(t.getRotation().x,t.getRotation().y,t.getRotation().z),e&&e(o)})},playOrPauseXPFVideoStream:()=>{void 0!==F._elVid&&(F._vidPlaying?F._elVid.pause():F._elVid.play())},updateCurrentXPFsemLayer:e=>{let t=F._list.indexOf(e);t<0||t===F._iCurr&&F.loadSemanticMasksIfAny(F._iCurr)},setCurrentXPF:(e,t)=>{F.toggleSUI(e,!1),F._iCurr=e,F._iNext=void 0,F._mesh.visible=!0,F._gSem[e].show(),F.updateCurrentXPFbaseLayer(t),ATON.fire("CurrentXPF",e),ATON.fire("NextXPF",void 0),F.loadSemanticMasksIfAny(e)},toggleSUI:(e,t)=>{if(void 0===e)return;let o=F._list[e];void 0!==o&&o._lnode.toggleSUI(t)},loadSemanticMasksIfAny:e=>{let t=F._list[e];if(void 0!==t){F._semIMGMasks={},F._uniforms.tSemHint.value=0,void 0!==t._semHintURL&&(F._uniforms.tSemHint.value=ATON.Utils.textureLoader.load(t._semHintURL));for(let e in t._semMasksURLs){void 0===F._semCanvas&&(F._semCanvas=document.createElement("canvas"),F._semCanvas.width=2048,F._semCanvas.height=2048,F._semCTX=F._semCanvas.getContext("2d",{willReadFrequently:!0}));let o=t._semMasksURLs[e],i=new Image;i.src=o,F._semIMGMasks[e]=i}}},getXPFbyIndex:e=>F._list[e],getCurrentXPFindex:()=>F._iCurr,getCurrentXPF:()=>{if(void 0!==F._iCurr)return F._list[F._iCurr]},getNextXPFindex:()=>F._iNext,getNextXPF:()=>{if(void 0!==F._iNext)return F._list[F._iNext]},getDistanceToXPFindex:e=>{if(void 0===e)return;let t=F._list[e];return void 0!==t?ATON.Nav._currPOV.pos.distanceTo(t.getLocation()):void 0},showSUIonlyForXPF:e=>{let t=F._list.length;if(!(t<1))for(let o=0;o<t;o++){let t=F._list[o]._lnode;t&&(o==e?t.toggleSUI(!0):t.toggleSUI(!1))}},requestTransitionByIndex:(e,t)=>{let o=F._list[e];void 0!==o&&(void 0===t&&(t=F.STD_XPF_TRANSITION_DURATION),ATON.XR._bPresenting&&(t=0),F.setCurrentXPF(e),ATON.Nav.requestTransitionToLocomotionNode(o.getLocomotionNode(),t))},requestTransitionToTarget:(e,t,o)=>{if(void 0===e)return;let i=new ATON.POV;i.setTarget(e),i.setPosition(ATON.Nav._currPOV.pos),t&&i.setFOV(t),ATON.Nav.requestPOV(i,o)},requestTransitionToDirection:(e,t,o)=>{if(void 0===e)return;let i=new THREE.Vector3;i.x=e.x+ATON.Nav._currPOV.pos.x,i.y=e.y+ATON.Nav._currPOV.pos.y,i.z=e.z+ATON.Nav._currPOV.pos.z,F.requestTransitionToTarget(i,t,o)},setHomeXPF:e=>{let t=F._list[e];if(void 0===t)return;let o=t.getLocomotionNode(),i=(new ATON.POV).setPosition(o.pos).setTarget(o.pos.x,o.pos.y,o.pos.z+1);ATON.Nav.setHomePOV(i)},getSemanticMaskURLfromXPFindex:(e,t)=>{let o=F._list[e];if(void 0!==o)return o.getSemanticMaskURL(t)},getSemanticMaskURLfromCurrentXPF:e=>{if(void 0!==F._iCurr)return F.getSemanticMaskURLfromXPFindex(F._iCurr,e)},setSemanticColor:(e,t)=>{void 0===t&&(t=.15),F._uniforms.semHL.value=new THREE.Vector4(e.r,e.g,e.b,t)},setSemanticOpacity:e=>{void 0===e&&(e=.15),F._uniforms.semHL.value.w=e},setSemanticHintMapOpacity:e=>{void 0===e&&(e=.2),F._shOpacity=e,F._uniforms.shColor.value.w=e},setSemanticHintMapColor:(e,t)=>{void 0!==e&&(F._shColor=e,F._uniforms.shColor.value.x=e.r,F._uniforms.shColor.value.y=e.g,F._uniforms.shColor.value.z=e.b,void 0!==t&&F.setSemanticHintMapOpacity(t))},querySemanticMasks:()=>{if(void 0===F._semCTX)return;if(void 0===ATON._queryDataScene)return;if(void 0===ATON._queryDataScene.uv)return;let e,t=F._semCTX,o=ATON._queryDataScene.uv;for(let i in F._semIMGMasks){let r=F._semIMGMasks[i],a=parseInt(r.width*o.x),n=parseInt(r.height*(1-o.y));if(t.drawImage(r,0,0),t.getImageData(a,n,1,1).data[0]>127){e=i;break}}if(void 0===e)return void 0!==F._semCurr&&ATON.fire("SemanticMaskLeave",F._semCurr),F._semCurr=void 0,F._uniforms.tSem.value=0,F._uniforms.shColor.value.w=F._shOpacity,void(F._mat.needsUpdate=!0);F.highlightSemanticMaskInCurrentXPF(e),F._semCurr=e},highlightSemanticMaskInCurrentXPF:e=>{if(void 0===e)return void 0!==F._semCurr&&ATON.fire("SemanticMaskLeave",F._semCurr),F._semCurr=void 0,F._uniforms.tSem.value=0,F._uniforms.shColor.value.w=F._shOpacity,void(F._mat.needsUpdate=!0);if(F._semCurr===e)return;let t=F.getSemanticMaskURLfromCurrentXPF(e);F._uniforms.tSem.value=ATON.Utils.textureLoader.load(t),F._mat.needsUpdate=!0,ATON.fire("SemanticMaskHover",e),F._uniforms.shColor.value.w=0,void 0!==F._semCurr&&ATON.fire("SemanticMaskLeave",F._semCurr)},loadFromPhotoscanFile:(e,t)=>{if(void 0===e)return;e=ATON.Utils.resolveCollectionURL(e);let o=ATON.Utils.getBaseFolder(e),i=0;$.ajax({url:e,dataType:"text",success:function(e){e=e.split(/\r\n|\n/);for(let t in e){let r=e[t];if(!r.startsWith("#")){let e=r.split(/\s{2,}|\t/);if(e.length>10){let t=new ATON.XPF,r=o+e[0],a=parseFloat(e[1]),n=parseFloat(e[2]),s=parseFloat(e[3]),l=ATON.DEG2RAD*parseFloat(e[4]);ATON.DEG2RAD,parseFloat(e[5]),ATON.DEG2RAD,parseFloat(e[6]),t.setLocation(a,s,-n),t.setBaseLayer(r),t.setRotation(0,-l,0),F.add(t),i++}}}console.log("Num panoramas parsed: "+i),t&&t()}})}};const U=F;let k={init:()=>{k.list=[]},anyCopyrightFound:()=>k.list.length>0,extract:e=>{if(void 0===e)return;if(void 0===e.asset)return;let t={};if(e.asset.copyright&&(t.copyright=e.asset.copyright),e.asset.extras)for(let o in e.asset.extras)"string"==typeof e.asset.extras[o]&&(t[o]=e.asset.extras[o]);if(k.extractXMP3DC(e,t),0!==Object.keys(t).length){e.asset.generator&&(t.generator=e.asset.generator);for(let e in k.list){let o=k.list[e];if(k.compare(t,o))return}k.list.push(t),console.log(t)}},compare:(e,t)=>{if(void 0===e||void 0===t)return!1;const o=Object.keys(e),i=Object.keys(t);if(o.length!==i.length)return!1;for(let i of o)if(e[i]!==t[i])return!1;return!0},extractXMP3DC:(e,t)=>{if(void 0===e||void 0===t)return;if(!e.userData)return;let o=e.userData.gltfExtensions;if(!o)return;if(!o.KHR_xmp)return;let i=o.KHR_xmp.packets;if(!i)return;let r=i[0],a="en-us";r["model3d:spdxLicense"]&&(t.license=r["model3d:spdxLicense"]),r["dc:date"]&&(t.date=r["dc:date"]),r["dc:title"]&&(t.title=r["dc:title"][a]),r["dc:description"]&&(t.description=r["dc:description"][a]),r["dc:rights"]&&(t.rights=r["dc:rights"][a]),r["dc:source"]&&(t.source=r["dc:source"]),r["dc:subject"]&&(t.subject=r["dc:subject"]),r["dc:type"]&&(t.type=r["dc:type"]),r["xmpRights:Owner"]&&(t.owner=r["xmpRights:Owner"]),r["xmp:CreatorTool"]&&(t.creatorTool=r["xmp:CreatorTool"])}};const B=k;let q={REST_API_CESIUMION_DEF_TOKEN:"https://api.cesium.com/v2/tokens/default",THRES_ORI:.01,THRES_POS:1e-6,init:()=>{q._tsets=[],q._tsET=20,q._tsB=!1,q._bTileBVH=!0,q._tsTasks=[],q.tsSchedCB=e=>{q._tsTasks.push(e)},q._tseBase=16,q.estimateTSErrorTarget(),q._tsuSync=0,q._bPCs=!1,q._pqLRU=void 0,q._pqDownload=void 0,q._pqParse=void 0,q._numTilesLoaded=0,q._numTSLoaded=0},clear:()=>{for(let e in q._tsets)q._tsets[e]=null;q._tsets=[],q._bPCs=!1},getTSetsErrorTarget:()=>q._tsET,setTSetsErrorTarget:e=>{q._tsET=e;const t=q._tsets.length;if(!(t<=0))for(let o=0;o<t;o++)q._tsets[o].errorTarget=e},setTSetsDisplayBounds:e=>{q._tsB=e;const t=q._tsets.length;if(!(t<=0))for(let o=0;o<t;o++)q._tsets[o].displayBoxBounds=e},updateTSetsCamera:e=>{void 0===e&&(e=ATON.Nav._camera);const t=q._tsets.length;if(!(t<=0))for(let o=0;o<t;o++){const t=q._tsets[o];for(let e=0;e<t.cameras.length;e++)t.deleteCamera(t.cameras[e]);t.setCamera(e),ATON._renderer.xr.isPresenting?t.setResolution(e,300,300):t.setResolutionFromRenderer(e,ATON._renderer)}},setBaseTSE:e=>{q._tseBase=e,console.log(q._tseBase),q.estimateTSErrorTarget()},estimateTSErrorTarget:()=>{let e=q._tseBase;(ATON.device.lowGPU||ATON.device.isMobile)&&(e*=1.5),ATON.XR._bPresenting&&(e*=1.3),e<1&&(e=1),console.log("Estimated TSet error target: "+e),q.setTSetsErrorTarget(e)},loadTileSetFromURL:(e,t,o)=>{if(void 0===t)return;let i=!1;e.endsWith(".dzi")&&(i=!0);let r=new TILES.TilesRenderer(e);if(!r)return;ATON._assetReqNew(e),r.displayBoxBounds=q._tsB,r.fetchOptions.mode="cors",r.registerPlugin(new TILES.ImplicitTilingPlugin),i&&r.registerPlugin(new TILES.DeepZoomImagePlugin({center:!0})),r.registerPlugin(new TILES.UpdateOnChangePlugin);let a=new TILES.TilesFadePlugin;a.fadeRootTiles=!1,a.fadeDuration=500,r.registerPlugin(a),o&&(r.fetchOptions.headers={},r.fetchOptions.headers.Authorization=`Bearer ${o.accessToken}`,r.preprocessURL=e=>(e=new URL(e),/^http/.test(e.protocol)&&e.searchParams.append("v",o.v),e.toString())),r.errorTarget=q._tsET,i&&(r.errorTarget=2),void 0===q._pqLRU?(r.downloadQueue.schedulingCallback=q.tsSchedCB,r.parseQueue.schedulingCallback=q.tsSchedCB,q._pqLRU=r.lruCache,q._pqDownload=r.downloadQueue,q._pqParse=r.parseQueue):(r.lruCache=q._pqLRU,r.downloadQueue=q._pqDownload,r.parseQueue=q._pqParse),r.setCamera(ATON.Nav._camera),r.setResolutionFromRenderer(ATON.Nav._camera,ATON._renderer),r.manager.addHandler(/\.gltf$/,ATON._aLoader),r.manager.addHandler(/\.ktx2$/,ATON._ktx2Loader),r.manager.addHandler(/\.drc$/,ATON._dracoLoader),t.add(r.group),i||ATON.REQ.get(e,e=>{ATON.CC.extract(e)});let n=new THREE.Box3,s=new THREE.Sphere,l=!1;r.addEventListener("load-tile-set",()=>{if(console.log("TileSet loaded"),ATON._assetReqComplete(e),q._numTSLoaded++,o||t.bUseGeoCoords){console.log("TileSet using GeoCoords"),r.getBoundingSphere(s);const e=s.center.clone(),t=e.length(),o=e.normalize(),i=new THREE.Vector3(0,1,0),a=ATON.Utils.rotationBetweenDirections(o,i);r.group.quaternion.x=a.x,r.group.quaternion.y=a.y,r.group.quaternion.z=a.z,r.group.quaternion.w=a.w,r.group.position.y=-t}else r.getBoundingBox(n)?(n.getBoundingSphere(s),t.autocenter?(n.getCenter(r.group.position),r.group.position.multiplyScalar(-1)):void 0===ATON.Nav.homePOV&&ATON.Nav.computeAndRequestDefaultHome(.5,void 0,s)):r.getBoundingSphere(s)&&(t.autocenter?(r.group.position.copy(s.center),r.group.position.multiplyScalar(-1)):void 0===ATON.Nav.homePOV&&ATON.Nav.computeAndRequestDefaultHome(.5,void 0,s));ATON.Utils._visitorCP(r.group)}),r.addEventListener("load-model",e=>{let o=e.scene;q._numTilesLoaded++,o.traverse(e=>{if(e.layers.enable(t.type),e.isMesh?(e.castShadow=!0,e.receiveShadow=!0,q._bTileBVH&&e.geometry&&(e.geometry.computeVertexNormals(),e.geometry.computeBoundsTree({}),ATON.Utils._bvhBounds>0&&ATON.Utils._addBVHbounds(e,ATON.Utils._bvhBounds)),ATON._bqScene=!0):(l=!0,q._bPCs=!0,e.layers.disable(t.type),e.raycast=ATON.Utils.VOID_CAST,e.material=ATON.MatHub.materials.point),t.userData.cMat&&(e.material=t.userData.cMat),e.material){let t=e.material.map;t&&(t.minFilter=THREE.LinearMipmapLinearFilter,t.magFilter=THREE.LinearFilter,t.colorSpace=ATON._stdEncoding)}}),ATON.fire("TileLoaded",o),ATON.Utils._visitorCP(o)}),r.addEventListener("dispose-model",(e,t)=>{ATON.Utils.cleanupVisitor(e.scene),e=null}),l||ATON.Utils.setPicking(t,t.type,!0),q._tsets.push(r)},loadCesiumIONAsset:(e,t)=>{let o=ATON.getAPIToken("cesium.ion");if(null==o&&(console.log("A valid Cesium ION token is required"),o=prompt("Please enter a valid Cesium ION token:"),null==o||""==o))return;let i=new URL(`https://api.cesium.com/v1/assets/${e}/endpoint`);i.searchParams.append("access_token",o),fetch(i,{mode:"cors"}).then(e=>e.ok?e.json():Promise.reject(`${e.status} : ${e.statusText}`)).then(e=>{i=new URL(e.url);const r=i.searchParams.get("v");q.loadTileSetFromURL(i.toString(),t,{accessToken:e.accessToken,v:r}),ATON.setAPIToken("cesium.ion",o)})},update:()=>{const e=q._tsets.length;if(e<1)return;for(let t=0;t<e;t++)q._tsets[t].update();if(q.detectMotion())return;let t=q._tsTasks.shift();void 0!==t&&(t(),t=null)},detectMotion:()=>!!ATON.Nav._bControl&&(ATON.Nav._dOri>q.THRES_ORI||ATON.Nav._dPos>q.THRES_POS)};const z=q;let G={DELIM_CSV:",",DELIM_TSV:"\t",init:()=>{},loadTextFromURL:(e,t)=>($.get(e,e=>{t&&t(e)}),G),loadValuesFromFile:(e,t,o,i)=>{let r={};void 0===o&&(o=-1),$.get(e,e=>{let a=e.split("\n"),n=a.length,s=[],l=!1;for(let e=0;e<n;e++){let i=a[e].trim();if(i.length>0)if(l){let a=i.split(t),n=o>=0?a[o]:e;n=n.trim(),r[n]={};for(let e=0;e<a.length;e++)e!==o&&(r[n][s[e]]=a[e].trim())}else{s=i.split(t),l=!0;for(let e in s)s[e]=s[e].trim()}}i&&i(r)})},loadCSV:(e,t,o)=>{G.loadValuesFromFile(e,G.DELIM_CSV,t,o)},loadTSV:(e,t,o)=>{G.loadValuesFromFile(e,G.DELIM_TSV,t,o)}};const X=G;let W={init:()=>{W._base=ATON.PATH_RESTAPI2},setBaseDomain:e=>e.startsWith("http")?(W._base=e,W):W,get:(e,t,o)=>(e.startsWith("http")||(e=W._base+e),fetch(e,{}).then(e=>{e.ok?e.json().then(t).catch(e=>{console.log("ERROR: "+e),o&&o(e)}):o&&o()}),W),post:(e,t,o,i)=>(e.startsWith("http")||(e=W._base+e),fetch(e,{method:"POST",body:JSON.stringify(t),credentials:"include",headers:{"Content-type":"application/json; charset=UTF-8"}}).then(e=>{e.ok?e.json().then(o).catch(e=>{console.log("ERROR: "+e),i&&i(e)}):i&&i()}),W),put:(e,t,o,i)=>(e.startsWith("http")||(e=W._base+e),fetch(e,{method:"PUT",body:JSON.stringify(t),credentials:"include",headers:{"Content-type":"application/json; charset=UTF-8"}}).then(e=>{e.ok?e.json().then(o).catch(e=>{console.log("ERROR: "+e),i&&i(e)}):i&&i()}),W),patch:(e,t,o,i)=>(e.startsWith("http")||(e=W._base+e),fetch(e,{method:"PATCH",body:JSON.stringify(t),credentials:"include",headers:{"Content-type":"application/json; charset=UTF-8"}}).then(e=>{e.ok?e.json().then(o).catch(e=>{console.log("ERROR: "+e),i&&i(e)}):i&&i()}),W),delete:(e,t,o)=>(e.startsWith("http")||(e=W._base+e),fetch(e,{method:"DELETE",credentials:"include"}).then(e=>{e.ok?e.json().then(t).catch(e=>{console.log("ERROR: "+e),o&&o(e)}):o&&o()}),W),login:(e,t,o,i)=>W.post("login",{username:e,password:t},e=>{e&&o?o(e):i&&i()},e=>{i&&i()}),logout:(e,t)=>W.get("logout",e,t)};const j=W;let Q={_3DGSR:void 0,MAX_PXRAD:512,MIN_PXRAD:1,MAX_STDDEV:2.8,realize:()=>{Q._3DGSR||(Q._3DGSR=new SPARK.SparkRenderer({renderer:ATON._renderer}),ATON._rootVisible.add(Q._3DGSR),(ATON.device.lowGPU||ATON.device.isMobile)&&(Q.MIN_PXRAD=2,Q.MAX_STDDEV=2),Q._3DGSR.clipXY=1.1,Q._3DGSR.focalAdjustment=2,Q._3DGSR.maxStdDev=Q.MAX_STDDEV,Q._3DGSR.maxPixelRadius=Q.MAX_PXRAD,Q._3DGSR.minPixelRadius=Q.MIN_PXRAD,ATON.setAdaptiveDensityRange(.1,.9),ATON.setDefaultPixelDensity(.9),Q.setupProfiler(),ATON.XR.setDensity(.5),ATON.on("XRmode",e=>{Q._3DGSR.maxStdDev=e?2:Q.MAX_STDDEV}))},isRealized:()=>!!Q._3DGSR,visitor:e=>{e&&(e.traverse(e=>{e.material&&(e.material.clippingPlanes=ATON._clipPlanes,e.material.clipIntersection=!1)}),e.disablePicking())},setupProfiler:()=>{ATON.on("RequestLowerRender",()=>{Q._3DGSR.minPixelRadius<32&&Q._3DGSR.minPixelRadius++,console.log("GS lower perf")}),ATON.on("RequestHigherRender",()=>{Q._3DGSR.minPixelRadius>Q.MIN_PXRAD&&Q._3DGSR.minPixelRadius--,console.log("GS higher perf")})}};const Y=Q;let K={};window.ATON=K,K.Node=t,K.POV=class{constructor(e){this.pos=new THREE.Vector3(1,0,0),this.target=new THREE.Vector3(0,0,0),this.up=ATON.STD_UPVECTOR,this.fov=void 0,this.nextPOV=void 0,this.prevPOV=void 0,this.as(e)}as(e){if(void 0!==e)return ATON.Nav.povlist[e]=this,this.id=e,this}setPosition(e,t,o){return e instanceof THREE.Vector3?this.pos.copy(e):this.pos.set(e,t,o),this}setTarget(e,t,o){return e instanceof THREE.Vector3?this.target.copy(e):this.target.set(e,t,o),this}setFOV(e){return this.fov=e,this}addKeywords(e){let t=e.split(",");void 0===this.kwords&&(this.kwords={});for(let e in t){let o=t[e].trim();o.length>0&&(this.kwords[o]=!0)}return this}hasKeyword(e){if(void 0!==this.kwords)return void 0!==this.kwords[e]}setNextPOV(e){if(e)return this.nextPOV=e,this}setPrevPOV(e){if(e)return this.prevPOV=e,this}},K.LightProbe=class{constructor(e,t,o){this.pos=new THREE.Vector3(0,0,0),this._res=void 0!==e?e:128,this._near=void 0!==t?t:1,this._far=void 0!==o?o:ATON.Nav.STD_FAR,this._envtex=void 0,this._CC=void 0,void 0===ATON._pmremGenerator&&(ATON._pmremGenerator=new THREE.PMREMGenerator(ATON._renderer),ATON._pmremGenerator.compileCubemapShader())}clear(){this._envtex&&this._envtex.dispose(),this._CCtarget&&this._CCtarget.dispose()}setPosition(e,t,o){return e instanceof THREE.Vector3?this.pos.copy(e):this.pos.set(e,t,o),this}setNear(e){return this._near=e,this}setFar(e){return this._far=e,this}_createCCtarget(){this._CCtarget||(this._CCtarget=new THREE.WebGLCubeRenderTarget(this._res,{format:THREE.RGBEFormat,generateMipmaps:!0,minFilter:THREE.LinearMipmapLinearFilter,colorSpace:ATON._stdEncoding}))}update(){return this._envtex&&this._envtex.dispose(),this._envtex=ATON._pmremGenerator.fromScene(ATON._mainRoot,0,this._near,this._far,{position:this.pos,size:this._res}).texture,ATON._renderer.shadowMap.enabled&&ATON._dMainL&&(ATON._dMainL.shadow.needsUpdate=!0),this}getEnvTex(){return this._envtex}assignToNode(e){}},K.XPF=class{constructor(e){this.id=e,this._geom=void 0,this._mesh=void 0,this._pathbaselayer=void 0,this._size=20,this._location=new THREE.Vector3(0,0,0),this._rotation=new THREE.Vector3(0,0,0),this._lnode=ATON.Nav.addLocomotionNode(this._location),this._pathMod=void 0,this._semMasksURLs={},this._semHintURL=void 0}setSize(e){this._size=e}realizeSUI(){return void 0===this._lnode||this._lnode.realizeSUI(),this}realizeGeometry(){return void 0!==this._geom||(this._geom=new THREE.SphereGeometry(1,60,60),this._geom.scale(-this._size,this._size,this._size),this._geom.castShadow=!1,this._geom.receiveShadow=!1,this._mat=new THREE.MeshBasicMaterial({depthTest:!1,depthWrite:!1}),this._mesh=new THREE.Mesh(this._geom,this._mat),this._mesh.frustumCulled=!1,this._mesh.renderOrder=-100),this}getMesh(){return this._mesh}getLocomotionNode(){return this._lnode}setRotation(e,t,o){return e instanceof THREE.Vector3?this._rotation.copy(e):this._rotation.set(e,t,o),void 0===this._mesh||this._mesh.rotation.copy(this._rotation),this}getRotation(){return this._rotation}setLocation(e,t,o){return e instanceof THREE.Vector3?this._location.copy(e):this._location.set(e,t,o),this._lnode&&this._lnode.setLocation(this._location),void 0===this._mesh||this._mesh.position.copy(this._location),this}getLocation(){return this._location}hasGeometry(){return void 0!==this._geom}setPathModifier=e=>(this._pathMod=e,this);updateBaseLayer(){}setBaseLayer(e){if(void 0===e)return this;this._pathbaselayer=ATON.Utils.resolveCollectionURL(e);let t=this;return this._pathMod&&(this._pathbaselayer=this._pathMod(this._pathbaselayer)),this.hasGeometry()?(ATON.Utils.isVideo(this._pathbaselayer)||ATON.Utils.textureLoader.load(t._pathbaselayer,e=>{e.colorSpace=ATON._stdEncoding,e.generateMipmaps=!0,t._mat.map=e,t._mat.map.needsUpdate=!0,t._mat.needsUpdate=!0,console.log("XPF base layer "+t._pathbaselayer+" loaded")}),this):this}setSemanticMask(e,t){return void 0===e||(this._semMasksURLs[e]=ATON.Utils.resolveCollectionURL(t),ATON.XPFNetwork.updateCurrentXPFsemLayer(this)),this}removeSemanticMask(e){return void 0===e||(this._semMasksURLs[e]=void 0,ATON.XPFNetwork.updateCurrentXPFsemLayer(this)),this}removeAllSemanticMasks(){return this._semMasksURLs={},this}getSemanticMaskURL(e){return this._semMasksURLs[e]}setSemanticHintMap(e){return void 0===e||(this._semHintURL=ATON.Utils.resolveCollectionURL(e),ATON.XPFNetwork.updateCurrentXPFsemLayer(this)),this}removeSemanticHintMap(){return this._semHintURL=void 0,ATON.XPFNetwork.updateCurrentXPFsemLayer(this),this}},K.Flare=class{constructor(e){this._id=void 0,this._bDeployed=!1,e&&this.register(e)}register(e){return e&&(this._id=e),ATON.addFlare(this),this}getID(){return this._id}log(e){return this._id?console.log("[Flare "+this._id+"] "+e):console.log("[Flare]"+e),this}setSetup(e){return this.setup=e,this}setUpdate(e){return this.update=e,this}},K.EventHub=i,K.Utils=s,K.CC=B,K.SceneHub=d,K.MatHub=a,K.Nav=h,K.AudioHub=u,K.XR=v,K.SUI=S,K.UI=A,K.Photon=P,K.SemFactory=E,K.FE=y,K.MediaFlow=M,K.Phygital=L,K.App=H,K.FX=I,K.XPFNetwork=U,K.MRes=z,K.ASCII=X,K.REQ=j,K.GS=Y,K.STD_UPVECTOR=new THREE.Vector3(0,1,0),K.ROOT_NID=".",K.RAD2DEG=180/Math.PI,K.DEG2RAD=Math.PI/180,K.PATCH_ADD=0,K.PATCH_DEL=1,K.NTYPES={},K.NTYPES.SCENE=3,K.NTYPES.SEM=4,K.NTYPES.UI=5,K.SHADOWS_NEAR=.1,K.SHADOWS_FAR=100,K.SHADOWS_SIZE=50,K.SHADOWS_RES=1024,K.AMB_L=.2,K.SCALE_DEFAULT=0,K.SCALE_BIG=5,K.SCALE_VERYBIG=10,K.SCALE_SMALL=-5,K.SCALE_VERYSMALL=-10,K.Flares={},K._fReqList=[],K._bInitialized=!1,K._b2D=!1,K._resMappers=[],K._clipPlanes=[],K._bSuspend=!1,K.setBaseURL=e=>{K.BASE_URL=e,K.PATH_RESTAPI=`${K.BASE_URL}/api/`,K.PATH_RESTAPI_SCENE=`${K.PATH_RESTAPI}scene/`,K.PATH_RESTAPI2=`${K.BASE_URL}/api/v2/`,K.PATH_WAPPS=`${K.BASE_URL}/a/`,K.PATH_FLARES=`${K.BASE_URL}/flares/`,K.PATH_DRACO_LIB=`${K.BASE_URL}/dist/draco/`,K.PATH_BASIS_LIB=`${K.BASE_URL}/dist/basis/`,K.PATH_COLLECTION=`${K.BASE_URL}/collections/`,K.PATH_SCENES=`${K.BASE_URL}/scenes/`,K.PATH_RES=`${K.BASE_URL}/res/`,K.PATH_FE=`${K.BASE_URL}/s/`},K.setBaseURL(window.location.origin),K.setPathCollection=e=>{K.PATH_COLLECTION=e},K.setPathScenes=e=>{K.PATH_SCENES=e},K.setAsStandalone=e=>{e||(e="../"),K.PATH_DRACO_LIB=e+"dist/draco/",K.PATH_BASIS_LIB=e+"dist/basis/",K.PATH_RES=e+"res/"},K.addResourceMapper=e=>{K._resMappers.push(e)},K._onUserInteraction=()=>{K._elPanoVideo&&!K._vpanoPlaying&&K._elPanoVideo.play(),K.XPFNetwork._elVid&&!K.XPFNetwork._vidPlaying&&K.XPFNetwork._elVid.play(),K.AudioHub._listener&&K.AudioHub._listener.context&&"suspended"===K.AudioHub._listener.context.state&&K.AudioHub._listener.context.resume();for(let e in K.MediaFlow._vStreams){let t=K.MediaFlow._vStreams[e].el;t.playing||t.uid||t.play()}},K.rewindAllPlayingMedia=()=>{K._elPanoVideo&&(K._elPanoVideo.currentTime=0),K.XPFNetwork._elVid&&(K.XPFNetwork.currentTime=0),K._auMain&&(K._auMain.stop(),K._auMain.play());for(let e in K.MediaFlow._vStreams){let t=K.MediaFlow._vStreams[e].el;t.playing&&!t.uid&&(t.stop(),t.play())}},K.checkAuth=(e,t)=>{K.REQ.get("user",o=>{o&&e?e(o):t&&t()},e=>{t&&t()})},K._setupBaseListeners=()=>{let e,t,o=K._renderer.domElement;window.addEventListener("resize",K._onResize,!1),window.onorientationchange=K._readDeviceOrientationMode,document.addEventListener("fullscreenchange",e=>{K._bFS=!!document.fullscreenElement,K.fire("Fullscreen",K._bFS),K._bFS?console.log("Now fullscreen"):console.log("Exit fullscreen")}),void 0!==document.hidden?(e="hidden",t="visibilitychange"):void 0!==document.mozHidden?(e="mozHidden",t="mozvisibilitychange"):void 0!==document.msHidden?(e="msHidden",t="msvisibilitychange"):void 0!==document.webkitHidden&&(e="webkitHidden",t="webkitvisibilitychange"),void 0!==e&&document.addEventListener(t,()=>{if(document[e]){if(K.XR._bPresenting)return;console.log("Suspend"),K.renderPause(),K._bSuspend=!0}else{if(K.XR._bPresenting)return;console.log("Resume"),K.renderResume(),K._bSuspend=!1}},!1),o.addEventListener("mousemove",K._updateScreenMove,!1),o.addEventListener("mousedown",e=>{1===e.button&&K.fire("MouseMidButton"),2===e.button&&K.fire("MouseRightButton")}),o.addEventListener("wheel",K._onMouseWheel,!1),K._bPointerDown=!1,Hammer(o).on("doubletap",e=>{K._bPointerDown=!1,K._onUserInteraction(),K.fire("DoubleTap",e.srcEvent)}),Hammer(o).on("tap",e=>{if(K._bPointerDown=!1,K._onUserInteraction(),K._updateScreenMove(e.srcEvent),K._handleQueries(),K.fire("Tap",e.srcEvent),void 0===K._hoveredUI)return;let t=K.getUINode(K._hoveredUI);t&&t.onSelect&&t.onSelect()}),K.on("DoubleTap",e=>{K.defaultDoubleTapFromScreenCoords(e)}),K._kModShift=!1,K._kModCtrl=!1,K._bListenKeyboardEvents=!0,window.addEventListener("keydown",e=>{K._onUserInteraction(),"Shift"===e.key&&(K._kModShift=!0),"Control"===e.key&&(K._kModCtrl=!0),K._bListenKeyboardEvents&&K.fire("KeyPress",e.key)},!1),window.addEventListener("keyup",e=>{"Shift"===e.key&&(K._kModShift=!1),"Control"===e.key&&(K._kModCtrl=!1),K._bListenKeyboardEvents&&K.fire("KeyUp",e.key)},!1),K.on("KeyPress",e=>{if("+"===e){let e=K.Nav.getFOV()+1;K.Nav.setFOV(e)}if("-"===e){let e=K.Nav.getFOV()-1;K.Nav.setFOV(e)}})},K._onResize=()=>{if(K.Nav._camera.aspect=window.innerWidth/window.innerHeight,K.Nav._camera.updateProjectionMatrix(),K._renderer.setSize(window.innerWidth,window.innerHeight),K.FX.composer&&(K.FX.composer.setSize(window.innerWidth,window.innerHeight),K.FX.passes[K.FX.PASS_AA])){let e=K.FX.passes[K.FX.PASS_AA].material.uniforms;e&&e.resolution.value.set(1/window.innerWidth,1/window.innerHeight)}K._anaR&&K._anaR.setSize(window.innerWidth,window.innerHeight)},K._onMouseWheel=e=>{e.preventDefault(),K.fire("MouseWheel",e.deltaY)},K.focusOn3DView=()=>{K._renderer.domElement.focus()},K._SUIactivation=()=>{const e=K.getUINode(K._hoveredUI);return void 0!==e&&void 0!==e.onSelect&&(e.onSelect(),!0)},K._stdActivation=()=>{if(K._SUIactivation())return;if(!K.Nav._bControl)return;if(void 0!==K.XPFNetwork._semCurr&&K.fire("SemanticMaskSelect",K.XPFNetwork._semCurr),K.XR._bPresenting){if(h.requestTransitionToLocomotionNodeInSightIfAny(K.XR.STD_TELEP_DURATION))return;return"immersive-vr"===K.XR._sessionType&&K.XR.teleportOnQueriedPoint(),void K.FE.playAudioFromSemanticNode(K._hoveredSemNode)}if(K.Nav.isFirstPerson()||K.Nav.isDevOri()){if(h.requestTransitionToLocomotionNodeInSightIfAny(.5))return;if(K.Nav.currentQueryValidForLocomotion()){let e=K._queryDataScene.p,t=K.Nav._vDir,o=new THREE.Vector3(e.x,e.y+K.userHeight,e.z),i=new THREE.Vector3(o.x+t.x,o.y+t.y,o.z+t.z),r=(new K.POV).setPosition(o).setTarget(i).setFOV(K.Nav._currPOV.fov);K.Nav.requestPOV(r,.5)}return}let e=K.getSemanticNode(K._hoveredSemNode);K._queryDataSem&&e?K.Nav.requestPOVbyNode(e,.5):K._queryDataScene&&K.Nav.requestRetarget(K._queryDataScene.p,void 0,.5)},K.defaultDoubleTapFromScreenCoords=e=>{K._updateScreenMove(e),K._handleQueryScene(),K._stdActivation()},K.isFullscreen=()=>K._bFS,K.toggleFullScreen=()=>{document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()},K.realize=e=>{console.log("Initialize ATON..."),K.Utils.init(),K.Utils.profileDevice(),K._clock=new THREE.Clock(!0),K.bounds=new THREE.Sphere,K._worldScale=1,K._ws=0,K._bFS=!1,K._renderer=new THREE.WebGLRenderer({antialias:!1,alpha:!0}),K._renderer.setSize(window.innerWidth,window.innerHeight),K.Utils.profileRenderingCapabilities(),K._stdpxd=1,K._fps=60,K._dt=.01,K._dtAccum=0,K._dtCount=0,K._avgFPSaccum=0,K._avgFPS=60,K._dRenderBudgetMinFPS=20,K._dRenderBudgetMaxFPS=55,K._bAdaptiveDensity=!0,K._adMin=.4,K._adMax=1.5,K.device.lowGPU&&(K._adMax=1),K._aniMixers=[],K._stdEncoding=THREE.LinearSRGBColorSpace,K._renderer.outputColorSpace=K._stdEncoding,K._renderer.toneMapping=THREE.LinearToneMapping,K._renderer.toneMappingExposure=1,e||K._renderer.setAnimationLoop(K._onFrame),K._maxAnisotropy=K._renderer.capabilities.getMaxAnisotropy(),K.userHeight=1.7,e||document.body.appendChild(K._renderer.domElement);let t=K._renderer.domElement;t.id="idView3D",t.style.outline="none",t.style.border="none",K.UI.init(),K.REQ.init(),K._vpanoPlaying=!1,K._bUserInts=0,K.EventHub.init(),K.MatHub.init(),K.ASCII.init(),K._assetsManager={},K._aLoader=new THREE.GLTFLoader,K._numReqLoad=0,K._collMod=void 0,K._ktx2Loader=new THREE.KTX2Loader,K._ktx2Loader.setTranscoderPath(K.PATH_BASIS_LIB),K._ktx2Loader.detectSupport(K._renderer),K._dracoLoader=new THREE.DRACOLoader,K._dracoLoader.setDecoderPath(K.PATH_DRACO_LIB),K._dracoLoader.setWorkerLimit(2),K._dracoLoader.preload(),K._aLoader.setDRACOLoader(K._dracoLoader),K._aLoader.setKTX2Loader(K._ktx2Loader),THREE.DefaultLoadingManager.addHandler(/\.ktx2$/,K._ktx2Loader),K._updRoutines=[],K._pmremGenerator=void 0,K._lps=[],K._bAutoLP=!1,K._envMapInt=1,K._numLPbounces=1,K._lpbCount=0,K._bShadowsFixedBound=!1,K._shadowsFixedBoundCenter=void 0,K._shadowsNear=K.SHADOWS_NEAR,K._shadowsFar=K.SHADOWS_FAR,K._shadowsSize=K.SHADOWS_SIZE,K._shadowsRes=K.SHADOWS_RES,K.initGraphs(),K.SceneHub.init(),K.MRes.init(),K.CC.init(),K.AudioHub.init(),K.Nav.init(),K.XR.init(),K.SUI.init(),K.Photon.init(),K.VRoadcast=K.Photon,K.MediaFlow.init(),K.SemFactory.init(),K.Phygital.init(),K.XPFNetwork.init(),K.device.lowGPU||K.device.isMobile||K.FX.init(),K.FX.composer||(K._render=()=>{K._renderer.render(K._mainRoot,K.Nav._camera)}),K.setDefaultPixelDensity(1),K._queryDataScene=void 0,K._queryDataSem=void 0,K._queryDataUI=void 0,K._hoveredSemNode=void 0,K._hoveredUI=void 0,K._bq=!0,K._bQuerySemOcclusion=!0,K._bQueryNormals=!0,K._bPauseQuery=!1,K._bCenteredQuery=!1,K._bqScene=!1,K._bqSem=!1,K._bqSceneCont=!0,K._qSync=0,K._qSyncInt=1,K._tgiDur=void 0,K._tgiPer=void 0,K._tHover=void 0,K._bMainPanoInfinite=!0,K._matMainPano=void 0,K._mMainPano=void 0,K._screenPointerCoords=new THREE.Vector2(0,0),K._rcScene=new THREE.Raycaster,K._rcScene.layers.set(K.NTYPES.SCENE),K._rcScene.firstHitOnly=!0,K._rcSemantics=new THREE.Raycaster,K._rcSemantics.layers.set(K.NTYPES.SEM),K._rcSemantics.firstHitOnly=!0,K._rcUI=new THREE.Raycaster,K._rcUI.layers.set(K.NTYPES.UI),K._rcUI.firstHitOnly=!0,K._setupBaseListeners(),K.device.isMobile&&K._readDeviceOrientationMode(),K._fLoading=0,K._fRequired=K._fReqList.length,K._loadFlares(),K._gizmo=void 0,K._bGizmo=!1,K.focusOn3DView(),K._bInitialized=!0},K.realize2D=()=>{K._b2D=!0,K.UI.init(),K.REQ.init(),document.body.classList.add("aton-body2D"),document.body.oncontextmenu=null,K.EventHub.init(),K._bInitialized=!0},K.addFlare=e=>{if(void 0===e)return;let t=Object.keys(K.Flares).length,o=e.getID();o?K.Flares[o]=e:K.Flares["F"+t]=e},K.registerFlare=K.addFlare,K.getFlare=e=>K.Flares[e],K.loadScript=(e,t,o)=>{let i=document.createElement("script");i.src=e,i.async=!1,document.head.appendChild(i),t&&(i.onload=t),o&&(i.onerror=o)},K._loadFlare=e=>{K._fLoading++,$.get(K.PATH_RESTAPI2+"flares/"+e,t=>{let o=t.files;if(o){let t=o.length;for(let i in o)K.loadScript(K.PATH_FLARES+e+"/"+o[i],()=>{t--,t<=0&&K._onFlareLoaded(e)},()=>{console.log("Missing flare '"+e+"' dependency: "+o[i]),t--,t<=0&&K._onFlareLoaded(e)})}}).fail(()=>{console.log("Flare "+e+" not found."),K._onFlareError(e)})},K._loadFlares=()=>{if(K._fRequired<=0)K.fire("AllFlaresReady");else for(let e in K._fReqList)K._loadFlare(K._fReqList[e])},K._onFlareLoaded=e=>{console.log("All deps loaded for flare '"+e+"'"),K._deployNewFlares(),K._fLoading--,K._fLoading<=0&&K._onAllFlaresLoaded()},K._onFlareError=e=>{K._fLoading--,K._fLoading<=0&&K._onAllFlaresLoaded()},K._onAllFlaresLoaded=()=>{console.log("All Flares ready!"),K.fire("AllFlaresReady")},K._deployFlare=e=>{e._bDeployed||(void 0!==e.setup&&e.setup(),void 0!==e.update&&K.addUpdateRoutine(e.update),e._bDeployed=!0)},K._deployNewFlares=()=>{for(let e in K.Flares)K._deployFlare(K.Flares[e])},K.setCollectionPathModifier=e=>{K._collMod=e},K.setTimedGazeDuration=e=>{K._tgiDur=e},K.getTimedGazeProgress=()=>{if(void 0!==K._tgiDur)return K._tgiPer},K.getElapsedTime=()=>K._clock.elapsedTime,K.renderPause=()=>{K._renderer.setAnimationLoop(void 0)},K.renderResume=()=>{K._renderer.setAnimationLoop(K._onFrame)},K._setupLoadManager=()=>{K._loadManager=new THREE.LoadingManager,K._loadManager.onStart=(e,t,o)=>{console.log("Started loading file: "+e+".\nLoaded "+t+" of "+o+" files."),K.fire("NodeRequestFired",e)},K._loadManager.onLoad=()=>{console.log("Loading complete!"),K.fire("AllNodeRequestsCompleted")},K._loadManager.onProgress=(e,t,o)=>{},K._loadManager.onError=e=>{console.log("There was an error loading "+e)}},K.setDefaultPixelDensity=e=>{K._stdpxd=e,K._renderer.setPixelRatio(e),K.FX.composer&&K.FX.composer.setPixelRatio(e),K.XR.setDensity(e)},K.resetPixelDensity=()=>{K._renderer.setPixelRatio(K._stdpxd)},K._readDeviceOrientationMode=()=>{90===Math.abs(window.orientation)?(console.log("Landscape Mode"),K.fire("MobileLandscapeMode")):(console.log("Portrait Mode"),K.fire("MobilePortraitMode")),setTimeout(K._onResize,500)},K.snodes={},K.semnodes={},K.uinodes={},K.createSceneNode=e=>new K.Node(e,K.NTYPES.SCENE),K.getSceneNode=e=>{if(void 0!==e)return K.snodes[e]},K.getOrCreateSceneNode=e=>{let t=K.getSceneNode(e);return void 0!==t?t:K.createSceneNode(e)},K.getRootScene=()=>K._rootVisible,K.createSemanticNode=e=>new K.Node(e,K.NTYPES.SEM),K.getSemanticNode=e=>{if(void 0!==e)return K.semnodes[e]},K.getOrCreateSemanticNode=e=>{let t=K.getSemanticNode(e);return void 0!==t?t:K.createSemanticNode(e)},K.getRootSemantics=()=>K._rootSem,K.createUINode=e=>new K.Node(e,K.NTYPES.UI),K.getUINode=e=>{if(void 0!==e)return K.uinodes[e]},K.getRootUI=()=>K._rootUI,K._unpackScale=e=>0==e?1:e>=0?1.1*e:1/(-1.1*e),K.setUserScaleLevel=e=>{K.setWorldScaleLevel(-e)},K.getUserScale=()=>1/K._worldScale,K.setWorldScaleLevel=e=>{void 0===e&&(e=0),e<-127&&(e=127),e>127&&(e=127),K._ws=e;let t=K._unpackScale(e);K._rootVisible.scale.set(t,t,t),K._rootSem.scale.set(t,t,t),S.gLocNodes.scale.set(t,t,t),S.gMeasures.scale.set(t,t,t),K.Photon.avaGroup&&K.Photon.avaGroup.scale.set(t,t,t),K.recomputeSceneBounds();let o=t/K._worldScale;K.Nav._currPOV.pos.x*=o,K.Nav._currPOV.pos.y*=o,K.Nav._currPOV.pos.z*=o,K.Nav._currPOV.target.x*=o,K.Nav._currPOV.target.y*=o,K.Nav._currPOV.target.z*=o,K.Nav.syncCurrCamera(),K.XR._bPresenting&&K.XR.setRefSpaceLocation(K.Nav._currPOV.pos),K._worldScale=t,console.log("World scale: "+t)},K.getWorldScaleLevel=()=>K._ws,K.getWorldScale=()=>K._worldScale,K._assetReqNew=e=>{K._numReqLoad++,K.fire("NodeRequestFired",e)},K._assetReqComplete=e=>{K.fire("NodeRequestCompleted",e),K._numReqLoad--,K._numReqLoad<=0&&K._onAllReqsCompleted()},K._onAllReqsCompleted=()=>{K.recomputeSceneBounds(),K.getRootScene().assignLightProbesByProximity(),K.fire("AllNodeRequestsCompleted"),K._postAllReqsCompleted(),K.updateLightProbes(),K._renderer.shadowMap.enabled&&K._bShadowsFixedBound&&0===K._aniMixers.length&&(K._dMainL.shadow.autoUpdate=!1,console.log("Lazy shadows"))},K._postAllReqsCompleted=e=>{void 0===e&&(e=K._rootVisible);for(let t in e.children){let o=e.children[t];o&&o.toggle&&(K._postAllReqsCompleted(o),o.toggle(o.visible))}ThreeMeshUI.update()},K.recomputeSceneBounds=e=>{e?K.bounds.union(e):(K.bounds.center.copy(K._rootVisible.getBound().center),K.bounds.radius=K._rootVisible.getBound().radius),K.bounds.radius<=0||(K._renderer.shadowMap.enabled&&(K._rootVisible.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),K.adjustShadowsParamsFromSceneBounds(),K._bShadowsFixedBound&&K.updateDirShadows()),K._bAutoLP&&(void 0===K._lps[0]?K.addLightProbe((new K.LightProbe).setPosition(K.bounds.center).setNear(K.bounds.radius)):K._lps[0].setPosition(K.bounds.center).setNear(K.bounds.radius),console.log("Auto LP")),K.FX.composer&&K.FX.setDOFaperture(1/(30*K.bounds.radius)),K._mMainPano&&K._mMainPano.position.copy(K.bounds.center))},K.registerNodeResourceHandler=(e,t)=>{K._resHandler||(K._resHandler={}),K._resHandler[e]=t,console.log("Registered resource handler '"+e+"'")},K.removeNodeResourceHanlder=e=>{K._resHandler&&K._resHandler[e]&&(K._resHandler[e]=void 0)},K.initGraphs=()=>{K._mainRoot=new THREE.Scene,K._mainRoot.background=new THREE.Color(.7,.7,.7),K._rootVisibleGlobal=new THREE.Scene,K._mainRoot.add(K._rootVisibleGlobal),K._rootVisible=K.createSceneNode().setAsRoot(),K._rootVisibleGlobal.add(K._rootVisible),K._rootSem=K.createSemanticNode().setAsRoot(),K._mainRoot.add(K._rootSem),K._rootUI=K.createUINode().setAsRoot(),K._mainRoot.add(K._rootUI),K.ambLight=new THREE.AmbientLight(K.MatHub.colors.white),K.ambLight.intensity=3,K._rootVisibleGlobal.add(K.ambLight),K.plight=new THREE.PointLight,K.plight.intensity=0,K.plight.decay=.2,K._rootVisibleGlobal.add(K.plight)},K.enablePointLight=()=>{K.plight.intensity=3},K.disablePointLight=()=>{K.plight.intensity=0},K.setBackgroundColor=e=>{K._mainRoot.background=e},K.setFog=(e,t)=>{void 0!==e&&(void 0===t&&(t=200),K._rootVisibleGlobal.fog=new THREE.Fog(e,1,t),K.setBackgroundColor(e))},K.disableFog=()=>{K._rootVisibleGlobal.fog=null},K.setAutoLP=e=>{K._bAutoLP=e},K.setNeutralAmbientLight=e=>{K.ambLight.color=new THREE.Color(e,e,e)},K.addLightProbe=e=>{void 0!==e&&(K._lps.push(e),K.setNeutralAmbientLight(0),void 0!==K.SUI.gLPIcons&&S.addLPIcon(e))},K.getNumLightProbes=()=>K._lps.length,K.clearLightProbes=()=>{for(let e in K._lps)K._lps[e]&&(K._lps[e].clear(),delete K._lps[e]);K._lps=[],K.setNeutralAmbientLight(1),K._rootVisible.traverse(e=>{let t=e.userData.LP;t&&t instanceof K.LightProbe&&(e.material.envMap=null,e.material.envMapIntensity=null,e.material.needsUpdate=!0)})},K._updLP=()=>{for(let e in K._lps)K._lps[e].update();K._rootVisible.traverse(e=>{let t=e.userData.LP;void 0!==t&&t instanceof K.LightProbe&&(e.material.envMap=t.getEnvTex(),e.material.envMapIntensity=K._envMapInt,e.material.needsUpdate=!0)})},K.setLightProbesNumBounces=e=>{e<1||(K._numLPbounces=e)},K.dirtyLightProbes=e=>{void 0===e&&(e=K._numLPbounces),K._lpbCount=e},K.updateLightProbes=()=>{if(0!==K._lps.length){for(let e=0;e<K._numLPbounces;e++)K._updLP();console.log("LPs updated.")}},K.setMainPanorama=e=>{let t;if(e=K.Utils.resolveCollectionURL(e),void 0===K._mMainPano&&(K._gMainPano=new THREE.SphereGeometry(1,60,60),K._gMainPano.castShadow=!1,K._gMainPano.receiveShadow=!1,K._mMainPano=new THREE.Mesh(K._gMainPano,K._matMainPano),K._mMainPano.frustumCulled=!1,K._mMainPano.renderOrder=-100,K._mMainPano.layers.disable(K.NTYPES.SCENE),K._mMainPano.layers.disable(K.NTYPES.SEM),K._mMainPano.layers.disable(K.NTYPES.UI),K._mMainPano.raycast=K.Utils.VOID_CAST,K.setMainPanoramaRadius(.8*K.Nav.STD_FAR)),K.Utils.isVideo(e)){if(void 0===K._elPanoVideo){let t="<video id='idPanoVideo' loop crossOrigin='anonymous' playsinline style='display:none'>";e.endsWith("mp4")&&(t+="<source src='"+e+"' type='video/mp4'>"),e.endsWith("webm")&&(t+="<source src='"+e+"' type='video/webm'>"),t+="</video>",$(t).appendTo("body"),K._elPanoVideo=document.getElementById("idPanoVideo"),K._elPanoVideo.onplaying=()=>{console.log("VideoPano playing"),K._vpanoPlaying=!0},K._elPanoVideo.onpause=()=>{console.log("VideoPano paused"),K._vpanoPlaying=!1},K._elPanoVideo.addEventListener("touchstart",function(){K._elPanoVideo.play()})}t=new THREE.VideoTexture(K._elPanoVideo),t.colorSpace=K._stdEncoding,K._realizeOrUpdateMainPano(t),K.fire("MainPanoVideo")}else{if(e.endsWith(".hdr"))return void(new THREE.RGBELoader).load(e,e=>{e.minFilter=THREE.LinearMipmapLinearFilter,e.magFilter=THREE.LinearFilter,e.colorSpace=K._stdEncoding,K._realizeOrUpdateMainPano(e),K.fire("MainPanoHDR")});if(e.endsWith(".exr"))return void(new THREE.EXRLoader).load(e,e=>{e.minFilter=THREE.LinearMipmapLinearFilter,e.magFilter=THREE.LinearFilter,e.colorSpace=K._stdEncoding,K._realizeOrUpdateMainPano(e),K.fire("MainPanoHDR")});K.Utils.textureLoader.load(e,e=>{e.colorSpace=K._stdEncoding,e.generateMipmaps=!0,K._realizeOrUpdateMainPano(e),K.fire("MainPano")})}},K.playMainPanorama=()=>{K._elPanoVideo&&(K._vpanoPlaying||K._elPanoVideo.play())},K.pauseMainPanorama=()=>{K._elPanoVideo&&K._vpanoPlaying&&K._elPanoVideo.pause()},K.playOrPauseMainPanorama=()=>{K._elPanoVideo&&(K._vpanoPlaying?K._elPanoVideo.pause():K._elPanoVideo.play())},K.stopAndRemoveMainPanorama=()=>{K._elPanoVideo&&(K._vpanoPlaying&&K._elPanoVideo.pause(),K._elPanoVideo.remove(),K._elPanoVideo=void 0,K._vpanoPlaying=!1)},K._realizeOrUpdateMainPano=e=>{if(void 0!==K._matMainPano)return K._matMainPano.map=e,void K.updateLightProbes();K._matMainPano=new THREE.MeshBasicMaterial({map:e,depthTest:!1,depthWrite:!1}),K._mMainPano.material=K._matMainPano,K._bMainPanoInfinite&&(K._mMainPano.onAfterRender=()=>{"immersive-ar"!==K.XR._sessionType&&K.Nav._currPOV&&K._mMainPano.position.copy(K.Nav._currPOV.pos)}),K._rootVisibleGlobal.add(K._mMainPano),K.updateLightProbes()},K.setMainPanoramaRadius=e=>{void 0!==K._gMainPano&&K._gMainPano.scale(-e,e,e)},K.setMainPanoramaRotation=e=>{void 0!==K._mMainPano&&K._mMainPano.rotation.set(0,e,0)},K.setMainPanoramaInfinite=e=>{K._bMainPanoInfinite=e,void 0!==K._mMainPano&&(K._mMainPano.onAfterRender=e?()=>{K.Nav._currPOV&&K._mMainPano.position.copy(K.Nav._currPOV.pos)}:void 0)},K.setMainPanoramaLocation=e=>{K._bMainPanoInfinite||void 0!==K._mMainPano&&K._mMainPano.position.copy(e)},K.setMainLightDirection=e=>{let t=e.clone();t.normalize(),t.x*=.5*K.SHADOWS_FAR,t.y*=.5*K.SHADOWS_FAR,t.z*=.5*K.SHADOWS_FAR,void 0===K._dMainL&&(K._dMainL=new THREE.DirectionalLight(new THREE.Color(1,1,1),1),K._dMainL.castShadow=!1,K._dMainL.intensity=2,K._dMainLtgt=new THREE.Object3D,K._rootVisibleGlobal.add(K._dMainLtgt),K._dMainL.target=K._dMainLtgt,K._rootVisibleGlobal.add(K._dMainL),K._dMainLpos=new THREE.Vector3),K._dMainLdir=t,K._dMainL.position.set(-t.x,-t.y,-t.z),K._renderer.shadowMap.enabled&&(K._dMainL.shadow.needsUpdate=!0),K.toggleMainLight(!0)},K.getMainLightDirection=()=>{if(void 0===K._dMainLdir)return;let e=K._dMainLdir.clone();return e.normalize(),e},K.toggleMainLight=e=>{if(void 0===K._dMainL)return;K._dMainL.visible=e;let t=K._lps.length;e?(t>0?K.setNeutralAmbientLight(0):K.setNeutralAmbientLight(K.AMB_L),K.updateDirShadows()):t>0?K.setNeutralAmbientLight(0):K.setNeutralAmbientLight(K.AMB_L)},K.isMainLightEnabled=()=>void 0!==K._dMainL&&!!K._dMainL.visible,K.setExposure=e=>{K._renderer.toneMappingExposure=e},K.getExposure=()=>K._renderer.toneMappingExposure,K.adjustShadowsParamsFromSceneBounds=()=>{if(void 0===K._dMainL)return;let e=K._rootVisible.getBound().radius,t=K._rootVisible.getBound().center;e<=0||e>=K.SHADOWS_SIZE?(K._bShadowsFixedBound=!1,K._shadowsSize=K.SHADOWS_SIZE):(K._bShadowsFixedBound=!0,K._shadowsFixedBoundCenter=t,K._shadowsSize=1.5*e),K._dMainL.shadow.map&&(K._dMainL.shadow.map.dispose(),K._dMainL.shadow.map=null),K._dMainL.shadow.camera.left=-K._shadowsSize,K._dMainL.shadow.camera.right=K._shadowsSize,K._dMainL.shadow.camera.bottom=-K._shadowsSize,K._dMainL.shadow.camera.top=K._shadowsSize,K._dMainL.shadow.mapSize.width=K._shadowsRes,K._dMainL.shadow.mapSize.height=K._shadowsRes,K._dMainL.shadow.camera.near=K._shadowsNear,K._dMainL.shadow.camera.far=K._shadowsFar;let o=-2e-4*e;o<-.001&&(o=-.001),K._dMainL.shadow.bias=o},K.toggleShadows=e=>{if(void 0!==K._dMainL)if(e){if(K.XR.isPresenting())return;if(K.device.lowGPU)return;K._dMainL.castShadow=!0,K._renderer.shadowMap.enabled=!0,K.device.isMobile?K._renderer.shadowMap.type=THREE.PCFShadowMap:K._renderer.shadowMap.type=THREE.PCFSoftShadowMap,K._rootVisible.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),K.adjustShadowsParamsFromSceneBounds(),K.updateDirShadows(),K._dMainL.shadow.needsUpdate=!0,console.log("Shadows ON")}else K._dMainL.castShadow=!1,K._renderer.shadowMap.enabled=!1,console.log("Shadows OFF")},K.updateDirShadows=()=>{if(void 0===K._dMainLdir)return;if(void 0===K._dMainLpos)return;let e=K._shadowsFixedBoundCenter;void 0===e?(e=K.Nav.getCurrentEyeLocation(),K._dMainLpos.x=e.x+K.Nav._vDir.x*K._shadowsSize,K._dMainLpos.y=e.y+K.Nav._vDir.y*K._shadowsSize,K._dMainLpos.z=e.z+K.Nav._vDir.z*K._shadowsSize):(K._dMainLpos.x=e.x,K._dMainLpos.y=e.y,K._dMainLpos.z=e.z),K._dMainL.position.set(K._dMainLpos.x-K._dMainLdir.x,K._dMainLpos.y-K._dMainLdir.y,K._dMainLpos.z-K._dMainLdir.z),K._dMainLtgt.position.copy(K._dMainLpos)},K._updateEnvironment=()=>{K._renderer.shadowMap.enabled&&(K._bShadowsFixedBound||K.updateDirShadows())},K.setGlobalAudio=(e,t)=>{void 0!==e&&(void 0===t&&(t=!0),e=K.Utils.resolveCollectionURL(e),void 0===K._auMain||null===K._auMain?K._auMain=new THREE.Audio(K.AudioHub._listener):K._auMain.isPlaying&&K._auMain.stop(),K.AudioHub._loader.load(e,e=>{K._auMain.setBuffer(e),K._auMain.setLoop(t),K._auMain.play()}))},K._markFPS=()=>{K._numReqLoad>0||K._dt<0||(K._dtCount+=1,K._dtAccum+=K._dt,K._dtAccum<1||(K._fps=1/(K._dtAccum/K._dtCount),K._dtCount=0,K._dtAccum=0,K._handleDynamicRenderProfiles()))},K.toggleAdaptiveDensity=e=>{K._bAdaptiveDensity=e},K.setAdaptiveDensityRange=(e,t)=>{e>=t||(K._adMin=e,K._adMax=t)},K.setDynamicRenderingFPS=(e,t)=>{e>=t||(e&&(K._dRenderBudgetMinFPS=e),t&&(K._dRenderBudgetMaxFPS=t))},K._handleDynamicRenderProfiles=()=>{let e=K._renderer.getPixelRatio();K._fps<K._dRenderBudgetMinFPS&&(K._bAdaptiveDensity&&!K.XR._bPresenting&&(e-=.1,e>=K._adMin&&(K._renderer.setPixelRatio(e),K.FX.composer&&K.FX.composer.setPixelRatio(e),console.log("Density: "+e.toPrecision(2)))),K.fire("RequestLowerRender")),K._fps>K._dRenderBudgetMaxFPS&&(K._bAdaptiveDensity&&!K.XR._bPresenting&&(e+=.1,e<=K._adMax&&(K._renderer.setPixelRatio(e),K.FX.composer&&K.FX.composer.setPixelRatio(e),console.log("Density: "+e.toPrecision(2)))),K.fire("RequestHigherRender"))},K._onFrame=()=>{K._dt=K._clock.getDelta(),K._markFPS(),K.XR._bPresenting?K.XR.update():K.Nav._controls.update(K._dt),K._handleQueries(),K.Nav.update(),K.Photon.update(),K.SUI.update(),K.MatHub.update(),K._updateEnvironment(),K._updateAniMixers(),K._updateRoutines(),K.MRes.update(),K.XPFNetwork.update(),K._render()},K._render=()=>{!K.FX.composer||K.XR._bPresenting?K._renderer.render(K._mainRoot,K.Nav._camera):K.FX.composer.render()},K.addUpdateRoutine=e=>{void 0!==e&&K._updRoutines.push(e)},K.deleteAllUpdateRoutines=()=>{K._updRoutines=[]},K._updateRoutines=()=>{let e=K._updRoutines.length;if(!(e<=0))for(let t=0;t<e;t++)K._updRoutines[t]()},K._updateAniMixers=()=>{let e=K._aniMixers.length;if(!(e<1))for(let t=0;t<e;t++)K._aniMixers[t].update(K._dt)},K._updateScreenMove=e=>{e.preventDefault&&e.preventDefault(),K._bCenteredQuery||(K._screenPointerCoords.x=e.clientX/window.innerWidth*2-1,K._screenPointerCoords.y=-e.clientY/window.innerHeight*2+1)},K.toggleCenteredQuery=e=>{K._bCenteredQuery=e,e&&(K._screenPointerCoords.x=0,K._screenPointerCoords.y=0)},K.toggleQueries=e=>{K._bq=e},K._registerRCS=()=>{K._rcRR=0,K._rcHandlers=[],K._rcHandlers.push(K._handleQueryScene),K._rcHandlers.push(K._handleQuerySemantics),K._rcHandlers.push(K._handleQueryUI)},K._handleQueries=()=>{if(!K._bq)return;if(K._bPauseQuery)return;if(K.Nav._bInteracting)return;if(K._numReqLoad>0)return;if(K.Nav.isTransitioning())return;if(K._handleQueryUI(),K._bqScene&&K._handleQueryScene(),K._bqSem&&K._handleQuerySemantics(),K.Nav._bLocValidator&&K.Nav.locomotionValidator(),void 0===K._tgiDur)return;if(void 0===K._tHover)return;const e=K._clock.elapsedTime-K._tHover;e>=K._tgiDur?(K._stdActivation(),K._tHover=void 0,K._tgiPer=void 0):K._tgiPer=e/K._tgiDur},K._handleQueryScene=()=>{if(K.XR.isPresenting()?K.XR.setupQueryRay(K._rcScene):K._rcScene.setFromCamera(K._screenPointerCoords,K.Nav._camera),K._hitsScene=[],K._rcScene.intersectObjects(K._mainRoot.children,!0,K._hitsScene),K._hitsScene.length<=0)return void(K._queryDataScene=void 0);const e=K._hitsScene[0];K._queryDataScene={},K._queryDataScene.p=e.point,K._queryDataScene.d=e.distance,K._queryDataScene.o=e.object,K._queryDataScene.uv=e.uv,K._bQueryNormals&&e.face&&e.face.normal&&(K._queryDataScene.matrixWorld=(new THREE.Matrix3).getNormalMatrix(e.object.matrixWorld),K._queryDataScene.n=e.face.normal.clone().applyMatrix3(K._queryDataScene.matrixWorld).normalize())},K.getSceneFocalPoint=()=>{if(void 0===K._queryDataScene)return;let e=K._queryDataScene.p,t=new THREE.Vector3;return t.lerpVectors(e,K.Nav._currPOV.pos,.02),t},K.getSceneQueriedPoint=()=>{if(void 0!==K._queryDataScene)return K._queryDataScene.p},K.getSceneQueriedDistance=()=>{if(void 0!==K._queryDataScene)return K._queryDataScene.d},K.getSceneQueriedNormal=()=>{if(void 0!==K._queryDataScene)return K._queryDataScene.n},K.getSceneQueriedObjectName=()=>{if(void 0!==K._queryDataScene&&void 0!==K._queryDataScene.o)return K._queryDataScene.o.name},K.getSceneQueriedUV=()=>{if(void 0!==K._queryDataScene)return K._queryDataScene.uv},K.setQueryRange=(e,t,o)=>{void 0!==o&&o!==K.NTYPES.SCENE||(K._rcScene.near=e,K._rcScene.far=t),void 0!==o&&o!==K.NTYPES.SEM||(K._rcSemantics.near=e,K._rcSemantics.far=t)},K._handleQuerySemantics=()=>{if(K.XR.isPresenting()?K.XR.setupQueryRay(K._rcSemantics):K._rcSemantics.setFromCamera(K._screenPointerCoords,K.Nav._camera),K._hitsSem=[],K._rcSemantics.intersectObjects(K._mainRoot.children,!0,K._hitsSem),K._hitsSem.length<=0){if(K._queryDataSem=void 0,K._hoveredSemNode){K.fire("SemanticNodeLeave",K._hoveredSemNode);let e=K.getSemanticNode(K._hoveredSemNode);e&&e.onLeave&&e.onLeave()}return K._hoveredSemNode=void 0,void(K._tHover=void 0)}const e=K._hitsSem[0];if(K._bQuerySemOcclusion&&K._queryDataScene&&K._queryDataScene.d<e.distance){if(K._queryDataSem=void 0,K._hoveredSemNode){K.fire("SemanticNodeLeave",K._hoveredSemNode);let e=K.getSemanticNode(K._hoveredSemNode);e&&e.onLeave&&e.onLeave()}return K._hoveredSemNode=void 0,void(K._tHover=void 0)}K._queryDataSem={},K._queryDataSem.p=e.point,K._queryDataSem.d=e.distance,K._queryDataSem.o=e.object,K._queryDataSem.list=[];const t=K._queryDataSem.list;let o=e.object.parent;for(;o;)o.nid&&o.nid!==K.ROOT_NID&&t.push(o.nid),o=o.parent;const i=t[0];if(i&&K._hoveredSemNode!==i){if(K._hoveredSemNode){K.fire("SemanticNodeLeave",K._hoveredSemNode);let e=K.getSemanticNode(K._hoveredSemNode);e&&e.onLeave&&e.onLeave(),K._tHover=void 0}K._hoveredSemNode=i,K.fire("SemanticNodeHover",i);let e=K.getSemanticNode(i);e&&e.onHover&&e.onHover(),K._tHover=K._clock.elapsedTime}},K._handleQueryUI=()=>{if(K.XR.isPresenting()?K.XR.setupQueryRay(K._rcUI):K._rcUI.setFromCamera(K._screenPointerCoords,K.Nav._camera),K._hitsUI=[],K._rcUI.intersectObjects(K._mainRoot.children,!0,K._hitsUI),K._hitsUI.length<=0){if(K._queryDataUI=void 0,K._hoveredUI){K.fire("UINodeLeave",K._hoveredUI);const e=K.getUINode(K._hoveredUI);e&&e.onLeave&&e.onLeave()}return K._hoveredUI=void 0,void(K._tHover=void 0)}const e=K._hitsUI[0];if(K._queryDataScene&&K._queryDataScene.d<e.distance){if(K._queryDataUI=void 0,K._hoveredUI){K.fire("UINodeLeave",K._hoveredUI);const e=K.getUINode(K._hoveredUI);e&&e.onLeave&&e.onLeave()}return K._hoveredUI=void 0,void(K._tHover=void 0)}K._queryDataUI={},K._queryDataUI.p=e.point,K._queryDataUI.d=e.distance,K._queryDataUI.o=e.object,K._queryDataUI.list=[];const t=K._queryDataUI.list;let o=e.object.parent;for(;o;)o.nid&&o.nid!==K.ROOT_NID&&t.push(o.nid),o=o.parent;const i=t[0];if(i&&K._hoveredUI!==i){if(K._hoveredUI){K.fire("UINodeLeave",K._hoveredUI);const e=K.getUINode(K._hoveredUI);e&&e.onLeave&&e.onLeave(),K._tHover=void 0}K._hoveredUI=i,K.fire("UINodeHover",i);const e=K.getUINode(i);e&&e.onHover&&e.onHover(),K._tHover=K._clock.elapsedTime}},K.getHoveredSemanticNode=()=>{if(void 0!==K._hoveredSemNode)return K.getSemanticNode(K._hoveredSemNode)},K.setAPIToken=(e,t)=>{window.sessionStorage.setItem("ATON.tokens."+e,t)},K.getAPIToken=e=>window.sessionStorage.getItem("ATON.tokens."+e),K.clearToken=e=>{window.sessionStorage.removeItem("ATON.tokens."+e)},K.enableClipPlanes=()=>{K._renderer&&(K._renderer.localClippingEnabled=!0)},K.disableClipPlanes=()=>{K._renderer&&(K._renderer.localClippingEnabled=!1,K._clipPlanes=[])},K.addClipPlane=(e,t)=>{K.enableClipPlanes();let o=new THREE.Plane;return o.setFromNormalAndCoplanarPoint(e,t),K._clipPlanes.push(o),K.Utils._visitorCP(),o},K.enableAnaglyphRendering=()=>{K._anaR=new THREE.AnaglyphEffect(K._renderer),K._anaR.setSize(window.innerWidth,window.innerHeight),K._render=()=>{K._anaR.render(K._mainRoot,K.Nav._camera)}},K.useGizmo=e=>{K._bGizmo=e,K._setupGizmo()},K._setupGizmo=()=>{}})();